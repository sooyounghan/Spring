-----
### í”„ë¡ì‹œ íŒ©í† ë¦¬ ì ìš©
-----
1. ë¨¼ì € ì¸í„°íŽ˜ì´ìŠ¤ê°€ ìžˆëŠ” v1 ì• í”Œë¦¬ì¼€ì´ì…˜ì— LogTrace ê¸°ëŠ¥ì„ í”„ë¡ì‹œ íŒ©í† ë¦¬ë¥¼ í†µí•´ í”„ë¡ì‹œë¡œ ë§Œë“¤ì–´ ì ìš©
2. LogTraceAdvice
```java
package hello.proxy.config.v3_proxyfactory.advice;


import hello.proxy.trace.TraceStatus;
import hello.proxy.trace.logtrace.LogTrace;
import org.aopalliance.intercept.MethodInterceptor;
import org.aopalliance.intercept.MethodInvocation;

import java.lang.reflect.Method;

public class LogTraceAdvice implements MethodInterceptor {
    private LogTrace logTrace;

    public LogTraceAdvice(LogTrace logTrace) {
        this.logTrace = logTrace;
    }

    @Override
    public Object invoke(MethodInvocation invocation) throws Throwable {
        TraceStatus status = null;

        try {
            Method method = invocation.getMethod();

            String message = method.getDeclaringClass().getSimpleName() + "." + method.getName() + "()";
            status = logTrace.begin(message);

            // ë¡œì§ í˜¸ì¶œ
            Object result = invocation.proceed();

            logTrace.end(status);

            return result;
        } catch (Exception e) {
            logTrace.exception(status, e);
            throw e;
        }
    }
}
```

3. ProxyFactoryConfigV1
```java
package hello.proxy.config.v3_proxyfactory;

import hello.proxy.app.v1.*;
import hello.proxy.config.v3_proxyfactory.advice.LogTraceAdvice;
import hello.proxy.trace.logtrace.LogTrace;
import lombok.extern.slf4j.Slf4j;
import org.springframework.aop.Advisor;
import org.springframework.aop.framework.ProxyFactory;
import org.springframework.aop.support.DefaultPointcutAdvisor;
import org.springframework.aop.support.NameMatchMethodPointcut;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Slf4j
@Configuration
public class ProxyFactoryConfigV1 {
    @Bean
    public OrderControllerV1 orderControllerV1(LogTrace logTrace) {
        OrderControllerV1 orderController = new OrderControllerV1Impl(orderServiceV1(logTrace));
        ProxyFactory proxyFactory = new ProxyFactory(orderController);
        proxyFactory.addAdvisor(getAdvisor(logTrace));

        OrderControllerV1 proxy = (OrderControllerV1) proxyFactory.getProxy();
        log.info("ProxyFactory proxy = {}, target = {}", proxy.getClass(), orderController.getClass());

        return proxy;
    }

    @Bean
    public OrderServiceV1 orderServiceV1(LogTrace logTrace) {
        OrderServiceV1 orderService = new OrderServiceV1Impl(orderRepositoryV1(logTrace));
        ProxyFactory proxyFactory = new ProxyFactory(orderService);
        proxyFactory.addAdvisor(getAdvisor(logTrace));

        OrderServiceV1 proxy = (OrderServiceV1) proxyFactory.getProxy();
        log.info("ProxyFactory proxy = {}, target = {}", proxy.getClass(), orderService.getClass());

        return proxy;
    }

    @Bean
    public OrderRepositoryV1 orderRepositoryV1(LogTrace logTrace) {
        OrderRepositoryV1 orderRepository = new OrderRepositoryV1Impl();
        ProxyFactory proxyFactory = new ProxyFactory(orderRepository);
        proxyFactory.addAdvisor(getAdvisor(logTrace));

        OrderRepositoryV1 proxy = (OrderRepositoryV1) proxyFactory.getProxy();
        log.info("ProxyFactory proxy = {}, target = {}", proxy.getClass(), orderRepository.getClass());

        return proxy;
    }

    private Advisor getAdvisor(LogTrace logTrace) {
        // Pointcut
        NameMatchMethodPointcut pointcut = new NameMatchMethodPointcut();
        pointcut.setMappedNames("request*", "order*", "save*");

        // Advice
        LogTraceAdvice advice = new LogTraceAdvice(logTrace);

        return new DefaultPointcutAdvisor(pointcut, advice);
    }
}
```
  - í¬ì¸íŠ¸ì»·ì€ NameMatchMethodPointcut ì‚¬ìš©
    + ì‹¬í”Œ ë§¤ì¹­ ê¸°ëŠ¥ì´ ìžˆì–´ì„œ *ë¥¼ ë§¤ì¹­í•  ìˆ˜ ìžˆìŒ
    + request*, order*, save* : requestë¡œ ì‹œìž‘í•˜ëŠ” ë©”ì„œë“œì— í¬ì¸íŠ¸ì»·ì€ true ë°˜í™˜ (ë‚˜ë¨¸ì§€ë„ ë™ì¼)
    + ì´ëŠ” noLog() ë©”ì„œë“œì—ëŠ” ì–´ë“œë°”ì´ìŠ¤ë¥¼ ì ìš©í•˜ì§€ ì•Šê¸° ìœ„í•¨

  - ì–´ë“œë°”ì´ì €ëŠ” í¬ì¸íŠ¸ì»·(NameMatchMethodPointcut), ì–´ë“œë°”ì´ìŠ¤(LogTraceAdvice)ë¥¼ ê°€ì§
  - í”„ë¡ì‹œ íŒ©í† ë¦¬ì— ê° targetê³¼ advisorë¥¼ ë“±ë¡í•´ì„œ í”„ë¡ì‹œ ìƒì„±í–ˆìœ¼ë©°, ìƒì„±ëœ í”„ë¡ì‹œë¥¼ ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡

4. ProxyApplication
```java
package hello.proxy;

import hello.proxy.config.AppV1Config;
import hello.proxy.config.AppV2Config;
import hello.proxy.config.v1_proxy.ConcreteProxyConfig;
import hello.proxy.config.v1_proxy.InterfaceProxyConfig;
import hello.proxy.config.v2_dynamicproxy.DynamicProxyBasicConfig;
import hello.proxy.config.v2_dynamicproxy.DynamicProxyFilterConfig;
import hello.proxy.config.v3_proxyfactory.ProxyFactoryConfigV1;
import hello.proxy.trace.logtrace.LogTrace;
import hello.proxy.trace.logtrace.ThreadLocalLogTrace;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;

// @Import(AppV1Config.class)
// @Import({AppV1Config.class, AppV2Config.class})
// @Import(InterfaceProxyConfig.class)
// @Import(ConcreteProxyConfig.class)
// @Import(DynamicProxyBasicConfig.class)
// @Import(DynamicProxyFilterConfig.class)
@Import(ProxyFactoryConfigV1.class)
@SpringBootApplication(scanBasePackages = "hello.proxy.app.v3") //ì£¼ì˜
public class ProxyApplication {

	public static void main(String[] args) {
		SpringApplication.run(ProxyApplication.class, args);
	}

	@Bean
	public LogTrace logTrace() {
		return new ThreadLocalLogTrace();
	}
}
```
  - ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ë¡œê·¸
```
ProxyFactory proxy = class jdk.proxy2.$Proxy55, target = class hello.proxy.app.v1.OrderRepositoryV1Impl
ProxyFactory proxy = class jdk.proxy2.$Proxy57, target = class hello.proxy.app.v1.OrderServiceV1Impl
ProxyFactory proxy = class jdk.proxy2.$Proxy58, target = class hello.proxy.app.v1.OrderControllerV1Impl
```
  - V1 ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì¸í„°íŽ˜ì´ìŠ¤ê°€ ìžˆìœ¼ë¯€ë¡œ í”„ë¡ì‹œ íŒ©í† ë¦¬ê°€ JDK ë™ì  í”„ë¡ì‹œ ì ìš©
  - ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ë¡œê·¸ë¥¼ í†µí•´ í™•ì¸ ê°€ëŠ¥
  
  - ì‹¤í–‰ ë¡œê·¸
```
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [1bf3897b] OrderControllerV1.request()
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [1bf3897b] |-->OrderServiceV1.orderItem()
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [1bf3897b] |   |-->OrderRepositoryV1.save()
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [1bf3897b] |   |<--OrderRepositoryV1.save() time = 1009ms
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [1bf3897b] |<--OrderServiceV1.orderItem() time = 1009ms
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [1bf3897b] OrderControllerV1.request() time = 1010ms
```

5. ì¸í„°íŽ˜ì´ìŠ¤ê°€ ì—†ê³ , êµ¬ì²´ í´ëž˜ìŠ¤ë§Œ ìžˆëŠ” v2 ì• í”Œë¦¬ì¼€ì´ì…˜ì— LogTrace ê¸°ëŠ¥ì„ í”„ë¡ì‹œ íŒ©í† ë¦¬ë¥¼ í†µí•´ í”„ë¡ì‹œë¥¼ ë§Œë“¤ì–´ ì ìš©
  - ProxyFactoryConfigV2
```java
package hello.proxy.config.v3_proxyfactory;

import hello.proxy.app.v2.OrderControllerV2;
import hello.proxy.app.v2.OrderRepositoryV2;
import hello.proxy.app.v2.OrderServiceV2;
import hello.proxy.config.v3_proxyfactory.advice.LogTraceAdvice;
import hello.proxy.trace.logtrace.LogTrace;
import lombok.extern.slf4j.Slf4j;
import org.springframework.aop.Advisor;
import org.springframework.aop.framework.ProxyFactory;
import org.springframework.aop.support.DefaultPointcutAdvisor;
import org.springframework.aop.support.NameMatchMethodPointcut;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Slf4j
@Configuration
public class ProxyFactoryConfigV2 {
    @Bean
    public OrderControllerV2 orderControllerV2(LogTrace logTrace) {
        OrderControllerV2 orderController = new OrderControllerV2(orderServiceV2(logTrace));
        ProxyFactory proxyFactory = new ProxyFactory(orderController);
        proxyFactory.addAdvisor(getAdvisor(logTrace));

        OrderControllerV2 proxy = (OrderControllerV2) proxyFactory.getProxy();
        log.info("ProxyFactory proxy = {}, target = {}", proxy.getClass(), orderController.getClass());

        return proxy;
    }

    @Bean
    public OrderServiceV2 orderServiceV2(LogTrace logTrace) {
        OrderServiceV2 orderService = new OrderServiceV2(orderRepositoryV2(logTrace));
        ProxyFactory proxyFactory = new ProxyFactory(orderService);
        proxyFactory.addAdvisor(getAdvisor(logTrace));

        OrderServiceV2 proxy = (OrderServiceV2) proxyFactory.getProxy();
        log.info("ProxyFactory proxy = {}, target = {}", proxy.getClass(), orderService.getClass());

        return proxy;
    }

    @Bean
    public OrderRepositoryV2 orderRepositoryV2(LogTrace logTrace) {
        OrderRepositoryV2 orderRepository = new OrderRepositoryV2();
        ProxyFactory proxyFactory = new ProxyFactory(orderRepository);
        proxyFactory.addAdvisor(getAdvisor(logTrace));

        OrderRepositoryV2 proxy = (OrderRepositoryV2) proxyFactory.getProxy();
        log.info("ProxyFactory proxy = {}, target = {}", proxy.getClass(), orderRepository.getClass());

        return proxy;
    }

    private Advisor getAdvisor(LogTrace logTrace) {
        // Pointcut
        NameMatchMethodPointcut pointcut = new NameMatchMethodPointcut();
        pointcut.setMappedNames("request*", "order*", "save*");

        // Advice
        LogTraceAdvice advice = new LogTraceAdvice(logTrace);

        return new DefaultPointcutAdvisor(pointcut, advice);
    }
}
```
  - ProxyApplication
```java
package hello.proxy;

import hello.proxy.config.AppV1Config;
import hello.proxy.config.AppV2Config;
import hello.proxy.config.v1_proxy.ConcreteProxyConfig;
import hello.proxy.config.v1_proxy.InterfaceProxyConfig;
import hello.proxy.config.v2_dynamicproxy.DynamicProxyBasicConfig;
import hello.proxy.config.v2_dynamicproxy.DynamicProxyFilterConfig;
import hello.proxy.config.v3_proxyfactory.ProxyFactoryConfigV1;
import hello.proxy.config.v3_proxyfactory.ProxyFactoryConfigV2;
import hello.proxy.trace.logtrace.LogTrace;
import hello.proxy.trace.logtrace.ThreadLocalLogTrace;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;

// @Import(AppV1Config.class)
// @Import({AppV1Config.class, AppV2Config.class})
// @Import(InterfaceProxyConfig.class)
// @Import(ConcreteProxyConfig.class)
// @Import(DynamicProxyBasicConfig.class)
// @Import(DynamicProxyFilterConfig.class)
// @Import(ProxyFactoryConfigV1.class)
@Import(ProxyFactoryConfigV2.class)
@SpringBootApplication(scanBasePackages = "hello.proxy.app.v3") //ì£¼ì˜
public class ProxyApplication {

	public static void main(String[] args) {
		SpringApplication.run(ProxyApplication.class, args);
	}

	@Bean
	public LogTrace logTrace() {
		return new ThreadLocalLogTrace();
	}
}
```
  - í”„ë¡ì‹œ íŒ©í† ë¦¬ë¥¼ í†µí•œ ProxyFactroyConfigV2 ì„¤ì • ë“±ë¡

  - ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ë¡œê·¸
```
ProxyFactory proxy = class hello.proxy.app.v2.OrderRepositoryV2$$SpringCGLIB$$0, target = class hello.proxy.app.v2.OrderRepositoryV2
ProxyFactory proxy = class hello.proxy.app.v2.OrderServiceV2$$SpringCGLIB$$0, target = class hello.proxy.app.v2.OrderServiceV2
ProxyFactory proxy = class hello.proxy.app.v2.OrderControllerV2$$SpringCGLIB$$0, target = class hello.proxy.app.v2.OrderControllerV2
```
  - V2 ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ì¸í„°íŽ˜ì´ìŠ¤ê°€ ì—†ê³  êµ¬ì²´ í´ëž˜ìŠ¤ë§Œ ìžˆìœ¼ë¯€ë¡œ í”„ë¡ì‹œ íŒ©í† ë¦¬ê°€ CGLIBë¥¼ ì ìš©
  - ì‹¤í–‰ ë¡œê·¸
```
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2218483] OrderControllerV2.request()
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2218483] |-->OrderServiceV2.orderItem()
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2218483] |   |-->OrderRepositoryV2.save()
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2218483] |   |<--OrderRepositoryV2.save() time = 1004ms
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2218483] |<--OrderServiceV2.orderItem() time = 1004ms
[advanced] [nio-9090-exec-1] h.p.trace.logtrace.ThreadLocalLogTrace   : [a2218483] OrderControllerV2.request() time = 1005ms
```

-----
### ì •ë¦¬
-----
1. í”„ë¡ì‹œ íŒ©í† ë¦¬ ë•ë¶„ì— ë§¤ìš° íŽ¸ë¦¬í•˜ê²Œ í”„ë¡ì‹œ ìƒì„± ê°€ëŠ¥
2. ðŸ’¡ ì¶”ê°€ë¡œ, ì–´ë“œë°”ì´ì €, ì–´ë“œë°”ì´ìŠ¤, í¬ì¸íŠ¸ì»· ì´ë¼ëŠ” ê°œë…ìœ¼ë¡œ ì–´ë–¤ ë¶€ê°€ ê¸°ëŠ¥ì„ ì–»ì— ì ìš©í•  ì§€ ëª…í™•í•˜ê²Œ ì´í•´ ê°€ëŠ¥
3. ë‚¨ì€ ë¬¸ì œ
   - í”„ë¡ì‹œ íŒ©í† ë¦¬ì™€ ì–´ë“œë°”ì´ì € ê°™ì€ ê°œë…ìœ¼ë¡œ ë¬¸ì œëŠ” í•´ê²°
   - ë¬¸ì œ 1 : ë„ˆë¬´ ë§Žì€ ì„¤ì •
     + ProxyFactoryConfigV1, ProxyFactoryConfigV2ì™€ ê°™ì€ ì„¤ì • íŒŒì¼ì´ ì§€ë‚˜ì¹˜ê²Œ ë§ŽìŒ
     + ì˜ˆë¥¼ ë“¤ì–´, ì• í”Œë¦¬ì¼€ì´ì…˜ì— ìŠ¤í”„ë§ ë¹ˆì´ 100ê°œ ìžˆë‹¤ë©´ ì—¬ê¸°ì— í”„ë¡ì‹œë¥¼ í†µí•´ ë¶€ê°€ ê¸°ëŠ¥ ì ìš©í•˜ë ¤ë©´ 100ê°œì˜ ë™ì  í”„ë¡ì‹œ ì½”ë“œë¥¼ ë§Œë“¤ì–´ì•¼ í•¨
     + ìµœê·¼ì—ëŠ” ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì„ í†µí•´ ìŠ¤í”„ë§ ë¹ˆì„ ë“±ë¡í•˜ì§€ë§Œ, í”„ë¡ì‹œë¥¼ ì ìš©í•˜ëŠ” ì½”ë“œê¹Œì§€ ë¹ˆ ìƒì„± ì½”ë“œì— ë„£ì–´ì¤˜ì•¼ í•¨

   - ë¬¸ì œ 2 : ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”
     + ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° í”„ë¡ì‹œ ì ìš© ë¶ˆê°€ëŠ¥
     + ì‹¤ì œ ê°ì²´ë¥¼ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº”ìœ¼ë¡œ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡ ë‹¤ í•´ë²„ë¦° ìƒíƒœì´ê¸° ë•Œë¬¸ìž„
     + í”„ë¡ì‹œë¥¼ ì ìšœí•˜ë ¤ë©´, ì‹¤ì œ ê°ì²´ë¥¼ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ë¶€ê°€ ê¸°ëŠ¥ì´ ìžˆëŠ” í”„ë¡ì‹œë¥¼ ê°ì²´ ëŒ€ì‹  ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì•¼ í•¨

4. ì´ ë‘ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ëŠ” ê²ƒì´ ë¹ˆ í›„ì²˜ë¦¬ê¸°
