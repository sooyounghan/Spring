-----
### í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´ ì ìš©
-----
1. AbstractTemplate
```java
package hello.advanced.trace.template;

import hello.advanced.trace.TraceStatus;
import hello.advanced.trace.logtrace.LogTrace;

public abstract class AbstractTemplate<T> {
    private final LogTrace trace;

    public AbstractTemplate(LogTrace trace) {
        this.trace = trace;
    }

    public T execute(String message) {
        TraceStatus status = null;

        try {
            status = trace.begin(message);

            // ë¡œì§ í˜¸ì¶œ
            T result = call();

            trace.end(status);
            return result;
        } catch (Exception e) {
            trace.exception(status, e);
            throw e;
        }
    }

    protected abstract T call();
}
```
  - AbstractTemplateì€ í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´ì—ì„œ ë¶€ëª¨ í´ë˜ìŠ¤ì´ê³ , í…œí”Œë¦¿ ì—­í• 
  - ğŸ’¡ ```<T>``` ì œë„¤ë¦­ ì‚¬ìš© : ë°˜í™˜ íƒ€ì… ì •ì˜
  - ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•  LogTrace traceë¥¼ ì „ë‹¬ ë°›ìŒ
  - ë¡œê·¸ë¥¼ ì¶œë ¥í•  messageë¥¼ ì™¸ë¶€ì—ì„œ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë°›ìŒ
  - í…œí”Œë¦¿ ì½”ë“œ ì¤‘ê°„ì— call() ë©”ì„œë“œë¥¼ í†µí•´ ë³€í•˜ëŠ” ë¶€ë¶„ ì²˜ë¦¬
  - ğŸ’¡ abstract T call()ì€ ë³€í•˜ëŠ” ë¶€ë¶„ì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì„œë“œë¡œ, ìƒì†ìœ¼ë¡œ êµ¬í˜„í•´ì•¼ í•¨

2. v3 â†’ v4 ë³µì‚¬
  - ë³µì‚¬
    + v3.OrderControllerV3 â†’ v4.OrderControllerV4 
    + v3.OrderServiceV3 â†’ v4.OrderServiceV4
    + v3.OrderRepositoryV3 â†’ v4.OrderRepositoryV4

  - ì½”ë“œ ë‚´ë¶€ ì˜ì¡´ê´€ê³„ë¥¼ í´ë˜ìŠ¤ë¥¼ V4ìœ¼ë¡œ ë³€ê²½
    + OrderControllerV4 : OrderServiceV3 â†’ OrderServiceV4 
    + OrderServiceV4 : OrderRepositoryV3 â†’ OrderRepositoryV4

  - OrderControllerV4 ë§¤í•‘ ì •ë³´ ë³€ê²½
    + @GetMapping("/v4/request") 

  - AbstractTemplate ì„ ì‚¬ìš©í•˜ë„ë¡ ì½”ë“œ ë³€ê²½

3. OrderControllerV4
```java
package hello.advanced.app.v4;

import hello.advanced.trace.TraceStatus;
import hello.advanced.trace.logtrace.LogTrace;
import hello.advanced.trace.template.AbstractTemplate;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequiredArgsConstructor
public class OrderControllerV4 {
    private final OrderServiceV4 orderService;
    private final LogTrace trace;

    @GetMapping("/v4/request")
    public String request(String itemId) {

        AbstractTemplate<String> template = new AbstractTemplate<>(trace) {
            @Override
            protected String call() {
                orderService.orderItem(itemId);
                return "OK";
            }
        };
        return template.execute("OrderController.request()");
    }
}
```
  - ğŸ’¡ ```AbstactTemplate<String>``` : ì œë„¤ë¦­ì„ Stringìœ¼ë¡œ ì„¤ì •í•¨. ë”°ë¼ì„œ, AbstractTemplateì˜ ë°˜í™˜ íƒ€ì…ì€ String
  - ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ ì‚¬ìš© : ê°ì²´ë¥¼ ìƒì„±í•˜ë©´ì„œ AbstractTemplateë¥¼ ìƒì†ë°›ì€ ìì‹ í´ë˜ìŠ¤ë¥¼ ì •ì˜í–ˆìœ¼ë¯€ë¡œ, ë³„ë„ì˜ ìì‹ í´ë˜ìŠ¤ë¥¼ ì§ì ‘ ë§Œë“¤ì§€ ì•Šì•„ë„ ë¨
  - template.execute("OrderController.request()") : í…œí”Œë¦¿ì„ ì‹¤í–‰í•˜ë©´ì„œ ë¡œê·¸ë¥¼ ë‚¨ê¸¸ message ì „ë‹¬

4. OrderServiceV4
```java
package hello.advanced.app.v4;

import hello.advanced.trace.TraceStatus;
import hello.advanced.trace.logtrace.LogTrace;
import hello.advanced.trace.template.AbstractTemplate;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class OrderServiceV4 {
    private final OrderRepositoryV4 orderRepository;
    private final LogTrace trace;

    public void orderItem(String itemId) {
        AbstractTemplate<Void> template = new AbstractTemplate<>(trace) {
            @Override
            protected Void call() {
                orderRepository.save(itemId);
                return null;
            }
        };

        template.execute("OrderService.orderItem()");
    }
}
```
  - ğŸ’¡ ```Abstract<Void>``` : ì œë„¤ë¦­ì—ì„œ ë°˜í™˜ íƒ€ì…ì´ í•„ìš”í•œë°, ë°˜í™˜í•  ë‚´ìš©ì´ ì—†ìœ¼ë©´ Void íƒ€ì… ì‚¬ìš©í•˜ê³ , nullì„ ë°˜í™˜
  - ğŸ’¡ ì°¸ê³ ë¡œ ì œë„¤ë¦­ì€ ê¸°ë³¸ íƒ€ì…ì¸ void, int ë“± ì„ ì–¸ ë¶ˆê°€

5. OrderRepositoryV4
```java
package hello.advanced.app.v4;

import hello.advanced.trace.TraceStatus;
import hello.advanced.trace.logtrace.LogTrace;
import hello.advanced.trace.template.AbstractTemplate;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

@Repository
@RequiredArgsConstructor
public class OrderRepositoryV4 {
    private final LogTrace trace;

    public void save(String itemId) {

        AbstractTemplate<Void> template = new AbstractTemplate<>(trace) {
            @Override
            protected Void call() {
                // ì €ì¥ ë¡œì§
                if (itemId.equals("ex")) {
                    throw new IllegalStateException("ì˜ˆì™¸ ë°œìƒ");
                }
                sleep(1000);

                return null;
            }
        };
        template.execute("OrderRepository.save()");
    }
    
    private void sleep(int millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

6. ì •ìƒ ì‹¤í–‰ ë¡œê·¸
```
[advanced] [nio-9090-exec-1] h.a.trace.logtrace.ThreadLocalLogTrace   : [8552f701] OrderController.request()
[advanced] [nio-9090-exec-1] h.a.trace.logtrace.ThreadLocalLogTrace   : [8552f701] |-->OrderService.orderItem()
[advanced] [nio-9090-exec-1] h.a.trace.logtrace.ThreadLocalLogTrace   : [8552f701] |   |-->OrderRepository.save()
[advanced] [nio-9090-exec-1] h.a.trace.logtrace.ThreadLocalLogTrace   : [8552f701] |   |<--OrderRepository.save() time = 1012ms
[advanced] [nio-9090-exec-1] h.a.trace.logtrace.ThreadLocalLogTrace   : [8552f701] |<--OrderService.orderItem() time = 1013ms
[advanced] [nio-9090-exec-1] h.a.trace.logtrace.ThreadLocalLogTrace   : [8552f701] OrderController.request() time = 1015ms
```

7. í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´ ë•ë¶„ì— ë³€í•˜ëŠ” ì½”ë“œì™€ ë³€í•˜ì§€ ì•ŠëŠ” ì½”ë“œë¥¼ ëª…í™•í•˜ê²Œ ë¶„ë¦¬
8. ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ëŠ” í…œí”Œë¦¿ ì—­í•­ì„ í•˜ëŠ” ë³€í•˜ì§€ ì•ŠëŠ” ì½”ë“œëŠ” ëª¨ë‘ AbstractTemplateì— ë‹´ì•„ë‘ê³ , ë³€í•˜ëŠ” ì½”ë“œëŠ” ìì‹ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ ë¶„ë¦¬
```java
// OrderServiceV0 ì½”ë“œ
public void orderItem(String itemId) { 
    orderRepository.save(itemId); // í•µì‹¬ ê¸°ëŠ¥
}

// OrderServiceV3 ì½”ë“œ
public void orderItem(String itemId) { 
    TraceStatus status = null;
    try {
          status = trace.begin("OrderService.orderItem()"); 
          orderRepository.save(itemId); // í•µì‹¬ ê¸°ëŠ¥
          trace.end(status);
    } catch (Exception e) { 
          trace.exception(status, e);
          throw e;
    } 
}

// OrderServiceV4 ì½”ë“œ
public void orderItem(String itemId) { 
    AbstractTemplate<Void> template = new AbstractTemplate<>(trace) { 
          @Override
          protected Void call() {
                orderRepository.save(itemId); // í•µì‹¬ ê¸°ëŠ¥
                return null;
          } 
    };

    template.execute("OrderService.orderItem()");
}
```
  - OrderServiceV0 : í•µì‹¬ ê¸°ëŠ¥ë§Œ ì¡´ì¬
  - OrderServiceV3 : í•µì‹¬ ê¸°ëŠ¥ê³¼ ë¶€ê°€ ê¸°ëŠ¥ì´ í•¨ê»˜ ì„ì—¬ ìˆìŒ
  - OrderServiceV4 : í•µì‹¬ ê¸°ëŠ¥ê³¼ í…œí”Œë¦¿(ë¶€ê°€ ê¸°ëŠ¥ì€ í…œí”Œë¦¿ ì•ˆì— ì¡´ì¬)ì„ í˜¸ì¶œí•˜ëŠ” ì½”ë“œê°€ ì„ì—¬ ìˆìŒ
  - V4ëŠ” í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´ ë•ë¶„ì— í•µì‹¬ ê¸°ëŠ¥ì— ì§‘ì¤‘ ê°€ëŠ¥

9. ì¢‹ì€ ì„¤ê³„
  - ë³€ê²½ì´ ì¼ì–´ë‚  ë•Œ ìì—°ìŠ¤ëŸ½ê²Œ ë“œëŸ¬ë‚˜ëŠ”ë°, ì§€ê¸ˆê¹Œì§€ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ë¶€ë¶„ì„ ëª¨ì•„ì„œ í•˜ë‚˜ë¡œ ëª¨ë“ˆí™”í•˜ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¶€ë¶„ì„ ë¶„ë¦¬
  - ë§Œì•½, ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ë¡œì§ì„ ë³€ê²½í•´ì•¼ í•œë‹¤ê³  ìƒê°í•˜ë©´, AbstractTemplate ì½”ë“œë¥¼ ë³€ê²½í•´ì•¼ í•œë‹¤ê³  í•œë‹¤ë©´, ë‹¨ìˆœíˆ ì´ ë¶€ë¶„ì˜ ì½”ë“œë§Œ ë³€ê²½í•˜ë©´ ë¨
    + í…œí”Œë¦¿ì´ ì—†ëŠ” V3 ìƒíƒœì—ì„œëŠ” ëª¨ë“  í´ë˜ìŠ¤ë¥¼ ë‹¤ ì°¾ì•„ì„œ ê³ ì³ì•¼ í•¨

10. ë‹¨ì¼ ì±…ì„ ì›ì¹™ (SRP)
  - V4ëŠ” í…œí”Œë¦¿ ë©”ì„œë“œë¥¼ ì ìš©í•´ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ë¶€ë¶„ì— ëŒ€í•´ ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP)ì„ ì§€í‚¨ ê²ƒ
  - ì¦‰, ë³€ê²½ ì§€ì ì„ í•˜ë‚˜ë¡œ ëª¨ì•„ì„œ ì‰½ê²Œ ë³€ê²½ì— ëŒ€ì²˜í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ë§Œë“  ê²ƒ
