-----
### ëŸ°íƒ€ì„ ì˜ˆì™¸ ì ìš©
-----
1. MemberRepository
```java
package hello.jdbc.repository;

import hello.jdbc.domain.Member;

public interface MemberRepository {
    Member save(Member member);
    Member findById(String memberId);
    void update(String memberId, int money);
    void delete(String memberId);
}
```

2. MyDbException ëŸ°íƒ€ì„ ì˜ˆì™¸
```java
package hello.jdbc.repository.ex;

public class MyDbException extends RuntimeException{
    public MyDbException() {
    }

    public MyDbException(String message) {
        super(message);
    }

    public MyDbException(String message, Throwable cause) {
        super(message, cause);
    }

    public MyDbException(Throwable cause) {
        super(cause);
    }
}
```
  - RuntimeExceptionì„ ìƒì† ë°›ìŒ
  - ë”°ë¼ì„œ, MyDbExceptionì€ ëŸ°íƒ€ì„(Unchecked) ì˜ˆì™¸ê°€ ë¨

3. MemberRepositoryV4_1
```java
package hello.jdbc.repository;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.ex.MyDbException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.datasource.DataSourceUtils;
import org.springframework.jdbc.support.JdbcUtils;

import javax.sql.DataSource;
import java.sql.*;
import java.util.NoSuchElementException;

/**
 * ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°
 * Checked ì˜ˆì™¸ë¥¼ Runtime ì˜ˆì™¸ë¡œ ë³€ê²½
 * MemberRepository ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©
 *  - throws SQLException ì œê±°
 */

@Slf4j
public class MemberRepositoryV4_1 implements MemberRepository {
    private final DataSource dataSource;

    public MemberRepositoryV4_1(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    @Override
    public Member save(Member member) {
        String sql = "INSERT INTO member(member_id, money) VALUES(?, ?)"; // SQL Query

        Connection conn = null; // Connection ê°ì²´
        PreparedStatement pstmt = null; // SQL ì¿¼ë¦¬ ê°ì²´

        try {
            conn = getConnection(); // Connection ê°ì²´ ì–»ê¸°
            pstmt = conn.prepareStatement(sql); // SQL ì¿¼ë¦¬ ë‹´ê¸°
            pstmt.setString(1, member.getMemberId()); // ? ê°’ ëŒ€ì…
            pstmt.setInt(2, member.getMoney()); // ? ê°’ ëŒ€ì…
            pstmt.executeUpdate();
            return member; // ë°˜í™˜
        } catch (SQLException e) {
            log.error("DB Error", e); // ì˜ˆì™¸ì— ëŒ€í•œ ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
            throw new MyDbException(e);
        } finally {
            close(conn, pstmt, null); // ìì› ë°˜í™˜
        }
    }

    @Override
    public Member findById(String memberId) {
        String sql = "SELECT * FROM MEMBER WHERE member_id = ?";

        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, memberId);

            rs = pstmt.executeQuery();

            if(rs.next()) {
                Member member = new Member();
                member.setMemberId(rs.getString("member_id"));
                member.setMoney(rs.getInt("money"));
                return member;
            } else {
                throw new NoSuchElementException("Member Not Fount MemberId = " + memberId);
            }
        } catch(SQLException e) {
            log.error("Error", e);
            throw new MyDbException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }

    @Override
    public void update(String memberId, int money) {
        String sql = "UPDATE member SET money = ? WHERE member_id = ?";

        Connection conn = null;
        PreparedStatement pstmt = null;

        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, money);
            pstmt.setString(2, memberId);
            int resultSize = pstmt.executeUpdate();
            log.info("resultSize={} " + resultSize);
        } catch(SQLException e) {
            log.error("Error", e);
            throw new MyDbException(e);
        } finally {
            close(conn, pstmt, null);
        }
    }

    @Override
    public void delete(String member_id) {
        String sql = "DELETE FROM member WHERE member_id = ?";

        Connection conn = null;
        PreparedStatement pstmt = null;

        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, member_id);
            int resultSize = pstmt.executeUpdate();
            log.info("resultSize={} " + resultSize);
        } catch(SQLException e) {
            log.error("Error", e);
            throw new MyDbException(e);
        } finally {
            close(conn, pstmt, null);
        }
    }
    
    private Connection getConnection() {
        // ğŸ’¡ íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©
        Connection connection = DataSourceUtils.getConnection(dataSource);

        log.info("get Connection{}, class={}", connection, connection.getClass());
        return connection;
    }

    private void close(Connection conn, Statement stmt, ResultSet rs) {
        JdbcUtils.closeResultSet(rs);
        JdbcUtils.closeStatement(stmt);

        // ğŸ’¡ íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©
        DataSourceUtils.releaseConnection(conn, dataSource);
    }
}
```

  - MemberRepository ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„
  - SQLExceptionì´ë¼ëŠ” Checked ì˜ˆì™¸ë¥¼ MyDbException ì´ë¼ëŠ” Runtime ì˜ˆì™¸ë¡œ ë³€í™˜í•´ì„œ ë˜ì§

4. ì˜ˆì™¸ ë³€í™˜
```java
catch(SQLException e) {
    throw new MyDbException(e);
}
```
  - ê¸°ì¡´ ì˜ˆì™¸ë¥¼ ìƒì„±ìë¥¼ í†µí•´ì„œ í¬í•¨í•˜ê³  ìˆëŠ” ê²ƒ í™•ì¸ ê°€ëŠ¥
  - ğŸ’¡ ì˜ˆì™¸ëŠ” ì›ì¸ì´ ë˜ëŠ” ì˜ˆì™¸ë¥¼ ë‚´ë¶€ì— í¬í•¨í•  ìˆ˜ ìˆëŠ”ë°, ë°˜ë“œì‹œ ì´ë ‡ê²Œ ì‘ì„±í•´ì•¼ í•¨
  - ğŸ’¡ ê·¸ë˜ì•¼ ì˜ˆì™¸ë¥¼ ì¶œë ¥í–ˆì„ ë•Œ, ì›ì¸ì´ ë˜ëŠ” ê¸°ì¡´ ì˜ˆì™¸ë„ í•¨ê»˜ í™•ì¸ ê°€ëŠ¥
  - ì¦‰, MyDbExceptionì´ ë‚´ë¶€ì— SQLExceptionì„ í¬í•¨í•˜ê³  ìˆëŠ” ê²ƒ. ì˜ˆì™¸ë¥¼ ì¶œë ¥í–ˆì„ ë•Œ, ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ë¥¼ í†µí•´ ë‘˜ë‹¤ í™•ì¸ ê°€ëŠ¥

5. ì˜ˆì™¸ ë³€í™˜ - ê¸°ì¡´ ì˜ˆì™¸ ë¬´ì‹œ
```java
catch(SQLException e) {
    throw new MyDbException();
}
```
  - new MyDbException()ìœ¼ë¡œ í•´ë‹¹ ì˜ˆì™¸ë§Œ ìƒì„±í•˜ê³  ê¸°ì¡´ì˜ SQLExceptionì€ í¬í•¨í•˜ì§€ ì•Šê³  ë¬´ì‹œ
  - ë”°ë¼ì„œ, MyDbExceptionì€ ë‚´ë¶€ì— ì›ì¸ì´ ë˜ëŠ” ë‹¤ë¥¸ ì˜ˆì™¸ë¥¼ í¬í•¨í•˜ì§€ ì•ŠìŒ
  - ì´ë ‡ê²Œ ì›ì¸ì´ ë˜ëŠ” ì˜ˆì™¸ë¥¼ ë‚´ë¶€ì— í¬í•¨í•˜ì§€ ì•Šìœ¼ë©´, ì˜ˆì™¸ë¥¼ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ë¥¼ í†µí•´ ì¶œë ¥í•  ë•Œ, ê¸°ì¡´ì— ì›ì¸ì´ ë˜ëŠ” ë¶€ë¶„ í™•ì¸ ë¶ˆê°€
     + ë§Œì•½ SQLExceptionì—ì„œ ë¬¸ë²• ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤ë©´, ê·¸ ë¶€ë¶„ì„ í™•ì¸í•  ë°©ë²•ì´ ì—†ê²Œ ë¨
  - ğŸ’¡ ì¦‰, ì˜ˆì™¸ë¥¼ ë³€í™˜í•  ë–„, ê¸°ì¡´ ì˜ˆì™¸ë¥¼ í¬í•¨í•˜ì§€ ì•Šìœ¼ë©´, ì¥ì• ê°€ ë°œìƒí•˜ê³  ë¡œê·¸ì—ì„œ ì§„ì§œ ì›ì¸ì´ ë‚¨ì§€ ì•ŠëŠ” ì‹¬ê°í•œ ë¬¸ì œ ë°œìƒ

6. MemberServiceV4
```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.annotation.Transactional;

import java.sql.SQLException;

/**
 * ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°
 *  - SQLException ì œê±°
 *  - MemberRepository ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´
 */
@Slf4j
public class MemberServiceV4 {

    private final MemberRepository memberRepository;

    public MemberServiceV4(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }

    @Transactional
    public void accountTransfer(String fromId, String toId, int money) {
        bizLogic(fromId, toId, money);
    }

    private static void validation(Member toMember) {
        if(toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

    private void bizLogic( String fromId, String toId, int money) {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(toId, toMember.getMoney() + money);
    }
}
```
  - MemberRepository ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´í•˜ë„ë¡ ì½”ë“œ ë³€ê²½
  - MemberRepositoryV3_3ì™€ ë¹„êµí•´ì„œ ë³´ë©´ ë©”ì„œë“œì— throws SQLException ë¶€ë¶„ì´ ì œê±°ëœ ê²ƒ í™•ì¸ ê°€ëŠ¥
  - ì¦‰, ìˆœìˆ˜í•œ ì„œë¹„ìŠ¤ ì™„ì„±

7. MemberServiceV4Test
```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepository;
import hello.jdbc.repository.MemberRepositoryV4_1;
import lombok.extern.slf4j.Slf4j;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.aop.support.AopUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;

import javax.sql.DataSource;
import java.sql.SQLException;

import static org.assertj.core.api.AssertionsForClassTypes.assertThatThrownBy;
import static org.assertj.core.api.AssertionsForInterfaceTypes.assertThat;

/**
 * ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°
 *  - SQLException ì œê±°
 *  - MemberRepository ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´
 */
@Slf4j
@SpringBootTest // í…ŒìŠ¤íŠ¸ ë‚´ì—ì„œ ìŠ¤í”„ë§ ë¶€íŠ¸ ì ìš©
class MemberServiceV4Test {
    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    @Autowired // ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë˜ë¯€ë¡œ, ìŠ¤í”„ë§ ë¹ˆì„ í†µí•œ ì˜ì¡´ ê´€ê³„ ìë™ ì£¼ì…
    MemberRepository memberRepository;
    @Autowired
    MemberServiceV4 memberService;

    @TestConfiguration // ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆ ë‚´ ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¡°ì„±
    static class TestConfig {

        private final DataSource dataSource;

        public TestConfig(DataSource dataSource) {
            this.dataSource = dataSource;
        }

        @Bean // memberRepositoryV4_1 ë“±ë¡
        MemberRepository memberRepository() {
            return new MemberRepositoryV4_1(dataSource);
        }

        @Bean // memberServiceV4 ë“±ë¡
        MemberServiceV4 memberServiceV4() {
            return new MemberServiceV4(memberRepository());
        }
    }

    @AfterEach
    void after() throws SQLException {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    @Test
    void AopCheck() {
        log.info("memberService class={}", memberService.getClass());
        log.info("memberRepository class={}", memberRepository.getClass());
        Assertions.assertThat(AopUtils.isAopProxy(memberService)).isTrue();
        Assertions.assertThat(AopUtils.isAopProxy(memberRepository)).isFalse();
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        // Given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        // When
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);

        // Then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);
    }

    @Test
    @DisplayName("ì´ì²´ ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        // Given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEX = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEX);

        // When
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEX.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        // Then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEX = memberRepository.findById(memberEX.getMemberId());

        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberEX.getMoney()).isEqualTo(10000);
    }
}
```
  - MemberRepository ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©
  - í…ŒìŠ¤íŠ¸ ëª¨ë‘ ì •ìƒ ì‘ë™

-----
### ì •ë¦¬
-----
1. Checked ì˜ˆì™¸ë¥¼ Runtime ì˜ˆì™¸ë¡œ ë³€í™˜í•˜ë©´ì„œ ì¸í„°í˜ì´ìŠ¤ì™€ ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ìˆœìˆ˜ì„±ì„ ìœ ì§€í•  ìˆ˜ ìˆê²Œ ë¨
2. ë•ë¶„ì— í–¥í›„ JDBCì—ì„œ ë‹¤ë¥¸ êµ¬í˜„ ê¸°ìˆ ë¡œ ë³€ê²½í•˜ë”ë¼ë„ ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ì½”ë“œë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³  ìœ ì§€ ê°€ëŠ¥
