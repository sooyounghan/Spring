-----
### ë°ì´í„° ì ‘ê·¼ ì˜ˆì™¸
-----
1. ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ì— ë”°ë¼ íŠ¹ì • ì˜ˆì™¸ëŠ” ë³µêµ¬í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆìŒ
2. ì˜ˆë¥¼ ë“¤ì–´, íšŒì› ê°€ì… ì‹œ DBì— ì´ë¯¸ ê°™ì€ IDê°€ ìˆìœ¼ë©´ ID ë’¤ì— ìˆ«ìë¥¼ ë¶™ì—¬ì„œ ìƒˆë¡œìš´ IDë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤ê³  ê°€ì •
   - IDë¥¼ helloë¼ê³  ê°€ì… ì‹œë„ í–ˆìœ¼ë‚˜, ì´ë¯¸ ê°™ì€ ì•„ì´ë””ê°€ ìˆìœ¼ë©´ hello12345ì™€ ê°™ì´ ë’¤ì— ì„ì˜ ìˆ«ìë¥¼ ë¶™ì—¬ ê°€ì…
3. ë°ì´í„°ë¥¼ DBì— ì €ì¥í•  ë•Œ ê°™ì€ IDê°€ ì´ë¯¸ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆìœ¼ë©´, ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì˜¤ë¥˜ ì½”ë“œë¥¼ ë°˜í™˜
   - ì´ ì˜¤ë¥˜ ì½”ë“œë¥¼ ë°›ì€ JDBC ë“œë¼ì´ë²„ëŠ” SQLExceptionì„ ë˜ì§
   - ê·¸ë¦¬ê³  SQLExceptionì—ëŠ” ë°ì´í„°ë² ì´ìŠ¤ê°€ ì œê³µí•˜ëŠ” errorCodeë¼ëŠ” ê²ƒì´ ì¡´ì¬
4. ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ ì½”ë“œ ê·¸ë¦¼
<div align="center">
<img src="https://github.com/sooyounghan/Spring/assets/34672301/586f05cd-08b3-4e07-8422-c22929a81250">
</div>

5. H2 ë°ì´í„°ë² ì´ìŠ¤ì˜ í‚¤ ì¤‘ë³µ ì˜¤ë¥˜ ì½”ë“œ
```java
e.getErrorCode() == 23505
```
  - SQLException ë‚´ë¶€ì— ë“¤ì–´ìˆëŠ” errorCodeë¥¼ í™œìš©í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ì— ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥

6. H2 ë°ì´í„°ë² ì´ìŠ¤ ì˜ˆ
   - 23505 : í‚¤ ì¤‘ë³µ ì˜¤ë¥˜
   - 42000 : SQL ë¬¸ë²• ì˜¤ë¥˜
   - ì°¸ê³ ë¡œ ê°™ì€ ì˜¤ë¥˜ì—¬ë„ ê° ë°ì´í„°ë² ì´ìŠ¤ë§ˆë‹¤ ì •ì˜ëœ ì˜¤ë¥˜ ì½”ë“œê°€ ë‹¤ë¦„
   - ë”°ë¼ì„œ, ì˜¤ë¥˜ ì½”ë“œë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ë°ì´í„°ë² ì´ìŠ¤ ë©”ë‰´ì–¼ í™•ì¸ í•„ìš”
     + H2 DB : 23505
     + MySQL : 1602
   - H2 ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ ì½”ë“œ ì°¸ê³  : https://www.h2database.com/javadoc/org/h2/api/ErrorCode.html

7. ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œëŠ” ì˜ˆì™¸ ë³µêµ¬ë¥¼ ìœ„í•´ í‚¤ ì¤‘ë³µ ì˜¤ë¥˜ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆì–´ì•¼ í•¨
   - ê·¸ë˜ì•¼ ìƒˆë¡œìš´ IDë¥¼ ë§Œë“¤ì–´ì„œ ë‹¤ì‹œ ì €ì¥ì„ ì‹œë„í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì„
   - ì´ëŸ¬í•œ ê³¼ì •ì´ ë°”ë¡œ ì˜ˆì™¸ë¥¼ í™•ì¸í•´ì„œ ë³µêµ¬í•˜ëŠ” ê³¼ì •
   - ë ˆí¬ì§€í† ë¦¬ëŠ” SQLExceptionì„ ì„œë¹„ìŠ¤ ê³„ì¸µì— ë˜ì§€ê³ , ì„œë¹„ìŠ¤ ê³„ì¸µì€ ì´ ì˜ˆì™¸ì˜ ì˜¤ë¥˜ ì½”ë“¤ë¥¼ í™•ì¸ í•´ í‚¤ ì¤‘ë³µ ì˜¤ë¥˜(23505)ì¸ ê²½ìš° ìƒˆë¡œìš´ IDë¥¼ ë§Œë“¤ì–´ ë‹¤ì‹œ ì €ì¥
   - ê·¸ëŸ°ë°, SQLExceptionì— ë“¤ì–´ ìˆëŠ” ì˜¤ë¥˜ ì½”ë“œë¥¼ í™œìš©í•˜ê¸° ìœ„í•´ SQLExceptionì„ ì„œë¹„ìŠ¤ ê³„ì¸µìœ¼ë¡œ ë˜ì§€ê²Œ ë˜ë©´, ì„œë¹„ìŠ¤ ê³„ì¸µì´ SQLExceptionì´ë¼ëŠ” JDBC ê¸°ìˆ ì— ì˜ì¡´í•˜ê²Œ ë¨
   - ë”°ë¼ì„œ, ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ìˆœìˆ˜ì„±ì´ ë¬´ë„ˆì§

8. ë”°ë¼ì„œ, ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë ˆí¬ì§€í† ë¦¬ì—ì„œ ì˜ˆì™¸ë¥¼ ë³€í™˜í•´ì„œ ë˜ì§ (SQLException â†’ MyDuplicateKeyException)

9. MyDuplicateException
```java
package hello.jdbc.repository.ex;

public class MyDuplicateKeyException extends MyDbException {
    public MyDuplicateKeyException() {
    }

    public MyDuplicateKeyException(String message) {
        super(message);
    }

    public MyDuplicateKeyException(String message, Throwable cause) {
        super(message, cause);
    }

    public MyDuplicateKeyException(Throwable cause) {
        super(cause);
    }
}
```
  - ê¸°ì¡´ì— ì‚¬ìš©í–ˆë˜ MyDbExceptionì„ ìƒì†ë°›ì•„ ì˜ë¯¸ìˆëŠ” ê³„ì¸µ í˜•ì„±
  - ì´ë ‡ê²Œ í•¨ìœ¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ì˜ˆì™¸ë¼ëŠ” ê³„ì¸µì„ ë§Œë“¤ ìˆ˜ ìˆìŒ
  - ê·¸ë¦¬ê³  ì´ë¦„ë„ MyDuplicateKeyException ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ìƒì„±
  - ì´ ì˜ˆì™¸ëŠ” ë°ì´í„° ì¤‘ë³µì˜ ê²½ìš°ì—ë§Œ ë˜ì ¸ì•¼ í•¨
  - ì´ ì˜ˆì™¸ëŠ” ì§ì ‘ ë§Œë“  ê²ƒì´ë¯€ë¡œ, JDBCë‚˜ JPAì™€ ê°™ì€ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ì ì´ì§€ ì•ŠìŒ
  - ë”°ë¼ì„œ, ì´ ì˜ˆì™¸ë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ìˆœìˆ˜ì„± ìœ ì§€ ê°€ëŠ¥ (ì¦‰, í–¥í›„ JDBCì—ì„œ ë‹¤ë¥¸ ê¸°ìˆ ë¡œ ë°”ê¾¸ì–´ë„ ì´ ì˜ˆì™¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ ê°€ëŠ¥)

10. ExTranslatorV1Test
```java
package hello.jdbc.exception.translator;

import hello.jdbc.connection.ConnectionConst;
import hello.jdbc.domain.Member;
import hello.jdbc.repository.ex.MyDbException;
import hello.jdbc.repository.ex.MyDuplicateKeyException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.jdbc.support.JdbcUtils;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.Random;

import static hello.jdbc.connection.ConnectionConst.*;

@Slf4j
public class ExTranslatorV1Test {

    Repository repository;
    Service service;

    @BeforeEach
    void init() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        repository = new Repository(dataSource);
        service = new Service(repository);
    }

    @Test
    void duplicateKeySave() {
        service.create("myId");
        service.create("myId"); // ê°™ì€ ID ì €ì¥ ì‹œë„
    }

    @Slf4j
    @RequiredArgsConstructor
    static class Service {
        private final Repository repository;

        public void create(String memberId) {
            try {
                repository.save(new Member(memberId, 0));
                log.info("saveId={}", memberId);
            } catch (MyDuplicateKeyException e) {
                log.info("í‚¤ ì¤‘ë³µ, ë³µêµ¬ ì‹œë„");
                String retryId = generateNewId(memberId);
                log.info("retryId={}", retryId);
                repository.save(new Member(retryId, 0));
            } catch (MyDbException e) {
                log.info("ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ ì˜ˆì™¸", e);
                throw e;
            }
        }

        private String generateNewId(String memberId) {
            return memberId + new Random().nextInt(10000);
        }
    }

    @RequiredArgsConstructor
    static class Repository {

        private final DataSource dataSource;

        public Member save(Member member) {
            String sql = "INSERT INTO MEMBER(member_id, money) VALUES(?, ?)";
            Connection conn = null;
            PreparedStatement pstmt = null;

            try {
                conn = dataSource.getConnection();
                pstmt = conn.prepareStatement(sql);
                pstmt.setString(1, member.getMemberId());
                pstmt.setInt(2, member.getMoney());
                pstmt.executeUpdate();
                return member;
            } catch(SQLException e) {
                // H2 DB
                if(e.getErrorCode() == 23505) {
                    throw new MyDuplicateKeyException(e);
                }
                throw new MyDbException(e);
            } finally {
                JdbcUtils.closeStatement(pstmt);
                JdbcUtils.closeConnection(conn);
            }
        }
    }
}
```
  - ì‹¤í–‰ ê²°ê³¼ ë¡œê·¸
```java
18:47:52.276 [Test worker] INFO  h.j.e.t.ExTranslatorV1Test$Service -- saveId=myId
18:47:52.292 [Test worker] INFO  h.j.e.t.ExTranslatorV1Test$Service -- í‚¤ ì¤‘ë³µ, ë³µêµ¬ ì‹œë„
18:47:52.308 [Test worker] INFO  h.j.e.t.ExTranslatorV1Test$Service -- retryId=myId1729
```
  - ê°™ì€ IDë¥¼ ì €ì¥í–ˆì§€ë§Œ, ì¤‘ê°„ì— ì˜ˆì™¸ë¥¼ ì¡ì•„ì„œ ë³µêµ¬í•œ ê²ƒ í™•ì¸ ê°€ëŠ¥

11. ë™ì‘ ë°©ì‹ (ë ˆí¬ì§€í† ë¦¬)
```java
catch(SQLException e) {
      // H2 DB
      if(e.getErrorCode() == 23505) {
          throw new MyDuplicateKeyException(e);
      }
      throw new MyDbException(e);
}
```
  - e.getErrorCode() == 23505 : ì˜¤ë¥˜ ì½”ë“œê°€ í‚¤ ì¤‘ë³µ(23505)ì¸ ê²½ìš° MyDuplicateKeyExceptionì„ ìƒˆë¡œ ë§Œë“¤ì–´ ì„œë¹„ìŠ¤ ê³„ì¸µì— ë˜ì§
  - ë‚˜ë¨¸ì§€ ê²½ìš° ê¸°ì¡´ì— ë§Œë“¤ì—ˆë˜ MyDbExceptionì„ ë˜ì§

12. ë™ì‘ ë°©ì‹ (ì„œë¹„ìŠ¤)
```java
try {
    repository.save(new Member(memberId, 0));
    log.info("saveId={}", memberId);
} catch (MyDuplicateKeyException e) {
    log.info("í‚¤ ì¤‘ë³µ, ë³µêµ¬ ì‹œë„");
    String retryId = generateNewId(memberId);
    log.info("retryId={}", retryId);
    repository.save(new Member(retryId, 0));
} catch (MyDbException e) {
    log.info("ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ ì˜ˆì™¸", e);
    throw e;
}
```
  - ì²˜ìŒì— ì €ì¥ì„ ì‹œë„. ë§Œì•½ ë ˆí¬ì§€í† ë¦¬ì—ì„œ MyDuplicateKeyException ì˜ˆì™¸ê°€ ì˜¬ë¼ì˜¤ë©´ ì´ ì˜ˆì™¸ë¥¼ ì¡ìŒ
  - ì˜ˆì™¸ë¥¼ ì¡ì•„ì„œ generateNewId(memberId)ë¡œ ìƒˆë¡œìš´ ID ìƒì„± ì‹œë„
  - ê·¸ë¦¬ê³  ë‹¤ì‹œ ì €ì¥ (ì´ ë¶€ë¶„ì´ ì˜ˆì™¸ë¥¼ ë³µêµ¬í•˜ëŠ” ë¶€ë¶„)
  - ë§Œì•½ ë³µêµ¬í•  ìˆ˜ ì—†ëŠ” ì˜ˆì™¸(MyDbException)ë©´, ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ë‹¤ì‹œ ì˜ˆì™¸ë¥¼ ë˜ì§
    + ì°¸ê³ ë¡œ ì´ ê²½ìš°, ì—¬ê¸°ì„œ ì˜ˆì™¸ ë¡œê·¸ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•„ë„ ë¨
    + ğŸ’¡ ì–´ì°¨í”¼, ë³µêµ¬í•  ìˆ˜ ì—†ëŠ” ì˜ˆì™¸ë¥¼ ê³µí†µìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ê¹Œì§€ ì „ë‹¬ë˜ê¸° ë•Œë¬¸ì„
    + ë”°ë¼ì„œ, ì´ë ‡ê²Œ ë³µêµ¬í•  ìˆ˜ ì—†ëŠ” ì˜ˆì™¸ëŠ” ê³µí†µìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ê³³ì—ì„œ ì˜ˆì™¸ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ê²ƒì´ ì¢‹ìŒ
    + ì—¬ê¸°ì„œëŠ” ë‹¤ì–‘í•˜ê²Œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ì´ ê³³ì— ì½”ë“œë¥¼ ë§Œë“¤ì–´ë‘ 

-----
### ì •ë¦¬
-----
1. SQL ErrorCodeë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ì–´ë–¤ ì˜¤ë¥˜ê°€ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŒ
2. ì˜ˆì™¸ ë³€í™˜ì„ í†µí•´ SQLExceptionì„ íŠ¹ì • ê¸°ìˆ ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ” ì§ì ‘ ë§Œë“  ì˜ˆì™¸ì¸ MyDuplicateKeyExceptionìœ¼ë¡œ ë³€í™˜ ê°€ëŠ¥
3. ë ˆí¬ì§€í† ë¦¬ ê³„ì¸µì´ ì˜ˆì™¸ë¥¼ ë³€í™˜í•´ì¤€ ë•ë¶„ì— ì„œë¹„ìŠ¤ ê³„ì¸µì€ íŠ¹ì • ê¸°ìˆ ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ” MyDuplicateKeyExceptionì„ ì‚¬ìš©í•´ ë¬¸ì œë¥¼ ë³µêµ¬í•˜ê³ , ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ìˆœìˆ˜ì„± ìœ ì§€í•  ìˆ˜ ìˆìŒ

-----
### ë¬¸ì œì 
-----
1. SQL ErrorCodeëŠ” ê° ë°ì´í„°ë² ì´ìŠ¤ë§ˆë‹¤ ë‹¤ë¦„
   - ê²°ê³¼ì ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë³€ê²½í•  ë•Œë§ˆë‹¤ Error ì½”ë“œë„ ëª¨ë‘ ë³€ê²½í•´ì¤˜ì•¼ í•¨

2. ë°ì´í„°ë² ì´ìŠ¤ê°€ ì „ë‹¬í•˜ëŠ” ì˜¤ë¥˜ëŠ” í‚¤ ì¤‘ë³µ ë¿ ì•„ë‹ˆë¼, ë½ì´ ê±¸ë¦° ê²½ìš°, SQL ë¬¸ë²•ì— ì˜¤ë¥˜ê°€ ìˆëŠ” ê²½ìš° ë“± ìˆ˜ì‹­ ~ ìˆ˜ë°±ê°€ì§€ ì˜¤ë¥˜ ì½”ë“œ ì¡´ì¬
3. ì´ ëª¨ë“  ìƒí™©ì— ë§ëŠ” ì˜ˆì™¸ë¥¼ ë‹¤ ì²˜ë¦¬í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥
