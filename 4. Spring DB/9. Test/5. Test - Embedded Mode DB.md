-----
### 테스트 - 임베디드 모드 (Embedded Mode)
-----
1. 테스트 케이스를 실행하기 위해 데이터베이스를 설치하고, 운영하는 것은 상당히 번잡한 작업
2. 단순히 테스트를 검증할 용도로만 사용하기 떄문에, 테스트가 끝나면 데이터베이스의 데이터를 모두 삭제해도 됨
3. 더 나아가서 테스트가 끝나면, 데이터베이스 자체를 제거해도 됨
4. H2 데이터베이스는 자바로 개발되어있고, JVM 안에서 메모리 모드로 작동하는 특별 기능 제공
5. 애플리케이션을 실행할 떄 H2 데이버테이스도 해당 JVM 메모리에 포함해서 함께 실행 가능
6. 💡 DB를 애플리케이션에 내장해서 함께 실행한다고 해서 임베디드 모드(Embedded Mode)
7. 물론, 애플리케이션이 종료되면 임베디드 모드로 동작하는 H2 데이버테이스도 함께 종료되고, 데이터도 모두 삭제
8. 즉, 애플리케이션에서 자바 메모리를 함께 사용하는 라이브러리처럼 동작
9. 임베디드 모드 직접 사용
```java
package hello.itemservice;

import hello.itemservice.config.*;
import hello.itemservice.repository.ItemRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.Profile;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

import javax.sql.DataSource;


// @Import(MemoryConfig.class)
// @Import(JdbcTemplateV1Config.class)
// @Import(JdbcTemplateV2Config.class)
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
@Slf4j
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}

	@Bean
	@Profile("local")
	public TestDataInit testDataInit(ItemRepository itemRepository) {
		return new TestDataInit(itemRepository);
	}

	@Bean
	@Profile("test")
	public DataSource dataSource() {
		log.info("메모리 데이터베이스 초기화");
		DriverManagerDataSource dataSource = new DriverManagerDataSource();
		dataSource.setDriverClassName("org.h2.Driver");
		dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
		dataSource.setUsername("sa");
		dataSource.setPassword("");

		return dataSource;
	}
}
```
  - @Profile("test") : 프로필이 test인 경우에만 데이터소스를 스프링 빈으로 등록
    + 테스트 케이스에서만 이 데이터소스를 스프링 빈으로 등록해서 사용
      
  - dataSource()
    + 💡 jdbc:h2:mem:db : 데이터 소스를 만들 때 이렇게 적으면 임베디드 모드(메모리 모드)로 동작하는 H2 데이터베이스 사용 가능
    + DB_CLOSE_DELAY=-1 : 임베디드 모드에서는 데이터베이스 커넥션 연결이 모두 끊어지면 데이터베이스도 종료되는데, 이를 방지하는 설정
    + 이 데이터 소스를 사용하면 메모리 DB 사용 가능
  
  - 테스트를 실행만하면, 새로 등록한 메모리 DB에 접근하는 데이터소스 사용
  - 실행 결과
```
org.springframework.jdbc.BadSqlGrammarException: PreparedStatementCallback; bad SQL grammar []; nested exception is org.h2.jdbc.JdbcSQLSyntaxErrorException: Table "ITEM" not found; SQL statement: insert into item (item_name, price, quantity) values (?, ?, ?) [42102-200]
...
Caused by: org.h2.jdbc.JdbcSQLSyntaxErrorException: Table "ITEM" not found; SQL statement: insert into item (item_name, price, quantity) values (?, ?, ?) [42102-200]
```
   - 💡 오류는 항상 아래에 있는 정보가 더 근본 원인에 가까운 오류 로그
   - Table "ITEM" not found, 즉 데이터베이스 테이블이 없는 것
   - 즉, 메모리 DB에 아직 테이블을 만들지 않은 것

-----
### 스프링 부트 - 기본 SQL 스크립트를 사용해 데이터베이스를 초기화
-----
1. 메모리 DB는 애플리케이션이 종료될 때 함께 사라지므로, 애플리케이션 실행 시점에 데이터베이스도 새로 만들어줘야 함
2. JDBC나 JdbcTemplate을 직접 사용해서 테이블을 생성하는 DDL을 호출해도 되지만, 불편함
3. 따라서, 스프링 부트는 SQL 스크립트를 실행해서 애플리케이션 로딩 시점에 데이터베이스를 초기화하는 기능 제공
4. src/test에 다음과 같은 파일 생성 : src/test/resources/schema.sql
```sql
DROP TABLE IF EXISTS item CASCADE; 
CREATE TABLE item
(
    id        BIGINT GENERATED BY DEFAULT AS IDENTITY, 
    item_name VARCHAR(10),
    price     INTEGER, 
    quantity  INTEGER,
    PRIMARY KEY (id) 
);
```
5. SQL 스크립트를 사용해 데이터베이스를 초기화하는 자세한 방법 : https://docs.spring.io/spring-boot/redirect.html?page=howto#howto.data-initialization.using-basic-sql-scripts

6. 실행하면 정상 수행

7. 로그 확인 (기본 SQL 스크립트가 잘 실행되었는지 확인) (src/test/resources/application.properteis)
```properties
#schema.sql
logging.level.org.springframework.jdbc=debug
```
  - SQL 스크립트 로그
```
..init.ScriptUtils     : 0 returned as update count for SQL: drop table if exists item CASCADE
..init.ScriptUtils     : 0 returned as update count for SQL: create table item ( id bigint generated by default as identity, item_name varchar(10), price integer, quantity integer, primary key (id) )
```
