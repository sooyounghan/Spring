-----
### JPA ê°œë°œ
-----
1. JPAì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì€ ê°ì²´ì™€ í…Œì´ë¸”ì„ Mappingí•˜ëŠ” ê²ƒ
2. JPAê°€ ì œê³µí•˜ëŠ” ì• ë„ˆí…Œì´ì…˜ì„ ì‚¬ìš©í•´ Item ê°ì²´ì™€ í…Œì´ë¸” Mapping
3. Item - ORM ë§¤í•‘
```java
package hello.itemservice.domain;

import lombok.Data;

import javax.persistence.*;

@Data
@Entity
// @Table(name = "Item") // ê°ì²´ëª…ê³¼ í…Œì´ë¸”ëª…ì´ ë™ì¼í•˜ë©´ ìƒëµ ê°€ëŠ¥
public class Item {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "item_name", length = 10)
    private String itemName;
    private Integer price;
    private Integer quantity;

    public Item() {
    }

    public Item(String itemName, Integer price, Integer quantity) {
        this.itemName = itemName;
        this.price = price;
        this.quantity = quantity;
    }
}
```
  - @Entity : JPAê°€ ì‚¬ìš©í•˜ëŠ” ê°ì²´ë¼ëŠ” ëœ»
    + ì´ ì• ë„ˆí…Œì´ì…˜ì´ ìˆì–´ì•¼ JPAê°€ ì¸ì‹
    + @Entityê°€ ë¶™ì€ ê°ì²´ë¥¼ JPAì—ì„œëŠ” Enttiyë¼ê³  í•¨
  - @Id : í…Œì´ë¸”ì˜ PKì™€ í•´ë‹¹ í•„ë“œë¥¼ Mapping
  - @GeneratedValue(strategy = GenerationType.IDENTITY) : PK ìƒì„± ê°’ì„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìƒì„±í•˜ëŠ” IDENTITY ë°©ì‹ ì‚¬ìš© (ì˜ˆ) MySQL AUTO_INCREMENT)
  - @Column : ê°ì²´ì™€ í•„ë“œë¥¼ í…Œì´ë¸”ì˜ ì»¬ëŸ¼ê³¼ Mapping
    + name = "item_name" : ê°ì²´ëŠ” itemNameì´ì§€ë§Œ, í…Œì´ë¸”ì˜ ì»¬ëŸ¼ì€ item_nameì´ë¯€ë¡œ Mapping
    + length = 10 : JPA ë§¤í•‘ ì •ë³´ë¡œ DDL(CREATE TABLE)ë„ ìƒì„±í•  ìˆ˜ ìˆëŠ”ë°, ê·¸ ë•Œ ì»¬ëŸ¼ì˜ ê¸¸ì´ ê°’ìœ¼ë¡œ í™œìš© (VARCHAR(10))
    + @Columnì„ ìƒëµí•  ê²½ìš°, í•„ë“œì˜ ì´ë¦„ì„ í…Œì´ë¸” ì»¬ëŸ¼ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
      * ì§€ê¸ˆì²˜ëŸ¼ ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ í†µí•©í•´ì„œ ì‚¬ìš©í•˜ë©´ í•„ë“œ ì´ë¦„ì„ í…Œì´ë¸” ì»¬ëŸ¼ ëª…ìœ¼ë¡œ ë³€ê²½í•  ë•Œ ê°ì²´ í•„ë“œì˜ ì¹´ë©œ ì¼€ì´ìŠ¤ë¥¼ í…Œì´ë¸” ì¼€ì´ìŠ¤ì˜ ì–¸ë” ìŠ¤ì½”ì–´ë¡œ ìë™ìœ¼ë¡œ ë³€í™˜
      * ì¦‰, itemNameì´ item_nameìœ¼ë¡œ ë³€í™˜, ë”°ë¼ì„œ ìœ„ ì˜ˆì œì—ì„œ @Column(name = "item_name") ìƒëµ ê°€ëŠ¥

4. ğŸ’¡ JPAëŠ” public ë˜ëŠ” protectedì˜ ê¸°ë³¸ ìƒì„±ìê°€ í•„ìˆ˜ì´ë¯€ë¡œ, ê¼­ ë„£ì–´ì¤˜ì•¼ í•¨
```java
public Item() { }
```

5. ê¸°ë³¸ ë§¤í•‘ì€ ëë‚¬ìœ¼ë©°, JPAë¥¼ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ì½”ë“œ ì‘ì„±
6. JpaItemRepositoryV1
```java
package hello.itemservice.repository.jpa;

import hello.itemservice.domain.Item;
import hello.itemservice.repository.ItemRepository;
import hello.itemservice.repository.ItemSearchCond;
import hello.itemservice.repository.ItemUpdateDto;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;
import java.util.List;
import java.util.Optional;

@Slf4j
@Repository
@Transactional
public class JpaItemRepository implements ItemRepository {

    private final EntityManager em;

    public JpaItemRepository(EntityManager em) {
        this.em = em;
    }

    @Override
    public Item save(Item item) {
        em.persist(item);
        return item;
    }

    @Override
    public void update(Long itemId, ItemUpdateDto updateParam) {
        Item findItem = em.find(Item.class, itemId);
        findItem.setItemName(updateParam.getItemName());
        findItem.setPrice(updateParam.getPrice());
        findItem.setQuantity(updateParam.getQuantity());
    }

    @Override
    public Optional<Item> findById(Long id) {
        Item item = em.find(Item.class, id);
        return Optional.ofNullable(item);
    }

    @Override
    public List<Item> findAll(ItemSearchCond cond) {
        String jpql = "SELECT i FROM Item i"; // Itemì€ Item ê°ì²´ ì˜ë¯¸, iëŠ” Entity

        Integer maxPrice = cond.getMaxPrice();
        String itemName = cond.getItemName();
        
        if(StringUtils.hasText(itemName) || maxPrice != null) {
            jpql += " where";
        }
        
        boolean andFlag = false;
        
        if(StringUtils.hasText(itemName)) {
            jpql += " i.itemName LIKE CONCAT('%', :itemName, '%')";
            andFlag = true;
        }
        
        if(maxPrice != null) {
            if(andFlag) {
                jpql += " AND";
            }
            
            jpql += " i.price <= :maxPrice";
        }
        
        log.info("jpql = {}", jpql);

        TypedQuery<Item> query = em.createQuery(jpql, Item.class);
        if(StringUtils.hasText(itemName)) {
            query.setParameter("itemName", itemName);
        }
        
        if(maxPrice != null) {
            query.setParameter("maxPrice", maxPrice);
        }

        return query.getResultList();
    }
}
```

```java
private final EntityManager em;

public JpaItemRepository(EntityManager em) {
    this.em = em;
}
```
  - ìƒì„±ìë¥¼ ë³´ë©´ ìŠ¤í”„ë§ì„ í†µí•´ ì—”í‹°í‹° ë§¤ë‹ˆì €(EntityManager)ë¼ëŠ” ê²ƒì„ ì£¼ì… ë°›ìŒ
  - JPAì˜ ëª¨ë“  ë™ì‘ì€ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ í†µí•´ ì´ë£¨ì–´ì§
  - ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ë‚´ë¶€ì— ë°ì´í„° ì†ŒìŠ¤ë¥¼ ê°€ì§€ê³  ìˆê³ , ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒ

```java
@Transactional
public class JpaItemRepository implements ItemRepository {

    ...

}
```
  - JPAì˜ ëª¨ë“  ë°ì´í„° ë³€ê²½(ë“±ë¡, ìˆ˜ì •, ì‚­ì œ)ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì´ë£¨ì–´ì ¸ì•¼ í•¨
  - ì¡°íšŒëŠ” íŠ¸ëœì­ì…˜ ì—†ì´ë„ ê°€ëŠ¥
  - ë³€ê²½ì˜ ê²½ìš° ì¼ë°˜ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë¯€ë¡œ ë¬¸ì œê°€ ì—†ìŒ
  - í•˜ì§€ë§Œ, ìœ„ ì½”ë“œëŠ” ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì—†ìœ¼ë¯€ë¡œ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ íŠ¸ëœì­ì…˜ì„ ê±¸ì§€ ì•ŠìŒ
  - ğŸ’¡ JPA ì—ì„œ ë°ì´í„° ë³€ê²½ ì‹œ íŠ¸ëœì­ì…˜ì€ í•„ìˆ˜ì´ë¯€ë¡œ, ë ˆí¬ì§€í† ë¦¬ì— íŠ¸ëœì­ì…˜ì„ ê±¸ì–´ì¤Œ
  - ğŸ’¡ ì¼ë°˜ì ìœ¼ë¡œ, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì‹œì‘í•˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì— íŠ¸ëœì­ì…˜ì„ ê±¸ì–´ì£¼ëŠ” ê²ƒì´ ì¢‹ìŒ

7. ì°¸ê³ 
   - JPAë¥¼ ì„¤ì •í•˜ë ¤ë©´ EntityManagerFactory, JPA íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €(JpaTransactionManager), ë°ì´í„° ì†ŒìŠ¤ ë“± ë‹¤ì–‘í•œ ì„¤ì •ì„ í•´ì•¼ í•¨
   - ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ì´ ê³¼ì •ì„ ëª¨ë‘ ìë™í™” í•´ì¤Œ
   - ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ìë™ ì„¤ì •ì€ JpaBaseConfiguration ì°¸ê³ 

8. JpaConfig
```java
package hello.itemservice.config;

import hello.itemservice.repository.ItemRepository;
import hello.itemservice.repository.jpa.JpaItemRepository;
import hello.itemservice.service.ItemService;
import hello.itemservice.service.ItemServiceV1;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.persistence.EntityManager;

@Configuration
public class JpaConfig {

    private final EntityManager em;

    public JpaConfig(EntityManager em) {
        this.em = em;
    }

    @Bean
    public ItemService itemService() {
        return new ItemServiceV1(itemRepository());
    }

    @Bean
    public ItemRepository itemRepository() {
        return new JpaItemRepository(em);
    }
}
```

9. ItemServiceApplication ë³€ê²½
```java
package hello.itemservice;

import hello.itemservice.config.*;
import hello.itemservice.repository.ItemRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.Profile;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

import javax.sql.DataSource;


// @Import(MemoryConfig.class)
// @Import(JdbcTemplateV1Config.class)
// @Import(JdbcTemplateV2Config.class)
// @Import(JdbcTemplateV3Config.class)
// @Import(MyBatisConfig.class)
@Import(JpaConfig.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
@Slf4j
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}

	...

}
```

-----
### ë ˆí¬ì§€í† ë¦¬ ë¶„ì„
-----
1. save() - ì €ì¥
```java
public Item save(Item item) {
    em.persist(item);
    return item;
}
```
  - em.persist(item) : JPAì—ì„œ ê°ì²´ë¥¼ í…Œì´ë¸”ì— ì €ì¥í•  ë•ŒëŠ” ì—”í‹°í‹° ë§¤ë‹ˆì €ê°€ ì œê³µí•˜ëŠ” persist() ë©”ì„œë“œ ì‚¬ìš©
  - JPAê°€ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•œ SQL
```sql
insert into item (id, item_name, price, quantity) values (null, ?, ?, ?)
ë˜ëŠ”
insert into item (id, item_name, price, quantity) values (default, ?, ?, ?)
ë˜ëŠ”
insert into item (item_name, price, quantity) values (?, ?, ?)
```
  - JPAê°€ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•œ SQLì„ ë³´ë©´ id ê°’ì´ ë¹ ì ¸ìˆëŠ” ê²ƒ(null, default, x)ì„ ë³¼ ìˆ˜ ìˆìŒ
  - ì´ëŠ” PK í‚¤ ìƒì„± ì „ëµì„ IDENTITYë¡œ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì— JPAê°€ ì´ëŸ° ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ì„œ ì‹¤í–‰
  - ë¬¼ë¡ , ì¿¼ë¦¬ ì‹¤í–‰ ì´í›„ Item ê°ì²´ì˜ id í•„ë“œì— ë°ì´í„°ë² ì´ìŠ¤ê°€ ìƒì„±í•œ PK ê°’ì´ ë“¤ì–´ê°
  - JPAê°€ INSERT SQL ì‹¤í–‰ ì´í›„ ìƒì„±ëœ ID ê²°ê³¼ë¥¼ ë°›ì•„ì„œ ë„£ì–´ì¤Œ
  - PK ë§¤í•‘ ì°¸ê³ 
```java
@Entity
public class Item {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY) 
    private Long id;
}
```

2 update() - ìˆ˜ì •
```java
public void update(Long itemId, ItemUpdateDto updateParam) { 
    Item findItem = em.find(Item.class, itemId);
    findItem.setItemName(updateParam.getItemName());
    findItem.setPrice(updateParam.getPrice());
    findItem.setQuantity(updateParam.getQuantity()); 
}
```

  - JPAê°€ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•œ SQL
```sql
update item set item_name=?, price=?, quantity=? where id=?
```
  - em.update() ê°™ì€ ë©”ì„œë“œë¥¼ ì „í˜€ í˜¸ì¶œí•˜ì§€ ì•Šì•˜ìŒ
  - JPAëŠ” íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ì‹œì ì—, ë³€ê²½ë˜ëŠ” Entity ê°ì²´ê°€ ìˆëŠ”ì§€ í™•ì¸
  - íŠ¹ì • Entity ê°ì²´ê°€ ë³€ê²½ëœ ê²½ìš°, UPDATE SQLì„ ì‹¤í–‰
  - JPAê°€ ì–´ë–»ê²Œ ë³€ê²½ëœ Entity ê°ì²´ë¥¼ ì°¾ëŠ”ì§€ ëª…í™•í•˜ê²Œ ì´í•´í•˜ë ¤ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¼ëŠ” JPA ë‚´ë¶€ ì›ë¦¬ë¥¼ ì´í•´í•´ì•¼ í•¨
  - ì§€ê¸ˆì€, íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— JPAê°€ ë³€ê²½ëœ Entity ê°ì²´ë¥¼ ì°¾ì•„ UPDATE SQLì„ ìˆ˜í–‰í•œë‹¤ê³  ì´í•´
  - í…ŒìŠ¤íŠ¸ì˜ ê²½ìš°, ë§ˆì§€ë§‰ì— íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ë¯€ë¡œ JPAëŠ” UPDATE SQLì„ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (í™•ì¸í•˜ë ¤ë©´ @Commit)

3. findById() - ë‹¨ê±´ ì¡°íšŒ
```java
public Optional<Item> findById(Long id) { 
    Item item = em.find(Item.class, id);
    return Optional.ofNullable(item);
}
```
  - JPAì—ì„œ ì—”í‹°í‹° ê°ì²´ë¥¼ PK ê¸°ì¤€ ì¡°íšŒí•  ë•ŒëŠ” find() ì‚¬ìš©í•˜ê³ , ì¡°íšŒ íƒ€ì…ê³¼ PK ê°’ì„ ì£¼ë©´ ë¨
  - ê·¸ëŸ¬ë©´, JPAê°€ ë‹¤ìŒê³¼ ê°™ì€ ì¡°íšŒ SQLì„ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•˜ê³ , ê²°ê³¼ë¥¼ ê°œì²´ë¡œ ë°”ë¡œ ë³€í™˜
```sql
select
    item0_.id as id1_0_0_,
    item0_.item_name as item_nam2_0_0_,
    item0_.price as price3_0_0_,
    item0_.quantity as quantity4_0_0_
from item item0_
where item0_.id=?
```
  - JPA(í•˜ì´ë²„ë„¤ì´íŠ¸)ê°€ ë§Œë“¤ì–´ì„œ ì‹¤í–‰í•œ SQLì€ ë³„ì¹­ì´ ì¡°ê¸ˆ ë³µì¡
  - ì´ëŠ”, ì¡°ì¸ì´ ë°œìƒí•˜ê±°ë‚˜ ë³µì¡í•œ ì¡°ê±´ì—ì„œë„ ë¬¸ì œ ì—†ë„ë¡ ê¸°ê³„ì ìœ¼ë¡œ ë§Œë“¤ì–´ì„œ ë‚˜ì˜¨ ê²ƒ

4. findAll - ëª©ë¡ ì¡°íšŒ
```java
public List<Item> findAll(ItemSearchCond cond) { 
    String jpql = "SELECT i FROM Item i";

    //ë™ì  ì¿¼ë¦¬ ìƒëµ

    TypedQuery<Item> query = em.createQuery(jpql, Item.class); 
    return query.getResultList();
}
```
  - JPQL (Java Persistence Query Language) : ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´
    + JPAëŠ” JPQLì„ ì œê³µ
    + ì£¼ë¡œ ì—¬ëŸ¬ ë°ì´í„°ë¥¼ ë³µì¡í•œ ì¡°ê±´ìœ¼ë¡œ ì¡°íšŒí•  ë•Œ ì‚¬ìš©
    + SQLì´ ì´ í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ í•œë‹¤ë©´, JPQLëŠ” Entity ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ SQLì„ ì‹¤í–‰
    + Entity ê°ì²´ ëŒ€ìƒìœ¼ë¡œ í•˜ë¯€ë¡œ FROM ë‹¤ìŒì— Item (Entity ê°ì²´ ì´ë¦„)ì´ ë“¤ì–´ê°
    + ì—”í‹°í‹° ê°ì²´ì™€ ì†ì„±ì˜ ëŒ€ì†Œë¬¸ìëŠ” êµ¬ë¶„í•´ì•¼ í•¨(Item : ê°ì²´ ì´ë¦„, itemName : ì†ì„±)
  - ê²°ê³¼ì ìœ¼ë¡œ JPQLì„ ì‹¤í–‰í•˜ë©´, ê·¸ ì•ˆì— í¬í•¨ëœ Entity ê°ì²´ì˜ ë§¤í•‘ ì •ë³´ë¥¼ í™œìš©í•´ SQLì„ ë§Œë“¬
  - ì‹¤í–‰ëœ JPQL
```sql
SELECT i FROM Item i
WHERE i.itemName LIKE CONCAT('%', :itemName, '%')
AND i.price <= :maxPrice
```

  - JPQLë¥¼ í†µí•´ ì‹¤í–‰ëœ SQL
```sql
select
  item0_.id as id1_0_,
  item0_.item_name as item_nam2_0_,
  item0_.price as price3_0_,
  item0_.quantity as quantity4_0_
from item item0_
where (item0_.item_name like ('%'||?||'%'))
  and item0_.price<=?
```
  - íŒŒë¼ë¯¸í„° (JPQLì—ì„œ íŒŒë¼ë¯¸í„°ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì…ë ¥)
    + where price <= :maxPrice
    + íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì€ ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš© : query.setParameter("maxPrice", maxPrice)

5. ë™ì  ì¿¼ë¦¬ ë¬¸ì œ
   - JPAë¥¼ ì‚¬ìš©í•´ë„ ë™ì  ì¿¼ë¦¬ ë¬¸ì œê°€ ë‚¨ì•„ìˆìŒ
   - Querydslë¼ëŠ” ê¸°ìˆ ì„ í™œìš©í•˜ë©´ ë§¤ìš° ê¹”ë”í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥
   
