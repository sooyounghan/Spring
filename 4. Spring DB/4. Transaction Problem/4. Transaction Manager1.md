-----
### íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ì ìš©
-----
```java
package hello.jdbc.repository;

import hello.jdbc.domain.Member;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.datasource.DataSourceUtils;
import org.springframework.jdbc.support.JdbcUtils;

import javax.sql.DataSource;
import java.sql.*;
import java.util.NoSuchElementException;

/**
 * íŠ¸ëœì­ì…˜ - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
 * DataSourceUtils.getConnenction()
 * DataSourceUtils.releaseConnection();
 */

@Slf4j
public class MemberRepositoryV3 {

    private final DataSource dataSource;

    public MemberRepositoryV3(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public Member save(Member member) throws SQLException {
        String sql = "INSERT INTO member(member_id, money) VALUES(?, ?)"; // SQL Query

        Connection conn = null; // Connection ê°ì²´
        PreparedStatement pstmt = null; // SQL ì¿¼ë¦¬ ê°ì²´

        try {
            conn = getConnection(); // Connection ê°ì²´ ì–»ê¸°
            pstmt = conn.prepareStatement(sql); // SQL ì¿¼ë¦¬ ë‹´ê¸°
            pstmt.setString(1, member.getMemberId()); // ? ê°’ ëŒ€ì…
            pstmt.setInt(2, member.getMoney()); // ? ê°’ ëŒ€ì…
            pstmt.executeUpdate();
            return member; // ë°˜í™˜
        } catch (SQLException e) {
            log.error("DB Error", e); // ì˜ˆì™¸ì— ëŒ€í•œ ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
            throw e;
        } finally {
            close(conn, pstmt, null); // ìì› ë°˜í™˜
        }
    }

    public Member findById(String memberId) throws SQLException {
        String sql = "SELECT * FROM MEMBER WHERE member_id = ?";

        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, memberId);

            rs = pstmt.executeQuery();

            if(rs.next()) {
                Member member = new Member();
                member.setMemberId(rs.getString("member_id"));
                member.setMoney(rs.getInt("money"));
                return member;
            } else {
                throw new NoSuchElementException("Member Not Fount MemberId = " + memberId);
            }
        } catch(SQLException e) {
            log.error("Error", e);
            throw e;
        } finally {
            close(conn, pstmt, rs);
        }
    }
    
    public void update(String memberId, int money) throws SQLException {
        String sql = "UPDATE member SET money = ? WHERE member_id = ?";

        Connection conn = null;
        PreparedStatement pstmt = null;

        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, money);
            pstmt.setString(2, memberId);
            int resultSize = pstmt.executeUpdate();
            log.info("resultSize={} " + resultSize);
        } catch(SQLException e) {
            log.error("Error", e);
            throw e;
        } finally {
            close(conn, pstmt, null);
        }
    }

    public void delete(String member_id) throws SQLException {
        String sql = "DELETE FROM member WHERE member_id = ?";

        Connection conn = null;
        PreparedStatement pstmt = null;

        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, member_id);
            int resultSize = pstmt.executeUpdate();
            log.info("resultSize={} " + resultSize);
        } catch(SQLException e) {
            log.error("Error", e);
            throw e;
        } finally {
            close(conn, pstmt, null);
        }
    }

    private Connection getConnection() throws SQLException {
        // ğŸ’¡ íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©
        Connection connection = DataSourceUtils.getConnection(dataSource);

        log.info("get Connection{}, class={}", connection, connection.getClass());
        return connection;
    }

    private void close(Connection conn, Statement stmt, ResultSet rs) {
        JdbcUtils.closeResultSet(rs);
        JdbcUtils.closeStatement(stmt);
        
        // ğŸ’¡ íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©
        DataSourceUtils.releaseConnection(conn, dataSource);
    }
}
```
  - ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ëŠ” ë¶€ë¶„ ëª¨ë‘ ì œê±°

1. DataSourceUtils.getConnection()
   - getConnection()ì—ì„œ DataSourceUtils.getConnection()ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ëœ ë¶€ë¶„ ì£¼ì˜
   - ë™ì‘ ë°©ì‹
     + ğŸ’¡ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„¥ì…˜ì´ ìˆìœ¼ë©´, í•´ë‹¹ ì»¤ë„¥ì…˜ ë°˜í™˜
     + ğŸ’¡ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„¥ì…˜ì´ ì—†ëŠ” ê²½ìš°, ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•´ ë°˜í™˜

2. DataSourceUtils.releaseConnection()
   - close()ì—ì„œ DataSourceUtils.releaseConnection()ì„ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ëœ ë¶€ë¶„ ì£¼ì˜
   - conn.close()ë¡œ ì»¤ë„¥ì…˜ì„ ì§ì ‘ ë‹«ì•„ë²„ë¦¬ë©´, ì»¤ë„¥ì…˜ì´ ìœ ì§€ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ ë°œìƒ
   - ì´ ì»¤ë„¥ì…˜ì€ ì´í›„ ë¡œì§ì€ ë¬¼ë¡ , íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œ(ì»¤ë°‹, ë¡¤ë°±)í•  ë•Œê¹Œì§€ ì‚´ì•„ìˆì–´ì•¼ í•¨
   - ì´ ë©”ì„œë“œëŠ” ë°”ë¡œ ì»¤ë„¥ì…˜ì„ ë‹«ëŠ” ê²ƒì´ ì•„ë‹˜
     + ğŸ’¡ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë™ê¸°í™”ëœ ì»¤ë„¥ì…˜ì„ ë‹«ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ìœ ì§€
     + ğŸ’¡ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„¥ì…˜ì´ ì—†ëŠ” ê²½ìš° í•´ë‹¹ ì»¤ë„¥ì…˜ì€ ë‹«ìŒ

3. MemberServiceV3_1
```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.support.DefaultTransactionDefinition;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.SQLException;

/**
 * íŠ¸ëœì­ì…˜ - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €
 */
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV3_1 {
    private final PlatformTransactionManager transactionManager;
    private final MemberRepositoryV3 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        // íŠ¸ëœì­ì…˜ ì‹œì‘ (ë§¤ê°œë³€ìˆ˜ : íŠ¸ëœì­ì…˜ ë””í´íŠ¸ ì •ì˜)
        TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

        try {
            // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            bizLogic(fromId, toId, money);
            // ì„±ê³µ : íŠ¸ëœì­ì…˜ ì¢…ë£Œ (ì»¤ë°‹)
            transactionManager.commit(status);
        } catch(Exception e) {
            // ì˜ˆì™¸ ë°œìƒ (ì‹¤íŒ¨) í•˜ë©´, Rollback
            transactionManager.rollback(status);
            throw new IllegalStateException(e);
        } 
    }

    private static void validation(Member toMember) {
        if(toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

    private void bizLogic( String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(toId, toMember.getMoney() + money);
    }
}
```
  - private final PlatformTransactionManager transactionManager
    + íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì£¼ì… ë°›ìœ¼ë©°, í˜„ì¬ëŠ” JDBC ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë¯€ë¡œ DataSourceTransactionManager êµ¬í˜„ì²´ë¥¼ ì£¼ì… ë°›ì•„ì•¼ í•¨
    + JPA ê°™ì€ ê¸°ìˆ ë¡œ ë³€ê²½ë˜ë©´ JpaTransactionManagerë¥¼ ì£¼ì… ë°›ìœ¼ë©´ ë¨
  - transactionManager.getConnection() : íŠ¸ëœì­ì…˜ ì‹œì‘
    + ğŸ’¡ TransactionStatus statusë¥¼ ë°˜í™˜ (ì¦‰, í˜„ì¬ íŠ¸ëœì­ì…˜ì— ëŒ€í•œ ì •ë³´ê°€ í¬í•¨) : ì´í›„, íŠ¸ëœì­ì…˜ ì»¤ë°‹, ë¡¤ë°± ì‹œì— í•„ìš”
  - ğŸ’¡ new DefaultTransactionDefinition() : íŠ¸ëœì­ì…˜ê³¼ ê´€ë ¨ëœ ì˜µì…˜ ì§€ì • ê°€ëŠ¥
  - transactionManager.commit(status) : íŠ¸ëœì­ì…˜ì´ ì„±ê³µí•˜ë©´ ì´ ë¡œì§ í˜¸ì¶œí•´ì„œ ì»¤ë°‹
  - transactionManager.rollback(status) : íŠ¸ëœì­ì…˜ì´ ì‹¤íŒ¨í•˜ë©´ ì´ ë¡œì§ í˜¸ì¶œí•´ì„œ ë¡¤ë°±

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV2;
import hello.jdbc.repository.MemberRepositoryV3;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.transaction.PlatformTransactionManager;

import java.sql.SQLException;

import static hello.jdbc.connection.ConnectionConst.*;
import static org.assertj.core.api.AssertionsForClassTypes.assertThatThrownBy;
import static org.assertj.core.api.AssertionsForInterfaceTypes.assertThat;

/**
 * íŠ¸ëœì­ì…˜ - ì»¤ë„¥ì…˜ íŒŒë¼ë¯¸í„° ì „ë‹¬ ë°©ì‹ ë™ê¸°í™”
 */
class MemberServiceV3_1Test {
    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    private MemberRepositoryV3 memberRepository;
    private MemberServiceV3_1 memberService;

    @BeforeEach
    void before() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        memberRepository = new MemberRepositoryV3(dataSource);
        // ğŸ’¡ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ìƒì„± ì‹œ, DataSourceë¥¼ ë„˜ê²¨ì¤˜ì•¼í•¨
        PlatformTransactionManager transactionManager = new DataSourceTransactionManager(dataSource);
        memberService = new MemberServiceV3_1(transactionManager, memberRepository);
    }

    @AfterEach
    void after() throws SQLException {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        // Given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        // When
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);

        // Then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);
    }

    @Test
    @DisplayName("ì´ì²´ ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        // Given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEX = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEX);

        // When
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEX.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        // Then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEX = memberRepository.findById(memberEX.getMemberId());

        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberEX.getMoney()).isEqualTo(10000);
    }
}
```

```java
    private MemberRepositoryV3 memberRepository;
    private MemberServiceV3_1 memberService;

    @BeforeEach
    void before() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        memberRepository = new MemberRepositoryV3(dataSource);
        // ğŸ’¡ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ìƒì„± ì‹œ, DataSourceë¥¼ ë„˜ê²¨ì¤˜ì•¼í•¨
        PlatformTransactionManager transactionManager = new DataSourceTransactionManager(dataSource);
        memberService = new MemberServiceV3_1(transactionManager, memberRepository);
    }
```
  - new DataSourceTransactionManager(dataSource)
    + JDBC ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, JDBCìš© íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €(DataSourceTransactionManager)ë¥¼ ì„ íƒí•´ì„œ ì„œë¹„ìŠ¤ì— ì£¼ì…
    + íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” ë°ì´í„° ì†ŒìŠ¤ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ë¯€ë¡œ, DataSourceê°€ í•„ìš”
  
