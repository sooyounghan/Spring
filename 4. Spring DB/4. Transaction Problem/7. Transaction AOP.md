-----
### Transaction AOP(Aspect Oriented Programming)
-----
1. ì„œë¹„ìŠ¤ ê³„ì¸µì— ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ê²¨ì•¼ í•˜ëŠ” ë¬¸ì œ ë°œìƒ
2. ìŠ¤í”„ë§ AOPë¥¼ í†µí•´ 'í”„ë¡ì‹œ'ë¥¼ ë„ì…í•˜ë©´, ë¬¸ì œ í•´ê²° ê°€ëŠ¥
   - @Transactionalì„ ì‚¬ìš©í•˜ë©´ ìŠ¤í”„ë§ì´ AOPë¥¼ ì‚¬ìš©í•´ íŠ¸ëœì­ì…˜ì„ í¸ë¦¬í•˜ê²Œ ì²˜ë¦¬í•´ì¤Œ

-----
### í”„ë¡ì‹œë¥¼ í†µí•œ ë¬¸ì œ í•´ê²°
-----
1. í”„ë¡ì‹œ ë„ì… ì „
<div align="center">
<img src="https://github.com/sooyounghan/Spring/assets/34672301/7f23ddfd-f54a-437d-92c7-2269d2f3e76a">
</div>

  - ê¸°ì¡´ì²˜ëŸ¼ ì„œë¹„ìŠ¤ ë¡œì§ì—ì„œ íŠ¸ëœì­ì…˜ì„ ì§ì ‘ ì‹œì‘
```java
// íŠ¸ëœì­ì…˜ ì‹œì‘
TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

try {
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
    bizLogic(fromId, toId, money);
    transactionManager.commit(status); // ì„±ê³µ ì‹œ ì»¤ë°‹
} catch(Exception e) {
    transactionManager.rollback(status); // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
    throw new IllegalStateException(e);
}
```

2. í”„ë¡ì‹œ ë„ì… í›„
<div align="center">
<img src="https://github.com/sooyounghan/Spring/assets/34672301/09424216-333b-4ef3-b81c-caf8e3fa87ac">
</div>

  - ğŸ’¡ í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ë©´, íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ê°ì²´ì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ ê°ì²´ë¥¼ ëª…í™•í•˜ê²Œ ë¶„ë¦¬ ê°€ëŠ¥
```java
public class TransactionProxy {

    private MemberService target;

    public void logic() {
        // íŠ¸ëœì­ì…˜ ì‹œì‘
        TransactionStatus status = transactionManager.getTransaction(...);
        
        try {
            // ì‹¤ì œ ëŒ€ìƒ í˜¸ì¶œ
            target.logic();
            transactionManager.commit(status); // ì„±ê³µ ì‹œ ì»¤ë°‹
        } catch(Exception e) {
            transactionManager.rollback(status); // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
            throw new IllegalStateException(e);
        }
    }
}
```
  - íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ì ìš© í›„ ì„œë¹„ìŠ¤ ì½”ë“œ ì˜ˆì‹œ
```java
public class Service {
    public void logic() {
      // íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œ ì œê±°, ìˆœìˆ˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ìŒ
      bizLogic(fromId, toId, money);
    }
}
```
3. í”„ë¡ì‹œ ë„ì… ì „ : ì„œë¹„ìŠ¤ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¡œì§ì´ í•¨ê»˜ í˜¼í•©
4. í”„ë¡ì‹œ ë„ì… í›„ : íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¡œì§ì„ ëª¨ë‘ ê°€ì ¸ê°
   - íŠ¸ëœì­ì…˜ ì‹œì‘í•œ í›„ ì‹¤ì œ ì„œë¹„ìŠ¤ë¥¼ ëŒ€ì‹  í˜¸ì¶œ
   - ì¦‰, ì´ ë•ë¶„ì— ì„œë¹„ìŠ¤ ê³„ì¸µì—ëŠ” ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ìŒ

-----
### ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ AOP
-----
1. ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” AOP ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ í”„ë¡ì‹œë¥¼ ë§¤ìš° í¸ë¦¬í•˜ê²Œ ì ìš© ê°€ëŠ¥ (@Asepect, @Advice, @Pointcutë¥¼ ì‚¬ìš©í•´ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ìš© AOPë¥¼ ì–´ë–»ê²Œ ë§Œë“¤ì–´ì•¼í• ì§€ ì •í•¨)
2. ë¬¼ë¡ , ìŠ¤í”„ë§ AOPë¥¼ ì§ì ‘ ì‚¬ìš©í•´ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•´ë„ ë˜ì§€ë§Œ, íŠ¸ëœì­ì…˜ì€ ë§¤ìš° ì¤‘ìš”í•œ ê¸°ëŠ¥ì´ë©°, ëˆ„êµ¬ë‚˜ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥
   - ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ AOPë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ëª¨ë“  ê¸°ëŠ¥ ì œê³µ
   - ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¸ëœì­ì…˜ AOPë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ìŠ¤í”„ë§ ë¹ˆë“¤ë„ ìë™ ë“±ë¡
3. ë”°ë¼ì„œ, íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œ ê³³ì— @Transactional ì• ë„ˆí…Œì´ì…˜ë§Œ ë¶™ì—¬ì£¼ë©´ ë¨
   - ğŸ’¡ ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ AOPëŠ” ì´ ì• ë„ˆí…Œì´ì…˜ì„ ì¸ì‹í•´ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ì ìš©

-----
### @Transactional
-----
1. org.springframework.transaction.annotation.Transactional
2. ìŠ¤í”„ë§ AOPë¥¼ ì ìš©í•˜ë©´ ì–´ë“œë°”ì´ì €, í¬ì¸íŠ¸ì»·, ì–´ë“œë°”ì´ìŠ¤ê°€ í•„ìš”
   - ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ AOPë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ë‹¤ìŒ í´ë˜ìŠ¤ ì œê³µí•˜ë¯€ë¡œ, ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ ë¹ˆë“¤ì€ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìë™ ë“±ë¡

3. ì–´ë“œë°”ì´ì € : BeanFactoryTransactionAttributeSourceAdvisor
4. í¬ì¸íŠ¸ì»· : TransactionAttributeSourcePointcut
5. ì–´ë“œë°”ì´ìŠ¤ : TranscactionInterceptor

-----
### ì ìš©
-----
1. íŠ¸ëœì­ì…˜ AOPë¥¼ ì‚¬ìš©í•˜ëŠ” ì„œë¹„ìŠ¤ í´ë˜ìŠ¤
```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.annotation.Transactional;

import java.sql.SQLException;

/**
 * íŠ¸ëœì­ì…˜ - @Transactional AOP
 */
@Slf4j
@RequiredArgsConstructor
public class MemberServiceV3_3 {

    private final MemberRepositoryV3 memberRepository;

    // íŠ¸ëœì­ì…˜ AOP ì´ìš©
    @Transactional
    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        bizLogic(fromId, toId, money);
    }

    private static void validation(Member toMember) {
        if(toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

    private void bizLogic( String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(toId, toMember.getMoney() + money);
    }
}
```
  - ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ê¸°ê³ , íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œ ëª¨ë‘ ì œê±°
  - ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ AOPë¥¼ ì ìš©í•˜ê¸° ìœ„í•´ @Transactional ì• ë„ˆí…Œì´ì…˜ ì¶”ê°€

2. @Transactional ì• ë„ˆí…Œì´ì…˜ì€ ë©”ì„œë“œì— ë¶™ì—¬ë„ë˜ê³ , í´ë˜ìŠ¤ì— ë¶™ì—¬ë„ ë¨
   - í´ë˜ìŠ¤ì— ë¶™ì´ë©´, ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•œ public ë©”ì„œë“œê°€ AOPê°€ ì ìš© ëŒ€ìƒì´ ë¨

-----
###  í…ŒìŠ¤íŠ¸ ì½”ë“œ
-----
```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.extern.slf4j.Slf4j;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.aop.support.AopUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.transaction.PlatformTransactionManager;

import javax.sql.DataSource;
import java.sql.SQLException;

import static hello.jdbc.connection.ConnectionConst.*;
import static org.assertj.core.api.AssertionsForClassTypes.assertThatThrownBy;
import static org.assertj.core.api.AssertionsForInterfaceTypes.assertThat;

/**
 * íŠ¸ëœì­ì…˜ - @Transactional AOP
 */
@Slf4j
@SpringBootTest // í…ŒìŠ¤íŠ¸ ë‚´ì—ì„œ ìŠ¤í”„ë§ ë¶€íŠ¸ ì ìš©
class MemberServiceV3_3Test {
    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    @Autowired // ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë˜ë¯€ë¡œ, ìŠ¤í”„ë§ ë¹ˆì„ í†µí•œ ì˜ì¡´ ê´€ê³„ ìë™ ì£¼ì…
    MemberRepositoryV3 memberRepository;
    @Autowired
    MemberServiceV3_3 memberService;

    @TestConfiguration // ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆ ë‚´ ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¡°ì„±
    static class TestConfig {
        @Bean // DataSource ë¹ˆ ë“±ë¡
        DataSource dataSource() {
            return new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        }

        @Bean // íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ë¹ˆ ë“±ë¡
        PlatformTransactionManager transactionManager() {
            return new DataSourceTransactionManager(dataSource());
        }

        @Bean // memberRepositoryV3 ë“±ë¡
        MemberRepositoryV3 memberRepositoryV3() {
            return new MemberRepositoryV3(dataSource());
        }

        @Bean // memberServiceV3_3 ë“±ë¡
        MemberServiceV3_3 memberServiceV3_3() {
            return new MemberServiceV3_3(memberRepositoryV3());
        }
    }

    @AfterEach
    void after() throws SQLException {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    @Test
    void AopCheck() {
        log.info("memberService class={}", memberService.getClass());
        log.info("memberRepository class={}", memberRepository.getClass());
        Assertions.assertThat(AopUtils.isAopProxy(memberService)).isTrue();
        Assertions.assertThat(AopUtils.isAopProxy(memberRepository)).isFalse();
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        // Given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        // When
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);

        // Then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());
        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);
    }

    @Test
    @DisplayName("ì´ì²´ ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        // Given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEX = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEX);

        // When
        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEX.getMemberId(), 2000))
                .isInstanceOf(IllegalStateException.class);

        // Then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEX = memberRepository.findById(memberEX.getMemberId());

        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberEX.getMoney()).isEqualTo(10000);
    }
}
```
1. @SpringBootTest
  - ìŠ¤í”„ë§ AOPë¥¼ ì ìš©í•˜ë ¤ë©´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ í•„ìš”
  - ì´ ì• ë„ˆí…Œì´ì…˜ì€ í…ŒìŠ¤íŠ¸ ì‹œ ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ í†µí•´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±
  - í…ŒìŠ¤íŠ¸ì—ì„œ @Autowiredë¥¼ í†µí•´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ê´€ë¦¬í•˜ëŠ” ë¹ˆë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

2. @TestConfiguration
  - í…ŒìŠ¤íŠ¸ ì•ˆì—ì„œ ë‚´ë¶€ ì„¤ì • í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•˜ë©´ì„œ ì´ ì• ë„ˆí…Œì´ì…˜ì„ ë¶™ì´ë©´, ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ë¹ˆë“¤ì— ì¶”ê°€ë¡œ í•„ìš”í•œ ìŠ¤í”„ë§ ë¹ˆë“¤ì„ ë“±ë¡í•˜ê³  í…ŒìŠ¤íŠ¸ ìˆ˜í–‰ ê°€ëŠ¥

3. TestConfig
   - DataSource ìŠ¤í”„ë§ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•  ë°ì´í„° ì†ŒìŠ¤ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡
   - ì¶”ê°€ì ìœ¼ë¡œ, íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì—ì„œë„ ì‚¬ìš©
   - DataSourceTransactionManager íŠ¸ëœì­ì…˜ ë§¤ë„ˆì§€ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡
     + ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ AOPëŠ” ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡ëœ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì°¾ì•„ì„œ ì‚¬ìš©í•˜ë¯€ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì•¼ í•¨

4. AOP í”„ë¡ì‹œ ì ìš© í™•ì¸
```java
@Test
void AopCheck() {
    log.info("memberService class={}", memberService.getClass());
    log.info("memberRepository class={}", memberRepository.getClass());
    Assertions.assertThat(AopUtils.isAopProxy(memberService)).isTrue();
    Assertions.assertThat(AopUtils.isAopProxy(memberRepository)).isFalse();
}
```
<div align="center">
<img src="https://github.com/sooyounghan/Spring/assets/34672301/4bf40cd3-9b54-4eb1-8bc0-6f7fdc4fb27f">
</div>

  - AopCheck()ì˜ ì‹¤í–‰ ê²°ê³¼ë¥¼ ë³´ë©´, memberServiceì— EnhancerBySpringCGLIB.. ë¼ëŠ” ë¶€ë¶„ì„ í†µí•´ í”„ë¡ì‹œ(CGLIB)ê°€ ì ìš©ëœ ê²ƒ í™•ì¸ ê°€ëŠ¥
  - memberRepositoryì—ëŠ” AOPê°€ ì ìš©í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ í”„ë¡ì‹œê°€ ì ìš©ë˜ì§€ ì•ŠìŒ

