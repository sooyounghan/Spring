-----
### ìŠ¤í”„ë§ ë°ì´í„° í˜ì´ì§• í™œìš© 1 - Querydsl í˜ì´ì§• ì—°ë™
-----
1. ìŠ¤í”„ë§ ë°ì´í„°ì˜ Page, Pageable í™œìš©
2. ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ í•œ ë²ˆì— ì¡°íšŒí•˜ëŠ” ë‹¨ìˆœí•œ ë°©ë²•
3. ë°ì´í„° ë‚´ìš©ê³¼ ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ ë³„ë„ë¡œ ì¡°íšŒí•˜ëŠ” ë°©ë²•
4. ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ì— í˜ì´ì§• 2ê°€ì§€ ì¶”ê°€
```java
package study.querydsl.repository;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import study.querydsl.dto.MemberSearchCondition;
import study.querydsl.dto.MemberTeamDto;

import java.util.List;

public interface MemberRepositoryCustom {
    List<MemberTeamDto> search(MemberSearchCondition condition);
    
    Page<MemberTeamDto> searchPageSimple(MemberSearchCondition condition, Pageable pageable);
    Page<MemberTeamDto> searchPageComplex(MemberSearchCondition condition, Pageable pageable);
}
```

5. ì „ì²´ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì¡°íšŒí•˜ëŠ” ë‹¨ìˆœí•œ ë°©ë²•
   - searchPageSimple(), fetchResults() ì‚¬ìš©
```java
@Override
public Page<MemberTeamDto> searchPageSimple(MemberSearchCondition condition, Pageable pageable) {
    QueryResults<MemberTeamDto> results = queryFactory
            .select(
                    new QMemberTeamDto(
                            member.id,
                            member.username,
                            member.age,
                            team.id,
                            team.name
                    )
            )
            .from(member)
            .join(member.team, team)
            .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe())
            )
            .offset(pageable.getOffset()) // offset
            .limit(pageable.getPageSize()) // limit
            .fetchResults();

    List<MemberTeamDto> content = results.getResults();
    long total = results.getTotal();

    return new PageImpl<>(content, pageable, total); // Page<T>ì˜ êµ¬í˜„ì²´
}
```
  - ğŸ’¡ Querydslì´ ì œê³µí•˜ëŠ” fetchResults()ë¥¼ ì‚¬ìš©í•˜ë©´ ë‚´ìš©ê³¼ ì „ì²´ ì¹´ìš´íŠ¸ í•œ ë²ˆì— ì¡°íšŒ ê°€ëŠ¥
  - ğŸ’¡ fetchResults()ëŠ” ì¹´ìš´íŠ¸ ì¿¼ë¦¬ ì‹¤í–‰ ì‹œ í•„ìš”ì—†ëŠ” ORDER BY ì œê±°

```java
@Test
public void searchPageSimple() {
    Team teamA = new Team("teamA");
    Team teamB = new Team("teamB");
    em.persist(teamA);
    em.persist(teamB);

    Member member1 = new Member("member1", 10, teamA);
    Member member2 = new Member("member2", 20, teamA);
    Member member3 = new Member("member3", 30, teamB);
    Member member4 = new Member("member4", 40, teamB);
    em.persist(member1);
    em.persist(member2);
    em.persist(member3);
    em.persist(member4);

    MemberSearchCondition condition = new MemberSearchCondition();
    PageRequest pageRequest = PageRequest.of(0, 3);

    Page<MemberTeamDto> result = memberRepository.searchPageSimple(condition, pageRequest);

    Assertions.assertThat(result.getSize()).isEqualTo(3);
    Assertions.assertThat(result.getContent()).extracting("username").containsExactly("member1", "member2", "member3");
}
```

6. ë°ì´í„° ë‚´ìš©ê³¼ ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ ë³„ë„ë¡œ ì¡°íšŒí•˜ëŠ” ë°©ë²•
```java
/**
 * ë³µì¡í•œ í˜ì´ì§•
 * - ë°ì´í„° ì¡°íšŒ ì¿¼ë¦¬ì™€, ì „ì²´ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬
 */
@Override
public Page<MemberTeamDto> searchPageComplex(MemberSearchCondition condition, Pageable pageable) {
    List<MemberTeamDto> content = queryFactory
            .select(
                    new QMemberTeamDto(
                            member.id,
                            member.username,
                            member.age,
                            team.id,
                            team.name
                    )
            )
            .from(member)
            .join(member.team, team)
            .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe())
            )
            .offset(pageable.getOffset()) // offset
            .limit(pageable.getPageSize()) // limit
            .fetch(); // fetch

    long total = queryFactory.select(member)
            .from(member)
            // .leftJoin(member.team, team)
            .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe())
            )
            .offset(pageable.getOffset()) // offset
            .limit(pageable.getPageSize()) // limit
            .fetchCount(); // fetchCount

    return new PageImpl<>(content, pageable, total);
}
```
  - ğŸ’¡ ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ ì¡°íšŒí•˜ëŠ” ë°©ë²•ì„ ìµœì í™”í•  ìˆ˜ ìˆìœ¼ë©´ ì´ë ‡ê²Œ ë¶„ë¦¬í•˜ë©´ ë¨
    + ì˜ˆ) ğŸ’¡ ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ ì¡°íšŒí•  ë•Œ, ì¡°ì¸ ì¿¼ë¦¬ë¥¼ ì¤„ì¼ ìˆ˜ ìˆë‹¤ë©´ ìƒë‹¹í•œ íš¨ê³¼ ì¡´ì¬
  - ì½”ë“œë¥¼ ë¦¬íŒ©í† ë§í•´ì„œ ë‚´ìš© ì¿¼ë¦¬ì™€ ì „ì²´ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ ì½ê¸° ì¢‹ê²Œ ë¶„ë¦¬í•˜ë©´ ì¢‹ìŒ

-----
### ìŠ¤í”„ë§ ë°ì´í„° í˜ì´ì§• í™œìš© 2 - CountQuery ìµœì í™”
-----
1. PageableExecutionUtils.getPage()ë¡œ ìµœì í™”
```java
/**
 * ë³µì¡í•œ í˜ì´ì§•
 * - ë°ì´í„° ì¡°íšŒ ì¿¼ë¦¬ì™€, ì „ì²´ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬
 */
@Override
public Page<MemberTeamDto> searchPageComplex(MemberSearchCondition condition, Pageable pageable) {
    List<MemberTeamDto> content = queryFactory
            .select(
                    new QMemberTeamDto(
                            member.id,
                            member.username,
                            member.age,
                            team.id,
                            team.name
                    )
            )
            .from(member)
            .join(member.team, team)
            .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe())
            )
            .offset(pageable.getOffset()) // offset
            .limit(pageable.getPageSize()) // limit
            .fetch();

    /*
    long total = queryFactory.select(member)
            .from(member)
            // .leftJoin(member.team, team)
            .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe())
            )
            .offset(pageable.getOffset()) // offset
            .limit(pageable.getPageSize()) // limit
            .fetchCount();
    */

    JPAQuery<Member> countQuery = queryFactory.select(member)
            .from(member)
            // .leftJoin(member.team, team)
            .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe())
            );

    // return new PageImpl<>(content, pageable, total);
    return PageableExecutionUtils.getPage(content, pageable, countQuery::fetchCount);
}
```
  - ìŠ¤í”„ë§ ë°ì´í„° ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì œê³µ

2. ğŸ’¡ COUNT ì¿¼ë¦¬ê°€ ìƒëµ ê°€ëŠ¥í•œ ê²½ìš° ìƒëµí•´ì„œ ì²˜ë¦¬
  - ğŸ’¡ í˜ì´ì§€ ì‹œì‘ì´ë©´ì„œ ì»¨í…ì¸  ì‚¬ì´ì¦ˆê°€ í˜ì´ì§€ ì‚¬ì´ì¦ˆë³´ë‹¤ ì‘ì„ ë•Œ
  - ğŸ’¡ ë§ˆì§€ë§‰ í˜ì´ì§€ ì¼ ë•Œ (Offset + ì½˜í…ì¸  ì‚¬ì´ì¦ˆë¥¼ ë”í•´ì„œ ì „ì²´ ì‚¬ì´ì¦ˆë¥¼ êµ¬í•¨)
    + ğŸ’¡ ë” ì •í™•íˆëŠ” ë§ˆì§€ë§‰ í˜ì´ì§€ë©´ì„œ ì½˜í…ì¸  ì‚¬ì´ì¦ˆê°€ í˜ì´ì§€ ì‚¬ì´ì¦ˆë³´ë‹¤ ì‘ì„ ë•Œ

-----
### ìŠ¤í”„ë§ ë°ì´í„° í˜ì´ì§• í™œìš© 3 - ì»¨íŠ¸ë¡¤ëŸ¬ ê°œë°œ
-----
1. ì‹¤ì œ ì»¨íŠ¸ë¡¤ëŸ¬
```java
package study.querydsl.controller;

import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import study.querydsl.dto.MemberSearchCondition;
import study.querydsl.dto.MemberTeamDto;
import study.querydsl.repository.MemberJpaRepository;
import study.querydsl.repository.MemberRepository;

import java.util.List;

@RestController
@RequiredArgsConstructor
public class MemberController {
    private final MemberJpaRepository memberJpaRepository;
    private final MemberRepository memberRepository;

    @GetMapping("/v1/members")
    public List<MemberTeamDto> searchMemberV1(MemberSearchCondition condition) {
        return memberJpaRepository.search(condition);
    }

    @GetMapping("/v2/members")
    public Page<MemberTeamDto> searchMemberV2(MemberSearchCondition condition, Pageable pageable) {
        return memberRepository.searchPageSimple(condition, pageable);
    }

    @GetMapping("/v3/members")
    public Page<MemberTeamDto> searchMemberV3(MemberSearchCondition condition, Pageable pageable) {
        return memberRepository.searchPageComplex(condition, pageable);
    }
}
```
  - http://localhost:9090/v2/members?size=5&page=2
  - http://localhost:9090/v2/members?size=200&page=0 : TotalCount ì¿¼ë¦¬ê°€ í•„ìš” ì—†ìŒ (ì²« í˜ì´ì§€ì— ëª¨ë“  í˜ì´ì§€ ì¶œë ¥)

-----
### ìŠ¤í”„ë§ ë°ì´í„° ì •ë ¬ (Sort)
-----
1. ğŸ’¡ ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ìì‹ ì˜ ì •ë ¬(Sort)ë¥¼ Querydslì˜ ì •ë ¬(OrderSpecifier)ë¡œ í¸ë¦¬í•˜ê²Œ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥ ì œê³µ
2. ìŠ¤í”„ë§ ë°ì´í„°ì˜ ì •ë ¬ì„ Querydslì˜ ì •ë ¬ë¡œ ì§ì ‘ ì „í™˜í•˜ëŠ” ë°©ë²•
   - ìŠ¤í”„ë§ ë°ì´í„° Sortë¥¼ Querydslì˜ OrderSpecifierë¡œ ë³€í™˜
```java
JPAQuery<Member> query = queryFactory
        .selectFrom(member);

for (Sort.Order o : pageable.getSort()) {
    PathBuilder pathBuilder = new PathBuilder(member.getType(), member.getMetadata());
    query.orderBy(new OrderSpecifier(o.isAscending() ? Order.ASC : Order.DESC, pathBuilder.get(o.getProperty())));
}

List<Member> result = query.fetch();
```

3. ğŸ’¡ ì°¸ê³  : ì •ë ¬(Sort)ì€ ì¡°ê±´ì´ ì¡°ê¸ˆë§Œ ë³µì¡í•´ì ¸ë„ Pageableì˜ Sort ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ì›€
   - ğŸ’¡ ë£¨íŠ¸ ì—”í‹°í‹°ì˜ ë²”ìœ„ë¥¼ ë„˜ì–´ê°€ëŠ” ë™ì  ì •ë ¬ ê¸°ëŠ¥ì´ í•„ìš”í•˜ë©´(ì˜ˆ) Join ì‚¬ìš©) ìŠ¤í”„ë§ ë°ì´í„° í˜ì´ì§•ì´ ì œê³µí•˜ëŠ” Sortë¥¼ ì‚¬ìš©í•˜ê¸° ë³´ë‹¤ëŠ” íŒŒë¼ë¯¸í„°ë¥¼ ë°›ì•„ì„œ ì§ì ‘ ì²˜ë¦¬í•˜ëŠ” ê²ƒ ê¶Œì¥
