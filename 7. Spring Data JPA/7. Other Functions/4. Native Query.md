-----
### ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬
-----
1. ê°€ê¸‰ì  ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ìŒ (ì •ë§ ì–´ì©” ìˆ˜ ì—†ì„ ë•Œ ì‚¬ìš©)
2. ìµœê·¼ì˜ ë‚˜ì˜¨ Spring Data Jpa - Projections í™œìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
3. ìŠ¤í”„ë§ ë°ì´í„° JPA ê¸°ë°˜ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬
   - í˜ì´ì§• ì§€ì›
   - ë°˜í™˜ íƒ€ì…
     + Object[]
     + Tuple
     + DTO(ìŠ¤í”„ë§ ë°ì´í„° ì¸í„°í˜ì´ìŠ¤ Projections ì§€ì›)
   - ì œì•½
     + Sort íŒŒë¼ë¯¸í„°ë¥¼ í†µí•œ ì •ë ¬ì´ ì •ìƒ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì§ì ‘ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
     + JPQL ì²˜ëŸ¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ë¬¸ë²• í™•ì¸ ë¶ˆê°€
     + ë™ì  ì¿¼ë¦¬ ë¶ˆê°€

4. JPA ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ SQL ì§€ì›
```java
package study.data_jpa.repository;

import jakarta.persistence.LockModeType;
import jakarta.persistence.QueryHint;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Slice;
import org.springframework.data.jpa.repository.*;
import org.springframework.data.repository.query.Param;
import study.data_jpa.dto.MemberDto;
import study.data_jpa.entity.Member;

import java.util.Collection;
import java.util.List;
import java.util.Optional;

public interface MemberRepository extends JpaRepository<Member, Long>, MemberRepositoryCustom, JpaSpecificationExecutor<Member> {

    ...

    @Query(value = "SELECT * FROM member WHERE username = ?", nativeQuery = true)
    Member findByNativeQuery(String username);
}
```
```java
@Test
public void nativeQuery() {
    // Given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member m1 = new Member("m1", 0, teamA);
    Member m2 = new Member("m2", 0, teamA);
    em.persist(m1);
    em.persist(m2);

    em.flush();
    em.clear();

    // When
    Member result = memberRepository.findByNativeQuery("m1");
    System.out.println("result = " + result);
}
```

  - ğŸ’¡ JPQLì€ ìœ„ì¹˜ ê¸°ë°˜ íŒŒë¼ë¯¸í„°ë¥¼ 1ë¶€í„° ì‹œì‘í•˜ì§€ë§Œ, ë„¤ì´í‹°ë¸Œ SQLì€ 0ë¶€í„° ì‹œì‘
  - ë„¤ì´í‹°ë¸Œ SQLì„ ì—”í‹°í‹°ê°€ ì•„ë‹Œ DTOë¡œ ë°˜í™˜í•˜ë ¤ë©´,
    + DTO ëŒ€ì‹  JPA TUPLE ì¡°íšŒ
    + DTO ëŒ€ì‹  MAP ì¡°íšŒ
    + @SqlResultSetMapping : ë³µì¡
    + Hibernate ResultTransformerë¥¼ ì‚¬ìš© : ë³µì¡
    + https://vladmihalcea.com/the-best-way-to-map-a-projection-query-to-a-dto-with-jpa-and-hibernate/
  - ğŸ’¡ ë„¤ì´í‹°ë¸Œìš© SQLì„ DTOë¡œ ì¡°íšŒí•  ë•ŒëŠ” JdbcTemplate ë˜ëŠ” MyBatis ê¶Œì¥

5. Projections í™œìš©
  - ì˜ˆ) ìŠ¤í”„ë§ ë°ì´í„° JPA ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ + ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ Projection í™œìš©
  - MemberProjection
```java
package study.data_jpa.repository;

public interface MemberProjection {

    Long getId();
    String getUsername();
    String getTeamName();
    
}
```
```java
@Query(value = "SELECT m.member_id as id, m.username, t.name as teamName "
                + "FROM member m LEFT JOIN team t ON m.team_id = t.team_id",
        countQuery = "SELECT COUNT(*) FROM member",
        nativeQuery = true)
Page<MemberProjection> findByNativeProjection(Pageable pageable);
```
```java
@Test
public void nativeQueryProjection() {
    // Given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member m1 = new Member("m1", 0, teamA);
    Member m2 = new Member("m2", 0, teamA);
    em.persist(m1);
    em.persist(m2);

    em.flush();
    em.clear();

    // When
    Page<MemberProjection> result = memberRepository.findByNativeProjection(PageRequest.of(0, 10));
    List<MemberProjection> content = result.getContent();
    for (MemberProjection memberProjection : content) {
        System.out.println("memberProjection.username = " + memberProjection.getUsername());
        System.out.println("memberProjection.teamName = " + memberProjection.getTeamName());
    }
}
```
```
SELECT
    m.member_id as id,
    m.username,
    t.name as teamName 
FROM
    member m 
LEFT JOIN
    team t 
        ON m.team_id = t.team_id 
offset
    ? rows 
fetch
    next ? rows only

SELECT
    COUNT(*) 
FROM
    member
```

6. ë™ì  ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬
   - í•˜ì´ë²„ë„¤ì´íŠ¸ ì§ì ‘ í™œìš©
   - ìŠ¤í”„ë§ JdbcTemplate, MyBatis, JOOQì™€ ê°™ì€ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
   - ì˜ˆ) í•˜ì´ë²„ë„¤ì´íŠ¸ ê¸°ëŠ¥ ì‚¬ìš©
```java
 @Test
public void nativeQueryHibernate() {
    // Given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member m1 = new Member("m1", 0, teamA);
    Member m2 = new Member("m2", 0, teamA);
    em.persist(m1);
    em.persist(m2);

    em.flush();
    em.clear();

    String sql = "SELECT m.username AS username FROM member m";
            
    // When
    List<MemberDto> result = em.createNativeQuery(sql)
                                .setFirstResult(0)
                                .setMaxResults(10)
                                .unwrap(NativeQuery.class)
                                .addScalar("username")
                                .setResultListTransformer(Transformers.aliasToBean(MemberDto.class))
                                .getResultList();

    for (MemberDto memberDto : result) {
        System.out.println("memberDto.username = " + memberDto.getUsername());
        System.out.println("memberDto.teamName = " + memberDto.getTeamName());
    }
}
```
