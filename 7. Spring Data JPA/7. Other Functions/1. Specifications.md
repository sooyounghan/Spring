-----
### Spcifications (ëª…ì„¸)
-----
1. ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„ (Domain Driven Design) ì±… ì—ì„œëŠ” Specification(ëª…ì„¸)ë¼ëŠ” ê°œë… ì†Œê°œ
2. ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” JPA Criteriaë¥¼ í™œìš©í•´ ì´ ê°œë…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›
3. ìˆ ì–´(Predicate)
   - ì°¸ ë˜ëŠ” ê±°ì§“ìœ¼ë¡œ í‰ê°€
   - AND, OR ê°™ì€ ì—°ì‚°ìë¥¼ ì¡°í•©í•´ì„œ ë‹¤ì–‘í•œ ê²€ìƒ‰ì¡°ê±´ì„ ì‰½ê²Œ ìƒì„± (Composite íŒ¨í„´)
   - ì˜ˆ) ê²€ìƒ‰ ì¡°ê±´ í•˜ë‚˜í•˜ë‚˜
   - ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” org.springframework.data.jpa.domain.Specification í´ë˜ìŠ¤
  
4. ëª…ì„¸ ê¸°ëŠ¥ ì‚¬ìš© ë°©ë²•
```java
public interface MemberRepository extends JpaRepository<Member, Long>,
                                             JpaSpecificationExecutor<Member> {
}
```

  - JpaSpecificationExecutor ì¸í„°í˜ì´ìŠ¤
```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by FernFlower decompiler)
//

package org.springframework.data.jpa.repository;

import java.util.List;
import java.util.Optional;
import java.util.function.Function;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.data.repository.query.FluentQuery;
import org.springframework.lang.Nullable;

public interface JpaSpecificationExecutor<T> {

    Optional<T> findOne(Specification<T> spec);
    List<T> findAll(@Nullable Specification<T> spec);
    Page<T> findAll(@Nullable Specification<T> spec, Pageable pageable);
    List<T> findAll(@Nullable Specification<T> spec, Sort sort);
    long count(@Nullable Specification<T> spec);

    boolean exists(Specification<T> spec);
    long delete(@Nullable Specification<T> spec);
    <S extends T, R> R findBy(Specification<T> spec, Function<FluentQuery.FetchableFluentQuery<S>, R> queryFunction);
}
```
  - Specificationì„ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©

5. MemberSpec ëª…ì„¸ ì •ì˜ ì½”ë“œ
```java
package study.data_jpa.repository;

import jakarta.persistence.criteria.*;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.util.StringUtils;
import study.data_jpa.entity.Member;
import study.data_jpa.entity.Team;

public class MemberSpec {
    public static Specification<Member> teamName(final String teamName) {
        return new Specification<Member>() {
            @Override
            public Predicate toPredicate(Root<Member> root, CriteriaQuery<?> query, CriteriaBuilder criteriaBuilder) {

                if(StringUtils.isEmpty(teamName)) {
                    return null;
                }

                Join<Member, Team> t = root.join("team", JoinType.INNER);// íšŒì›ê³¼ ì¡°ì¸

                return criteriaBuilder.equal(t.get("name"), teamName);
            }
        };
    }

    public static Specification<Member> username(final String username) {
        return (Specification<Member>) (root, query, criteriaBuilder) -> 
                criteriaBuilder.equal(root.get("username"), username);
    };
}
```
  - ëª…ì„¸ë¥¼ ì •ì˜í•˜ë ¤ë©´ Specification ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„
  - ğŸ’¡ ëª…ì„¸ë¥¼ ì •ì˜í•  ë•ŒëŠ” toPredicate(...) ë©”ì„œë“œë§Œ êµ¬í˜„í•˜ë©´ ë˜ëŠ”ë°, JPA Criteriaì˜ Root, CriteriaQuery, CriteriaBuilder í´ë˜ìŠ¤ë¥¼ íŒŒë¼ã…£í„°ë¡œ ì œê³µ
  - í¸ì˜ìƒ ëŒë‹¤ ì‚¬ìš©
  - ğŸ’¡ ì‹¤ë¬´ì—ì„œëŠ” JPA Criteriaë¥¼ ê±°ì˜ ì•ˆì“°ë©°, ëŒ€ì‹  Querydsl ì‚¬ìš©
    
6. ëª…ì„¸ ì‚¬ìš© ì½”ë“œ
```java
@Test
public void specBasic() {
    // Given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member m1 = new Member("m1", 0, teamA);
    Member m2 = new Member("m2", 0, teamA);
    em.persist(m1);
    em.persist(m2);

    em.flush();
    em.clear();

    // When
    Specification<Member> spec = MemberSpec.username("m1").and(MemberSpec.teamName("teamA"));
    List<Member> result = memberRepository.findAll(spec);

    Assertions.assertThat(result.size()).isEqualTo(1);
}
```
  - Specificationì„ êµ¬í˜„í•˜ë©´ ëª…ì„¸ë“¤ì„ ì¡°ë¦½ ê°€ëŠ¥ (where(), and(), or(), not() ì œê³µ)
  - findAllì„ ë³´ë©´, íšŒì› ì´ë¦„ ëª…ì„¸(username)ì™€ íŒ€ ì´ë¦„ ëª…ì„¸(teamName)ë¥¼ andë¡œ ì¡°í•©í•´ì„œ ê²€ìƒ‰ìœ¼ë¡œ ì‚¬ìš©

```
select
    m1_0.member_id,
    m1_0.age,
    m1_0.create_date,
    m1_0.last_modified_date,
    m1_0.team_id,
    m1_0.username 
from
    member m1_0 
join
    team t1_0 
        on t1_0.team_id=m1_0.team_id 
where
    m1_0.username=? 
    and t1_0.name=?

select
    m1_0.member_id,
    m1_0.age,
    m1_0.create_date,
    m1_0.last_modified_date,
    m1_0.team_id,
    m1_0.username
from
    member m1_0 
join
    team t1_0 
        on t1_0.team_id=m1_0.team_id 
where
    m1_0.username='m1' 
    and t1_0.name='teamA';
```
