-----
### ğŸ’¡ Projections
-----
1. https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#projections
2. ì—”í‹°í‹° ëŒ€ì‹  DTOë¥¼ í¸ë¦¬í•˜ê²Œ ì¡°íšŒí•  ë•Œ ì‚¬ìš©
3. ì „ì²´ ì—”í‹°í‹°ê°€ ì•„ë‹Œ ë§Œì•½ íšŒì› ì´ë¦„ë§Œ ì¡°íšŒí•˜ê³  ì‹¶ë‹¤ë©´?
```java
package study.data_jpa.repository;

public interface UsernameOnly {
    String getUsername(); // getter
}
```
  - ì¡°íšŒí•  ì—”í‹°í‹°ì˜ í•„ë“œë¥¼ getter í˜•ì‹ì„ ì§€ì •í•˜ë©´ í•´ë‹¹ í•„ë“œë§Œ ì„ íƒí•´ì„œ ì¡°íšŒ(Projection)

```java
package study.data_jpa.repository;

import jakarta.persistence.LockModeType;
import jakarta.persistence.QueryHint;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Slice;
import org.springframework.data.jpa.repository.*;
import org.springframework.data.repository.query.Param;
import study.data_jpa.dto.MemberDto;
import study.data_jpa.entity.Member;

import java.util.Collection;
import java.util.List;
import java.util.Optional;

public interface MemberRepository extends JpaRepository<Member, Long>, MemberRepositoryCustom, JpaSpecificationExecutor<Member> {

    ...

    List<UsernameOnly> finProjectionsByUsername(@Param("username") String username);
}
```

  - ğŸ’¡ ë©”ì„œë“œ ì´ë¦„ì€ ììœ , ë°˜í™˜ íƒ€ì…ìœ¼ë¡œ ì¸ì§€

```java
@Test
public void projections() {
    // Given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member m1 = new Member("m1", 0, teamA);
    Member m2 = new Member("m2", 0, teamA);
    em.persist(m1);
    em.persist(m2);

    em.flush();
    em.clear();

    // When
    List<UsernameOnly> result = memberRepository.findProjectionsByUsername("m1");

    for (UsernameOnly usernameOnly : result) {
        System.out.println("usernameOnly = " + usernameOnly);
    }

    // Then
    Assertions.assertThat(result.size()).isEqualTo(1);
}
```
```
usernameOnly = org.springframework.data.jpa.repository.query.AbstractJpaQuery$TupleConverter$TupleBackedMap@1de36da2

select
    m1_0.username 
from
    member m1_0 
where
    m1_0.username=?

select
    m1_0.username 
from
    member m1_0 
where
    m1_0.username=m1
```
  - SQLì—ì„œë„ SELECT ì ˆì—ì„œ usernameë§Œ ì¡°íšŒ(Projection) í•˜ëŠ” ê²ƒ í™•ì¸

4. ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ Closed Projections
   - í”„ë¡œí¼í‹° í˜•ì‹(getter)ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ë©´, êµ¬í˜„ì²´ëŠ” ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ì œê³µ
   - ğŸ’¡ ì •í™•í•˜ê²Œ í•´ë‹¹ í”„ë¡œí¼í‹°ë§Œ ë§¤ì¹­
```java
package study.data_jpa.repository;

public interface UsernameOnly {
    String getUsername(); // getter
}
```

5. ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ Open Projections
   - ë‹¤ìŒê³¼ ê°™ì´ ìŠ¤í”„ë§ì˜ SpEL ë¬¸ë²•ë„ ì§€ì›
```java
package study.data_jpa.repository;

import org.springframework.beans.factory.annotation.Value;

public interface UsernameOnly {
    @Value("#{target.username + ' ' + target.age + ' ' + target.team.name}")
    String getUsername(); // getter
}
```
```
usernameOnly = Member(id=101, username=m1, age=0)

select
    m1_0.member_id,
    m1_0.age,
    m1_0.create_date,
    m1_0.last_modified_date,
    m1_0.team_id,
    m1_0.username 
from
    member m1_0 
where
    m1_0.username=?

select
    m1_0.member_id,
    m1_0.age,
    m1_0.create_date,
    m1_0.last_modified_date,
    m1_0.team_id,
    m1_0.username 
from
    member m1_0 
where
    m1_0.username='m1'
```
  - ğŸ’¡ SpELë¬¸ë²•ì„ ì‚¬ìš©í•˜ë©´, DBì—ì„œ ì—”í‹°í‹° í•„ë“œë¥¼ ë‹¤ ì¡°íšŒí•´ì˜¨ ë‹¤ìŒ ê³„ì‚°
  - JPQL SELECTì ˆ ìµœì í™”ê°€ ë˜ì§€ ì•ŠìŒ

6. í´ë˜ìŠ¤ ê¸°ë°˜ Proejection
  - ì¸í„°í˜ì´ìŠ¤ê°€ ì•„ë‹Œ êµ¬ì²´ì  DTO í˜•ì‹ë„ ê°€ëŠ¥
  - ğŸ’¡ ìƒì„±ìì˜ íŒŒë¼ë¯¸í„° ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­
```java
package study.data_jpa.repository;

public class UsernameOnlyDto {
    private final String username;

    public UsernameOnlyDto(String username) {
        this.username = username;
    }

    public String getUsername() {
        return username;
    }
}
```
```java
package study.data_jpa.repository;

import jakarta.persistence.LockModeType;
import jakarta.persistence.QueryHint;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Slice;
import org.springframework.data.jpa.repository.*;
import org.springframework.data.repository.query.Param;
import study.data_jpa.dto.MemberDto;
import study.data_jpa.entity.Member;

import java.util.Collection;
import java.util.List;
import java.util.Optional;

public interface MemberRepository extends JpaRepository<Member, Long>, MemberRepositoryCustom, JpaSpecificationExecutor<Member> {

    ...

    List<UsernameOnly> findProjectionsByUsername(@Param("username") String username);
    List<UsernameOnlyDto> findProjectionsDtoByUsername(@Param("username") String username);
}
```
```java
@Test
public void projections2() {
    // Given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member m1 = new Member("m1", 0, teamA);
    Member m2 = new Member("m2", 0, teamA);
    em.persist(m1);
    em.persist(m2);

    em.flush();
    em.clear();

    // When
    List<UsernameOnlyDto> result = memberRepository.findProjectionsDtoByUsername("m1");

    for (UsernameOnlyDto usernameOnlyDto : result) {
        System.out.println("usernameOnlyDto = " + usernameOnlyDto.getUsername());
    }

    // Then
    Assertions.assertThat(result.size()).isEqualTo(1);
}
```
```
usernameOnlyDto = m1

select
    m1_0.username
from
    member m1_0
where
    m1_0.username='m1';
```

7. ë™ì  Projections
   - ë‹¤ìŒê³¼ ê°™ì´ Generic Typeì„ ì£¼ë©´, ë™ì ìœ¼ë¡œ í”„ë¡œì ì…˜ ë°ì´í„° ë³€ê²½ ê°€ëŠ¥
```java
package study.data_jpa.repository;

import jakarta.persistence.LockModeType;
import jakarta.persistence.QueryHint;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Slice;
import org.springframework.data.jpa.repository.*;
import org.springframework.data.repository.query.Param;
import study.data_jpa.dto.MemberDto;
import study.data_jpa.entity.Member;

import java.util.Collection;
import java.util.List;
import java.util.Optional;

public interface MemberRepository extends JpaRepository<Member, Long>, MemberRepositoryCustom, JpaSpecificationExecutor<Member> {

    ...

    List<UsernameOnly> findProjectionsByUsername(@Param("username") String username);
    // List<UsernameOnlyDto> findProjectionsDtoByUsername(@Param("username") String username);
    <T> List<T> findProjectionsDtoByUsername(@Param("username") String username, Class<T> type);
}
```
  - ì‚¬ìš© ì½”ë“œ
```java
List<UsernameOnlyDto> result = memberRepository.findProjectionsDtoByUsername("m1", UsernameOnlyDto.class);
```

8. ì¤‘ì²© êµ¬ì¡° ì¿¼ë¦¬
```java
package study.data_jpa.repository;

public interface NestedClosedProjections {
    String getUsername();
    TeamInfo getTeam();
    
    interface TeamInfo {
        String getName();
    }
}
```
```java
@Test
public void projections3() {
    // Given
    Team teamA = new Team("teamA");
    em.persist(teamA);

    Member m1 = new Member("m1", 0, teamA);
    Member m2 = new Member("m2", 0, teamA);
    em.persist(m1);
    em.persist(m2);

    em.flush();
    em.clear();

    // When
    List<NestedClosedProjections> result = memberRepository.findProjectionsDtoByUsername("m1", NestedClosedProjections.class);

    for (NestedClosedProjections nestedClosedProjections : result) {
        System.out.println("nestedClosedProjections = " + nestedClosedProjections.getUsername());
        System.out.println("nestedClosedProjections = " + nestedClosedProjections.getTeam().getName());
    }

    // Then
    Assertions.assertThat(result.size()).isEqualTo(1);
}
```
```
nestedClosedProjections = m1
nestedClosedProjections = teamA

select
    m1_0.username,
    t1_0.team_id,
    t1_0.name 
from
    member m1_0 
left join
    team t1_0 
        on t1_0.team_id=m1_0.team_id 
where
    m1_0.username='m1'
```

9. ì£¼ì˜
  - ğŸ’¡ í”„ë¡œì ì…˜ ëŒ€ìƒì´ root ì—”í‹°í‹°ë©´, JPQL SELECT ì ˆ ìµœì í™” ê°€ëŠ¥
  - ğŸ’¡ í”„ë¡œì ì…˜ ëŒ€ìƒì´ ROOTê°€ ì•„ë‹ˆë©´,
    + ğŸ’¡ LEFT OUTER JOIN ì²˜ë¦¬
    + ğŸ’¡ ëª¨ë“  í•„ë“œë¥¼ SELECTí•´ì„œ ì—”í‹°í‹°ë¡œ ì¡°íšŒí•œ ë‹¤ìŒ ê³„ì‚°

10. ì •ë¦¬
  - í”„ë¡œì ì…˜ ëŒ€ìƒì´ root ì—”í‹°í‹°ë©´ ìœ ìš©
  - í”„ë¡œì ì…˜ ëŒ€ìƒì´ root ì—”í‹°í‹°ë¥¼ ë„˜ì–´ê°€ë©´ JPQL SELECT ìµœì í™”ê°€ ì•ˆ ë¨
  - ì‹¤ë¬´ì˜ ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ í•´ê²°í•˜ê¸°ì—ëŠ” í•œê³„ ì¡´ì¬
  - ì‹¤ë¬´ì—ì„œëŠ” ë‹¨ìˆœí•  ë•Œë§Œ ì‚¬ìš©í•˜ê³ , ì¡°ê¸ˆ ë³µì¡í•´ì§€ë©´ Querydsl ì‚¬ìš©
