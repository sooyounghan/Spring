-----
### @EntityGraph
-----
1. ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ SQL í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ë°©ë²•
2. member â†’ teamì€ ì§€ì—°ë¡œë”© ê´€ê³„
3. ë”°ë¼ì„œ, ë‹¤ìŒê³¼ ê°™ì´ teamì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•Œë§ˆë‹¤ ì¿¼ë¦¬ê°€ ì‹¤í–‰ (N + 1ë¬¸ì œ ë°œìƒ)
```java
package study.data_jpa.repository;

import jakarta.persistence.EntityManager;
import org.junit.jupiter.api.Test; // Junit 5
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Slice;
import org.springframework.data.domain.Sort;
import org.springframework.test.annotation.Rollback;
import org.springframework.transaction.annotation.Transactional;
import study.data_jpa.dto.MemberDto;
import study.data_jpa.entity.Member;
import study.data_jpa.entity.Team;

import java.util.Arrays;
import java.util.List;
import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@Transactional
@Rollback(false)
public class MemberRepositoryTest {
    @Autowired MemberRepository memberRepository;
    @Autowired TeamRepository teamRepository;
    @Autowired EntityManager em;

    ...

    @Test
    public void findMemberLazy() {
        // given
        // member1 -> teamA
        // member2 -> teamB

        Team teamA = new Team("teamA");
        Team teamB = new Team("teamB");
        teamRepository.save(teamA);
        teamRepository.save(teamB);

        Member member1 = new Member("member1", 10, teamA);
        Member member2 = new Member("member2", 10, teamB);
        memberRepository.save(member1);
        memberRepository.save(member2);

        em.flush();
        em.clear();

        // when (N + 1)
        // SELECT Member (1)
        List<Member> members = memberRepository.findAll();
        for (Member member : members) {
            System.out.println("member = " + member.getUsername());
            System.out.println("member.teamClass = " + member.getTeam().getClass()); // Proxy
            System.out.println("member.team = " + member.getTeam().getName()); // LAZY(N) - Proxy ì´ˆê¸°í™” (SELECT Team)
        }
    }
}
```
  - ì°¸ê³  : ë‹¤ìŒê³¼ ê°™ì´ ì§€ì—° ë¡œë”© ì—¬ë¶€ í™•ì¸ ê°€ëŠ¥
```java
// Hibernate ê¸°ëŠ¥ìœ¼ë¡œ í™•ì¸
Hibernate.isInitialized(member.getTeam());

// JPA í‘œì¤€ ë°©ë²•ìœ¼ë¡œ í™•ì¸
PersistenceUniUtil util = em.getEntityManagerFacotry().getPersistenceUnitUtil();
util.isLoaded(member.getTeam());
```

4. ğŸ’¡ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•œ ë²ˆì— ì¡°íšŒí•˜ë ¤ë©´ íŒ¨ì¹˜ ì¡°ì¸ í•„ìš”
   - JPQL íŒ¨ì¹˜ ì¡°ì¸
```java
package study.data_jpa.repository;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Slice;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import study.data_jpa.dto.MemberDto;
import study.data_jpa.entity.Member;

import java.util.Collection;
import java.util.List;
import java.util.Optional;

public interface MemberRepository extends JpaRepository<Member, Long> {

    ...

    @Query("SELECT m FROM Member m LEFT JOIN FETCH m.team t")
    List<Member> findMemberFetchJoin();
}
```
```java
@Test
public void findMemberFetchJoin() {
    // given
    // member1 -> teamA
    // member2 -> teamB

    Team teamA = new Team("teamA");
    Team teamB = new Team("teamB");
    teamRepository.save(teamA);
    teamRepository.save(teamB);

    Member member1 = new Member("member1", 10, teamA);
    Member member2 = new Member("member2", 10, teamB);
    memberRepository.save(member1);
    memberRepository.save(member2);

    em.flush();
    em.clear();

    // when
    List<Member> members = memberRepository.findMemberFetchJoin();
    for (Member member : members) {
        System.out.println("member = " + member.getUsername());
        System.out.println("member.teamClass = " + member.getTeam().getClass()); // ìˆœìˆ˜ Team Entity
        System.out.println("member.team = " + member.getTeam().getName()); 
    }
}
```

5. @EntityGraph (ë‹¨ìˆœí•  ë•Œ ì‚¬ìš©)
   - ğŸ’¡ ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” JPAê°€ ì œê³µí•˜ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì„ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ê²Œ ë„ì™€ì¤Œ
  - ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ JPQL ì—†ì´ íŒ¨ì¹˜ ì¡°ì¸ ê°€ëŠ¥ (JPQL + ì—”í‹°í‹° ê·¸ë˜í”„ ê°€ëŠ¥)
```java
package study.data_jpa.repository;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Slice;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import study.data_jpa.dto.MemberDto;
import study.data_jpa.entity.Member;

import java.util.Collection;
import java.util.List;
import java.util.Optional;

public interface MemberRepository extends JpaRepository<Member, Long> {

    ...

    // ê³µí†µ ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë”©
    @Override
    @EntityGraph(attributePaths = {"team"})
    List<Member> findAll();

    // JPQL + ì—”í‹°í‹° ê·¸ë˜í”„
    @EntityGraph(attributePaths = {"team"})
    @Query("SELECT m FROM Member m")
    List<Member> findMemberEntityGraph();

    // ë©”ì„œë“œ ì´ë¦„ ì¿¼ë¦¬ì—ì„œ íŠ¹íˆ í¸ë¦¬
    @EntityGraph(attributePaths = {"team"})
    List<Member> findEntityGraphByUsername(@Param("username") String username);
}
```
  - ì‚¬ì‹¤ìƒ FETCH JOINì˜ ê°„í¸ ë²„ì „
  - ğŸ’¡ LEFT OUTER JOIN ì‚¬ìš©

6. @NamedEntityGraph ì‚¬ìš© ë°©ë²•
```java
@Entity
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@ToString(of = {"id", "username", "age"})
@NamedEntityGraph(name = "Member.all", attributeNodes = @NamedAttributeNode("team"))
public class Member {
      ...
}
```
```java
// @EntityGraph(attributePaths = {"team"})
@EntityGraph("Member.all")
@Query("SELECT m FROM Member m")
List<Member> findMemberEntityGraph();
```
