-----
### ìŠ¤í”„ë§ ë°ì´í„° JPA í˜ì´ì§•ê³¼ ì •ë ¬
-----
1. í˜ì´ì§•ê³¼ ì •ë ¬ íŒŒë¼ë¯¸í„°
   - org.springframework.data.domain.Sort : ì •ë ¬ ê¸°ëŠ¥
   - org.springframework.data.domain.Pageable : í˜ì´ì§• ê¸°ëŠ¥ (ë‚´ë¶€ì— Sort í¬í•¨)
  
2. íŠ¹ë³„í•œ ë°˜í™˜ íƒ€ì…
   - org.springframework.data.domain.Page : ì¶”ê°€ COUNT ì¿¼ë¦¬ ê²°ê³¼ë¥¼ í¬í•¨í•˜ëŠ” í˜ì´ì§•
   - org.springframework.data.domain.Slice : ì¶”ê°€ COUNT ì¿¼ë¦¬ ì—†ì´ ë‹¤ìŒ í˜ì´ì§€ë§Œ í™•ì¸ ê°€ëŠ¥ (ë‚´ë¶€ì ìœ¼ë¡œ limit + 1 ì¡°íšŒ)
   - List (ìë°” ì»¬ë ‰ì…˜) : ì¶”ê°€ COUNT ì¿¼ë¦¬ ì—†ì´ ê²°ê³¼ë§Œ ë°˜í™˜

3. í˜ì´ì§•ê³¼ ì •ë ¬ ì‚¬ìš© ì˜ˆì œ
```java
Page<Member> findByUsername(String name, Pageable pageable); // COUNT ì¿¼ë¦¬ ì‚¬ìš©
Slice<Member> findByUsername(String name, Pageable pageable); // COUNT ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨
List<Member> findByUsername(String name, Pageable pageable); // COUNT ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨
List<Member> findByUsername(String name, Sort sort);
```

4. ë‹¤ìŒ ì¡°ê±´ìœ¼ë¡œ í˜ì´ì§•ê³¼ ì •ë ¬ì„ ì‚¬ìš©í•˜ëŠ” ì˜ˆì œ ì½”ë“œ
   - ê²€ìƒ‰ ì¡°ê±´ : ë‚˜ì´ê°€ 10ì‚´
   - ì •ë ¬ ì¡°ê±´ : ì´ë¦„ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ
   - í˜ì´ì§• ì¡°ê±´ : ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´

5. Page ì‚¬ìš© ì˜ˆì œ ì •ì˜ ì½”ë“œ
```java
package study.data_jpa.repository;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;

...

import java.util.Collection;
import java.util.List;
import java.util.Optional;

public interface MemberRepository extends JpaRepository<Member, Long> {

    ...

    Page<Member> findByAge(int age, Pageable pageable); // Page
    Slice<Member> findSliceByAge(int age, Pageable pageable); // Slice (limit + 1)
    List<Member> findListByAge(int age, Pageable pageable); // List
}
```

6. Page ì‚¬ìš© ì˜ˆì œ ì‹¤í–‰ ì½”ë“œ
```java
@Test
public void paging() {
    // given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 10));
    memberRepository.save(new Member("member3", 10));
    memberRepository.save(new Member("member4", 10));
    memberRepository.save(new Member("member5", 10));

    int age = 10;
    PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC, "username"));

    // when
    Page<Member> page = memberRepository.findByAge(age, pageRequest);

    // then
    List<Member> content = page.getContent(); // ì¡°íšŒëœ ë°ì´í„°
    long totalElements = page.getTotalElements();// = totalCount (ì¡°íšŒëœ ë°ì´í„° ìˆ˜)

    assertThat(content.size()).isEqualTo(3); // ì¡°íšŒëœ ë°ì´í„° ìˆ˜
    assertThat(page.getTotalElements()).isEqualTo(5); // ì „ì²´ ë°ì´í„° ìˆ˜
    assertThat(page.getTotalPages()).isEqualTo(2); // í˜ì´ì§€ ìˆ˜ (1-3 : 1í˜ì´ì§€, 4-5 : 2í˜ì´ì§€)
    assertThat(page.isFirst()).isTrue(); // ì²« ë²ˆì¨° í•­ëª©(í˜ì´ì§€) ì¸ê°€?
    assertThat(page.hasNext()).isTrue(); // ë‹¤ìŒ í˜ì´ì§€ê°€ ì¡´ì¬í•˜ëŠ”ê°€?
}
```
  - memberRepository.findByAge(age, pageRequest)
    + ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ Pageableì€ ì¸í„°í˜ì´ìŠ¤
    + ë”°ë¼ì„œ, ì‹¤ì œ ì‚¬ìš©í•  ë•ŒëŠ” í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ org.springframework.data.domain.PageRequest ê°ì²´ ì‚¬ìš©
  - PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC, "username"))
  - + PageRequest ìƒì„±ìì˜ ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„°ëŠ” í˜„ì¬ í˜ì´ì§€
    + ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ëŠ” ì¡°íšŒí•  ë°ì´í„°ì˜ ìˆ˜
    + ì—¬ê¸°ì— ì¶”ê°€ë¡œ ì •ë ¬ ì •ë³´ë„ íŒŒë¼ë¯¸í„°ë¡œ ì‚¬ìš©
    + ğŸ’¡ ì£¼ì˜ : ì°¸ê³ ë¡œ í˜ì´ì§€ëŠ” 1ë¶€í„° ì‹œì‘ì´ ì•„ë‹ˆë¼ 0ë¶€í„° ì‹œì‘

7. Page ì¸í„°í˜ì´ìŠ¤
```java
package org.springframework.data.domain;

import java.util.Collections;
import java.util.function.Function;

public interface Page<T> extends Slice<T> {

    ...

    int getTotalPages(); // ì „ì²´ í˜ì´ì§€ ìˆ˜
    long getTotalElements(); // ì „ì²´ ë°ì´í„° ìˆ˜

    <U> Page<U> map(Function<? super T, ? extends U> converter); // ë³€í™˜ê¸°
}
```

8. Slice ì¸í„°í˜ì´ìŠ¤
```java
package org.springframework.data.domain;

import java.util.List;
import java.util.function.Function;
import org.springframework.data.util.Streamable;

public interface Slice<T> extends Streamable<T> {
    int getNumber(); // í˜„ì¬ í˜ì´ì§€
    int getSize(); // í˜ì´ì§€ í¬ê¸°
    int getNumberOfElements(); // í˜„ì¬ í˜ì´ì§€ì— ë‚˜ì˜¬ ë°ì´í„° ìˆ˜

    List<T> getContent(); // ì¡°íšŒëœ ë°ì´í„°
    boolean hasContent(); // ì¡°íšŒëœ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€

    Sort getSort(); // ì •ë ¬ ì •ë³´

    boolean isFirst(); // í˜„ì¬ í˜ì´ì§€ê°€ ì²« í˜ì´ì§€ ì¸ì§€ ì—¬ë¶€
    boolean isLast(); // í˜„ì¬ í˜ì´ì§€ê°€ ë§ˆì§€ë§‰ í˜ì´ì§€ ì¸ì§€ ì—¬ë¶€

    boolean hasNext(); // ë‹¤ìŒ í˜ì´ì§€ ì—¬ë¶€
    boolean hasPrevious(); // ì´ì „ í˜ì´ì§€ ì—¬ë¶€

    ...

    Pageable previousPageable(); // ì´ì „ í˜ì´ì§€ ê°ì²´
    Pageable nextPageable(); // ë‹¤ìŒ í˜ì´ì§€ ê°ì²´

    <U> Slice<U> map(Function<? super T, ? extends U> converter); // ë³€í™˜ê¸°
}
```

9. ì‹¤ìŠµ (í…ŒìŠ¤íŠ¸ ì½”ë“œ)
```java
package study.data_jpa.repository;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Slice;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import study.data_jpa.dto.MemberDto;
import study.data_jpa.entity.Member;

import java.util.Collection;
import java.util.List;
import java.util.Optional;

public interface MemberRepository extends JpaRepository<Member, Long> {

    ...

    Page<Member> findByAge(int age, Pageable pageable); // Page
    Slice<Member> findSliceByAge(int age, Pageable pageable); // Slice (limit + 1)
    List<Member> findListByAge(int age, Pageable pageable); // List
}

```
```java
 @Test
public void paging() {
    // given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 10));
    memberRepository.save(new Member("member3", 10));
    memberRepository.save(new Member("member4", 10));
    memberRepository.save(new Member("member5", 10));

    int age = 10;
    PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC, "username"));

    // when
    Page<Member> page = memberRepository.findByAge(age, pageRequest); // Page
    Slice<Member> slice = memberRepository.findSliceByAge(age, pageRequest); // Slice : limit(3) + 1 = 4ê°œ ìš”ì²­ (Count X) - ë‹¤ìŒ í˜ì´ì§€ ì—¬ë¶€
    List<Member> list = memberRepository.findListByAge(age, pageRequest); // List

    // then
    List<Member> content = page.getContent(); // ì¡°íšŒëœ ë°ì´í„°
    long totalElements = page.getTotalElements();// = totalCount (ì¡°íšŒëœ ë°ì´í„° ìˆ˜)

    // Page<Member>
    assertThat(content.size()).isEqualTo(3); // ì¡°íšŒëœ ë°ì´í„° ìˆ˜
    assertThat(page.getTotalElements()).isEqualTo(5); // ì „ì²´ ë°ì´í„° ìˆ˜
    assertThat(page.getTotalPages()).isEqualTo(2); // í˜ì´ì§€ ë²ˆí˜¸ (1-3 : 1í˜ì´ì§€, 4-5 : 2í˜ì´ì§€)
    assertThat(page.isFirst()).isTrue(); // ì²« ë²ˆì¨° í•­ëª©(í˜ì´ì§€) ì¸ê°€?
    assertThat(page.hasNext()).isTrue(); // ë‹¤ìŒ í˜ì´ì§€ê°€ ì¡´ì¬í•˜ëŠ”ê°€?

    // Slice<Member>
    // assertThat(slice.getTotalElements()).isEqualTo(5); // ì „ì²´ ë°ì´í„° ìˆ˜
    // assertThat(slice.getTotalPages()).isEqualTo(2); // í˜ì´ì§€ ë²ˆí˜¸ (1-3 : 1í˜ì´ì§€, 4-5 : 2í˜ì´ì§€)
    assertThat(slice.isFirst()).isTrue(); // ì²« ë²ˆì¨° í•­ëª©(í˜ì´ì§€) ì¸ê°€?
    assertThat(slice.hasNext()).isTrue(); // ë‹¤ìŒ í˜ì´ì§€ê°€ ì¡´ì¬í•˜ëŠ”ê°€?

    // List<Member>
    // assertThat(list.getTotalElements()).isEqualTo(5); // ì „ì²´ ë°ì´í„° ìˆ˜
    // assertThat(list.getTotalPages()).isEqualTo(2); // í˜ì´ì§€ ë²ˆí˜¸ (1-3 : 1í˜ì´ì§€, 4-5 : 2í˜ì´ì§€)
    // assertThat(list.isFirst()).isTrue(); // ì²« ë²ˆì¨° í•­ëª©(í˜ì´ì§€) ì¸ê°€?
    // assertThat(list.hasNext()).isTrue(); // ë‹¤ìŒ í˜ì´ì§€ê°€ ì¡´ì¬í•˜ëŠ”ê°€?
}
```
```
// Page<Member> page = memberRepository.findByAge(age, pageRequest);
select
    m1_0.member_id,
    m1_0.age,
    m1_0.team_id,
    m1_0.username 
from
    member m1_0 
where
    m1_0.age=? 
order by
    m1_0.username desc 
fetch
    first ? rows only

select
    m1_0.member_id,m1_0.age,m1_0.team_id,m1_0.username
from
    member m1_0 where m1_0.age=10
order by
    m1_0.username desc
fetch
    first 3 rows only;
[    Test worker] org.hibernate.orm.jdbc.bind              : binding parameter (1:INTEGER) <- [10]
[    Test worker] org.hibernate.orm.jdbc.bind              : binding parameter (2:INTEGER) <- [3]

select
  count(m1_0.member_id) 
from
  member m1_0 
where
  m1_0.age=?

select
    count(m1_0.member_id)
from
    member m1_0
where
    m1_0.age=10;
[data-jpa] [    Test worker] org.hibernate.orm.jdbc.bind              : binding parameter (1:INTEGER) <- [10]

...

// Slice<Member> slice = memberRepository.findSliceByAge(age, pageRequest);
select
    m1_0.member_id,
    m1_0.age,
    m1_0.team_id,
    m1_0.username 
from
    member m1_0 
where
    m1_0.age=? 
order by
    m1_0.username desc 
fetch
    first ? rows only

select
    m1_0.member_id,m1_0.age,m1_0.team_id,m1_0.username
from
    member m1_0 where m1_0.age=10
order by
    m1_0.username desc
fetch
    first 4 rows only;
[data-jpa] [    Test worker] org.hibernate.orm.jdbc.bind              : binding parameter (1:INTEGER) <- [10]
[data-jpa] [    Test worker] org.hibernate.orm.jdbc.bind              : binding parameter (2:INTEGER) <- [4]

// List<Member> list = memberRepository.findListByAge(age, pageRequest);
select
    m1_0.member_id,
    m1_0.age,
    m1_0.team_id,
    m1_0.username 
from
    member m1_0 
where
    m1_0.age=? 
order by
    m1_0.username desc 
fetch
    first ? rows only

select
    m1_0.member_id,m1_0.age,m1_0.team_id,m1_0.username
from
    member m1_0 where m1_0.age=10
order by
    m1_0.username desc
fetch
    first 3 rows only;
[data-jpa] [    Test worker] org.hibernate.orm.jdbc.bind              : binding parameter (1:INTEGER) <- [10]
[data-jpa] [    Test worker] org.hibernate.orm.jdbc.bind              : binding parameter (2:INTEGER) <- [3]
```

10. ğŸ’¡ ì°¸ê³  : COUNT ì¿¼ë¦¬ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë¶„ë¦¬ ê°€ëŠ¥ (ì‹¤ë¬´ì—ì„œ ì¤‘ìš”)
    - ğŸ’¡ COUNT ì¿¼ë¦¬ëŠ” ë§¤ìš° ë¬´ê±°ì›€
    - ë³µì¡í•œ SQLì—ì„œ ì‚¬ìš©
    - ğŸ’¡ ë°ì´í„°ëŠ” LETT JOIN ì‚¬ìš©, ì¹´ìš´íŠ¸ëŠ” LEFT JOINì„ í•˜ì§€ ì•Šì•„ë„ ë¨ (ì•„ë˜ ì½”ë“œ)
```java
@Query(
        value = "SELECT m FROM Member m LEFT JOIN m.team t", // ì¼ë°˜ ì¿¼ë¦¬ : ì¡°ì¸ ì¿¼ë¦¬
        countQuery = "SELECT COUNT(m.username) FROM Member m" // ì¹´ìš´í„° ì¿¼ë¦¬ : ì¡°ì¸ ë¯¸ì‚¬ìš©
)
Page<Member> findMemberAllCountBy(Pageable pageable);
```

11. Top, First ì‚¬ìš© ì°¸ê³ 
  - https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.limit-query-result
```java
package study.data_jpa.repository;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Slice;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import study.data_jpa.dto.MemberDto;
import study.data_jpa.entity.Member;

import java.util.Collection;
import java.util.List;
import java.util.Optional;

public interface MemberRepository extends JpaRepository<Member, Long> {

    ...

    List<Member> findTop3By();
}
```

12. ğŸ’¡ í˜ì´ì§€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜ (map (ë³€í™˜ê¸°) ì´ìš©)
```java
Page<Member> page = memberRepository.findByAge(age, pageRequest); // Page
// Member Page -> MemberDto Page (map)
Page<MemberDto> dtoPage = page.map(member -> new MemberDto(member.getId(), member.getUsername(), null));
```

13. ğŸ’¡ ìŠ¤í”„ë§ ë¶€íŠ¸ 3 - í•˜ì´ë²„ë„¤ì´íŠ¸ 6 LEFT JOIN ìµœì í™”
  - ìŠ¤í”„ë§ ë¶€íŠ¸ 3 ì´ìƒ ì‚¬ìš©í•˜ë©´ í•˜ì´ë²„ë„¤ì´íŠ¸ 6 ì ìš©
  - í•˜ì´ë²„ë„¤ì´íŠ¸ 6ì—ì„œ ì˜ë¯¸ ì—†ëŠ” LEFT JOINì„ ìµœì í™”í•˜ë¯€ë¡œ, ë‹¤ìŒì„ ì‹¤í–‰í•˜ë©´ SQLì´ LEFT JOINì„ í•˜ì§€ ì•ŠëŠ” ê²ƒì²˜ëŸ¼ ë³´ì„
```java
@Query("SELECT m FROM Member m LEFT JOIN m.team t")
Page<Member> findByAge(int age, Pageable pageable);
```
  - ì‹¤í–‰ ê²°ê³¼
```
select
        m1_0.member_id,
        m1_0.age,
        m1_0.team_id,
        m1_0.username 
from
        member m1_0
```
  - ì‹¤í–‰í•œ JPQLì„ ë³´ë©´ LEFT ì¡°ì¸ì„ ì‚¬ìš©í•˜ëŠ”ë° í•˜ì´ë²„ë„¤ì´íŠ¸ 6ì€ ì™œ LEFT JOINì„ ì œê±°í•˜ëŠ” ìµœì í™”ë¥¼ í•˜ëŠ”ê°€?
```java
SELECT m FROM Member m LEFT JOIN m.team t
```
  - Memberì™€ Teamì€ ì¡°ì¸ì„ í•˜ì§€ë§Œ, ì‚¬ì‹¤ ì´ ì¿¼ë¦¬ëŠ” Teamì„ ì „í˜€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
  - SELECTì ˆì´ë‚˜ WHEREì ˆì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ. ë”°ë¼ì„œ ì´ JPQLì€ ë‹¤ìŒê³¼ ê°™ìŒ
```java
SELECT m FROM Member m
```

  - LEFT JOINì´ë¯€ë¡œ ì™¼ìª½ì— ìˆëŠ” member ìì²´ë¥¼ ë‹¤ ì¡°íšŒí•˜ëŠ” ëœ»ì„
  - ë§Œì•½, SELECTì ˆì´ë‚˜ WHERE ì ˆì— team ì¡°ê±´ì´ ë“¤ì–´ê°„ë‹¤ë©´ ì •ìƒì ì¸ JOINë¬¸ì´ ë³´ì„
  - JPAëŠ” ì´ ê²½ìš° ìµœì í™”ë¥¼ í•´ì„œ JOIN ì—†ì´ í•´ë‹¹ ë‚´ìš©ë§Œìœ¼ë¡œ SQLì„ ë§Œë“¬
  - ì—¬ê¸°ì„œ ë§Œì•½ Memberì™€ Teamì„ í•˜ë‚˜ì˜ SQLë¡œ í•œ ë²ˆì— ì¡°íšŒí•˜ê³  ì‹¶ë‹¤ë©´, JPAì˜ Fetch Join ì‚¬ìš©
```java
SELECT m FROM Member m LEFT JOIN FETCH m.team t
```
  - SQLì—ì„œ JOINë¬¸ ì •ìƒ ìˆ˜í–‰
