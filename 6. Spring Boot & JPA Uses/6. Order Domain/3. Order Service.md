-----
### ì£¼ë¬¸ ì„œë¹„ìŠ¤ ê°œë°œ
-----
1. ì£¼ë¬¸ ì„œë¹„ìŠ¤ ì½”ë“œ
```java
package jpabook.jpashop.service;

import jpabook.jpashop.domain.Delivery;
import jpabook.jpashop.domain.Member;
import jpabook.jpashop.domain.Order;
import jpabook.jpashop.domain.OrderItem;
import jpabook.jpashop.domain.item.Item;
import jpabook.jpashop.repository.ItemRepository;
import jpabook.jpashop.repository.MemberRepository;
import jpabook.jpashop.repository.OrderRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;
    private final MemberRepository memberRepository;
    private final ItemRepository itemRepository;

    /**
     * ì£¼ë¬¸
     */
    @Transactional
    public Long order(Long memberId, Long itemId, int count) {

        // ì—”í‹°í‹° ì¡°íšŒ
        Member member = memberRepository.findOne(memberId);
        Item item = itemRepository.findOne(itemId);

        // ë°°ì†¡ì •ë³´ ìƒì„± (ğŸ’¡ í˜„ì¬ ì½”ë“œì—ì„œ ì˜ì†í™” ë¯¸ì‹¤ì‹œ)
        Delivery delivery = new Delivery();
        delivery.setAddress(member.getAddress());

        // ì£¼ë¬¸ìƒí’ˆ ìƒì„± (ğŸ’¡ í˜„ì¬ ì½”ë“œì—ì„œ ì˜ì†í™” ë¯¸ì‹¤ì‹œ)
        OrderItem orderItem = OrderItem.createOrderItem(item, item.getPrice(), count);
        // OrderItem orderItem = new OrderItem(); // ğŸ’¡ ìƒì„± ë¶ˆê°€ (ìƒì„±ì protected), ì™¸ë¶€ë¡œë¶€í„° ë¬´ë¶„ë³„í•œ ì—”í‹°í‹° ìƒì„± ì œí•œ

        // ì£¼ë¬¸ ìƒì„±
        Order order = Order.createOrder(member, delivery, orderItem);
        // Order order = new Order(); // ğŸ’¡ ìƒì„± ë¶ˆê°€ (ìƒì„±ì protected), ì™¸ë¶€ë¡œë¶€í„° ë¬´ë¶„ë³„í•œ ì—”í‹°í‹° ìƒì„± ì œí•œ

        // ì£¼ë¬¸ ì €ì¥
        // ğŸ’¡ Delivery, OrderItemì€ cascade = CascadeType = ALL (Deliveryì™€ OrderItemì€ Orderì—ì„œë§Œ ì‚¬ìš©ë¨. OrderëŠ” Private Owner, cascadeë¡œ ì˜ì†ì„± ì „ì´í•´ë„ ë¬´ë°©)
        // ğŸ’¡ ë”°ë¼ì„œ, orderë¥¼ ì˜ì†í™”í•˜ê³  DBì— ì €ì¥í•˜ë©´, ì´ì™€ ê´€ë ¨ëœ orderItem / deliveryë„ ì˜ì†ì„± ì „ì´ë¡œ ì˜ì†í™” ë˜ë©´ì„œ, Commit ì‹œì ì— DBì— ì €ì¥
        orderRepository.save(order);

        return order.getId();
    }

    /**
     * ì£¼ë¬¸ ì·¨ì†Œ
     */
    @Transactional
    public void cancelOrder(Long orderId) {
        // ì£¼ë¬¸ ì—”í‹°í‹° ì¡°íšŒ
        Order order = orderRepository.findOne(orderId);

        // ì£¼ë¬¸ ì·¨ì†Œ
        // ê¸°ì¡´ SQL : ê°ì²´ì™€ ê´€ë ¨ëœ ê°’ì„ ëª¨ë‘ ê°€ì ¸ì™€ì„œ, SQL ì¿¼ë¦¬ ì‘ì„± í›„ ì‹¤í–‰
        // ğŸ’¡ JPA : ì—”í‹°í‹° ë‚´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í†µí•´ ì—”í‹°í‹° ë‚´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì ‘ê·¼í•´ ë°ì´í„°ê°€ ë³€ê²½ë˜ë©´, Dirty-Checkingë˜ì–´ ë³€ê²½ëœ ê°ì§€í•˜ì—¬ ë³€ê²½ ë‚´ì—­ì— ëŒ€í•œ UPDATE SQL ì‹¤í–‰
        order.cancel();
    }

    /**
     * ì£¼ë¬¸ ê²€ìƒ‰
     */
    /* 
    public List<Order> findOrders(OrderSearch orderSearch) { 
         return orderRepository.findOne(orderSearch) 
    }
    */
}
```

2. ì£¼ë¬¸ ì„œë¹„ìŠ¤ëŠ” ì£¼ë¬¸ ì—”í‹°í‹°ì™€ ì£¼ë¬¸ ìƒí’ˆ ì—”í‹°í‹°ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í™œìš©í•´ ì£¼ë¬¸, ì£¼ë¬¸ ì·¨ì†Œ, ì£¼ë¬¸ ë‚´ì—­ ê²€ìƒ‰ ê¸°ëŠ¥ ì œê³µ
3. ì˜ˆì œ ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ í•œ ë²ˆì— í•˜ë‚˜ì˜ ìƒí’ˆë§Œ ì£¼ë¬¸í•˜ë„ë¡ í•¨
4. ê¸°ëŠ¥ ì„¤ëª…
   - ì£¼ë¬¸(order()) : ì£¼ë¬¸í•˜ëŠ” íšŒì› ì‹ë³„ì, ìƒí’ˆ ì‹ë³„ì, ì£¼ë¬¸ ìˆ˜ëŸ‰ ì •ë³´ë¥¼ ë°›ì•„ ì‹¤ì œ ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ìƒì„±í•œ í›„ ì €ì¥
   - ì£¼ë¬¸ ì·¨ì†Œ(cancelOrder()) : ì£¼ë¬¸ ì‹ë³„ìë¥¼ ë°›ì•„ ì£¼ë¬¸ ì—”í‹°í‹° ì¡°íšŒí•œ í›„, ì£¼ë¬¸ ì—”í‹°í‹°ì— ì£¼ë¬¸ ì·¨ì†Œ ìš”ì²­
   - ì£¼ë¬¸ ê²€ìƒ‰(findOrders()) : OrderSearchë¼ëŠ” ê²€ìƒ‰ ì¡°ê±´ì„ ê°€ì§„ ê°ì²´ë¡œ ì£¼ë¬¸ ì—”í‹°í‹° ê²€ìƒ‰

5. order() ìƒì„¸ ì„¤ëª…
```java
/**
 * ì£¼ë¬¸
 */
@Transactional
public Long order(Long memberId, Long itemId, int count) {

    // ì—”í‹°í‹° ì¡°íšŒ
    Member member = memberRepository.findOne(memberId);
    Item item = itemRepository.findOne(itemId);

    // ë°°ì†¡ì •ë³´ ìƒì„± (ğŸ’¡ í˜„ì¬ ì½”ë“œì—ì„œ ì˜ì†í™” ë¯¸ì‹¤ì‹œ)
    Delivery delivery = new Delivery();
    delivery.setAddress(member.getAddress());

    // ì£¼ë¬¸ìƒí’ˆ ìƒì„± (ğŸ’¡ í˜„ì¬ ì½”ë“œì—ì„œ ì˜ì†í™” ë¯¸ì‹¤ì‹œ)
    OrderItem orderItem = OrderItem.createOrderItem(item, item.getPrice(), count);
    // OrderItem orderItem = new OrderItem(); // ğŸ’¡ ìƒì„± ë¶ˆê°€ (ìƒì„±ì protected), ì™¸ë¶€ë¡œë¶€í„° ë¬´ë¶„ë³„í•œ ì—”í‹°í‹° ìƒì„± ì œí•œ

    // ì£¼ë¬¸ ìƒì„±
    Order order = Order.createOrder(member, delivery, orderItem);
    // Order order = new Order(); // ğŸ’¡ ìƒì„± ë¶ˆê°€ (ìƒì„±ì protected), ì™¸ë¶€ë¡œë¶€í„° ë¬´ë¶„ë³„í•œ ì—”í‹°í‹° ìƒì„± ì œí•œ

    // ì£¼ë¬¸ ì €ì¥
    // ğŸ’¡ Delivery, OrderItemì€ cascade = CascadeType = ALL (Deliveryì™€ OrderItemì€ Orderì—ì„œë§Œ ì‚¬ìš©ë¨. OrderëŠ” Private Owner, cascadeë¡œ ì˜ì†ì„± ì „ì´í•´ë„ ë¬´ë°©)
    // ğŸ’¡ ë”°ë¼ì„œ, orderë¥¼ ì˜ì†í™”í•˜ê³  DBì— ì €ì¥í•˜ë©´, ì´ì™€ ê´€ë ¨ëœ orderItem / deliveryë„ ì˜ì†ì„± ì „ì´ë¡œ ì˜ì†í™” ë˜ë©´ì„œ, DBì— ì €ì¥
    orderRepository.save(order);

    return order.getId();
}
```
  - ğŸ’¡ Orderì™€ OrderItemì€ ìƒì„±ìë¡œ ì™¸ë¶€ì—ì„œ ë¬´ë¶„ë³„í•˜ê²Œ ì—”í‹°í‹°ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ìƒì„±ì ì ‘ê·¼ ì œí•œ(protected) ë³€ê²½
    + ğŸ’¡ proetectedë¡œ ì ‘ê·¼ ì œì–´ìë¥¼ ì„¤ì •í•˜ëŠ” ì´ìœ ëŠ” privateë¡œ ì„¤ì •í•˜ê²Œ ëœë‹¤ë©´, Entity Proxy ìƒì„±í•˜ëŠ” ê²ƒì´ ì œí•œë˜ê¸° ë•Œë¬¸ì„
    + ğŸ’¡ ëŒ€ë¶€ë¶„ì˜ ì—”í‹°í‹°ëŠ” í˜„ì¬ ì§€ì—° ë¡œë”© ì „ëµì´ë©°, ì§€ì—° ë¡œë”© ì „ëµì€ Proxy ì‚¬ìš©
    + ğŸ’¡ ë”°ë¼ì„œ, JPA ìŠ¤í™ ìƒ protected, public ì ‘ê·¼ ì œì–´ìë§Œ í—ˆìš©
      * protectedë¡œ ì„¤ì •í•˜ê²Œ ëœë‹¤ë©´, ìì‹ ì´ ì†í•œ íŒ¨í‚¤ì§€ ë˜ëŠ” ìƒì†ë°›ì€ ìì‹ í´ë˜ìŠ¤ì—ì„œ ê¹Œì§€ë§Œ ì ‘ê·¼ ê°€ëŠ¥

  - @NoArgsConstructor : ê¸°ë³¸ ìƒì„±ìë¥¼ ìƒì„±í•˜ëŠ” Lombok ì• ë„ˆí…Œì´ì…˜
    + access = AccessLevel.PROTECTED : protected ì ‘ê·¼ì œì–´ì
    + access = AccessLevel.PRIVATE : private ì ‘ê·¼ ì œì–´ì

  - OrderItem
```java
package jpabook.jpashop.domain;

import jakarta.persistence.*;
import jpabook.jpashop.domain.item.Item;
import lombok.AccessLevel;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Entity
@Table(name = "order_item")
@Getter @Setter
// ğŸ’¡ @NoArgsConstructor(access = AccessLevel.PROTECTED) // protect OrderItem()ê³¼ ë™ì¼
// ğŸ’¡ access = AccessLevel.PRIVATEë„ ì¡´ì¬í•˜ì§€ë§Œ, ì—”í‹°í‹° Proxy ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ PROTECTEDë§Œ ê±°ì˜ ì‚¬ìš©
public class OrderItem {

    ...

    protected OrderItem() { // ğŸ’¡ ìƒì„±ì protected ì„¤ì • : ì™¸ë¶€ì—ì„œ ìƒì„±ì ì‚¬ìš© ë¶ˆê°€í•˜ë„ë¡ ì„¤ì •
        // ğŸ’¡ ì˜ë„ì¹˜ ì•ŠëŠ” ì—”í‹°í‹° ìƒì„± ë°©ì§€ ê°€ëŠ¥ (JPA ìŠ¤í™)
    }

    ...
}
```

  - Order
```java
package jpabook.jpashop.domain;

import jakarta.persistence.*;
import lombok.AccessLevel;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Table(name = "orders")
@Getter @Setter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Order {

    ...

}
```

  - ì˜ì†ì„± ì „ì´ ê´€ë ¨
    + Order
```java
package jpabook.jpashop.domain;

import jakarta.persistence.*;
import lombok.AccessLevel;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Table(name = "orders")
@Getter @Setter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Order {

    ...

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderItem> orderItems = new ArrayList<>();

    @OneToOne(fetch = FetchType.LAZY, cascade = CascadeType.ALL)
    @JoinColumn(name = "delivery_id")
    private Delivery delivery;

    ...
}
```

  - Order ì—”í‹°í‹°ë¥¼ ë³´ë©´, OrderItemê³¼ DeliveryëŠ” í˜„ì¬ ì—°ê´€ ê´€ê³„ê°€ ì¡´ì¬í•˜ë©°, ì—°ê´€ê´€ê³„ ë§¤í•‘ ì‹œ cascade = CascadeType.ALL ì˜µì…˜ ë¶€ì—¬
  - ğŸ’¡ ì¦‰, Order ì—”í‹°í‹°ë¥¼ ì˜ì†í™”í•˜ê³ , ì´ë¥¼ DBì— ì €ì¥í•˜ê±°ë‚˜ ì‚­ì œí•˜ëŠ” ë“±ì˜ ì‘ì—…ì„ í•˜ë©´, ì˜ì†ì„± ì „ì´ë¡œ OrderItemê³¼ Deliveryë„ ì˜í–¥
  - ğŸ’¡ ì´ëŸ¬í•œ ì˜ì†ì„± ì „ì´ë¥¼ ì˜µì…˜ì„ ë¶€ì—¬í•  ë•ŒëŠ” Private Ownerì¸ì§€ í™•ì¸í•´ì•¼ í•¨
    + ğŸ’¡ ì¦‰, ì—¬ê¸°ì„œëŠ” Deliveryì™€ OrderItemì€ ë‹¤ë¥¸ ê³³ì—ì„œ ì°¸ì¡°ë¥¼ ë°›ì§€ ì•Šê³ , ì˜¤ë¡œì§€ Orderì—ë§Œ ì°¸ì¡°í•˜ê³ , ì°¸ì¡°ë˜ë¯€ë¡œ ì´ëŸ¬í•œ ê²½ìš°ì—ëŠ” ì˜ì†ì„± ì „ì´ë¥¼ ì„¤ì •í•´ë„ ë¬´ë°©í•¨ )

6. cancelOrder() ìƒì„¸ ì„¤ëª…
```java
/**
 * ì£¼ë¬¸ ì·¨ì†Œ
 */
@Transactional
public void cancelOrder(Long orderId) {
    // ì£¼ë¬¸ ì—”í‹°í‹° ì¡°íšŒ
    Order order = orderRepository.findOne(orderId);

    // ì£¼ë¬¸ ì·¨ì†Œ
    // ê¸°ì¡´ SQL : ê°ì²´ì™€ ê´€ë ¨ëœ ê°’ì„ ëª¨ë‘ ê°€ì ¸ì™€ì„œ, SQL ì¿¼ë¦¬ ì‘ì„± í›„ ì‹¤í–‰
    // ğŸ’¡ JPA : ì—”í‹°í‹° ë‚´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í†µí•´ ì—”í‹°í‹° ë‚´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì ‘ê·¼í•´ ë°ì´í„°ê°€ ë³€ê²½ë˜ë©´, Dirty-Checkingë˜ì–´ ë³€ê²½ëœ ê°ì§€í•˜ì—¬ ë³€ê²½ ë‚´ì—­ì— ëŒ€í•œ UPDATE SQL ì‹¤í–‰
    order.cancel();
}
```
  - ê¸°ì¡´ SQLì€ ë³€ê²½ë˜ì–´ì•¼ í•˜ëŠ” ë¶€ë¶„ì´ ìˆë‹¤ë©´, ê°ì²´ì™€ ê´€ë ¨ëœ ê°’ì„ ê°€ì ¸ì™€ì„œ, UPDATE SQL ì‘ì„± í›„, ì´ë¥¼ ì‹¤í–‰
  - ğŸ’¡ JPAì˜ ê²½ìš°ì—ëŠ”, ì—”í‹°í‹° ë‚´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í†µí•´ ë°ì´í„° ë³€ê²½ë˜ëŠ” ë¶€ë¶„ì— ëŒ€í•´ ì—”í‹°í‹° ë‚´ ë°ì´í„°ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í†µí•´ ì ‘ê·¼í•˜ì—¬ ë³€ê²½
    + ğŸ’¡ JPAê°€ Dirty-Checkingì„ í†µí•´ ë³€ê²½ë¨ì„ ê°ì§€í•˜ì—¬, ë³€ê²½ ë‚´ì—­ì´ ì¡´ì¬í•˜ë©´ Commití•˜ëŠ” ì‹œì ì— UPDATE SQL ì‹¤í–‰

7. ì°¸ê³ 
   - ì£¼ë¬¸ ì„œë¹„ìŠ¤ì˜ ì£¼ë¬¸ê³¼ ì£¼ë¬¸ ì·¨ì†Œ ë©”ì„œë“œë¥¼ ë³´ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ëŒ€ë¶€ë¶„ì´ ì—”í‹°í‹°ì— ì¡´ì¬
   - ì„œë¹„ìŠ¤ ê³„ì¸µì€ ë‹¨ìˆœíˆ ì—”í‹°í‹°ì— í•„ìš”í•œ ìš”ì²­ì„ ìœ„ì„í•˜ëŠ” ì—­í• 
   - ğŸ’¡ ì´ì²˜ëŸ¼ ì—”í‹°í‹°ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°€ì§€ê³  ê°ì²´ ì§€í–¥ íŠ¹ì§•ì˜ íŠ¹ì„±ì„ ì ê·¹ í™œìš©í•˜ëŠ” ê²ƒì„ 'ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´' (http://martinfowler.com/eaaCatalog/domainModel.html)
   - ğŸ’¡ ë°˜ëŒ€ë¡œ, ì—”í‹°í‹°ì—ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ê±°ì˜ ì—†ê³ , ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ëŒ€ë¶€ë¶„ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ 'íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´' (http://martinfowler.com/eaaCatalog/transactionScript.html)
