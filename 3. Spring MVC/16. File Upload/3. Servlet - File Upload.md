-----
### ì„œë¸”ë¦¿ - íŒŒì¼ ì—…ë¡œë“œ
-----
1. ServletUploadControllerV1
```java
package hello.upload.controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.Part;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import java.io.IOException;
import java.util.Collection;

@Slf4j
@Controller
@RequestMapping("/servlet/v1")
public class ServletUploadControllerV1 {
    
    @GetMapping("/upload")
    public String newFile() {
        return "upload-form";
    }
    
    @PostMapping("/upload")
    public String saveFile1V1(HttpServletRequest request) throws ServletException, IOException {
        log.info("request = {}", request);

        String itemName = request.getParameter("itemName");
        log.info("itemName = {}", itemName);

        Collection<Part> parts = request.getParts();
        log.info("parts = {}", parts);

        return "upload-form";
    }
}
```
  - request.getParts() : multipart/form-data ì „ì†¡ ë°©ì‹ì—ì„œ ê°ê° ë‚˜ëˆ„ì–´ì§„ ë¶€ë¶„ì„ ë°›ì•„ì„œ í™•ì¸ ê°€ëŠ¥

2. resources/templates/upload-form.html
```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
</head>

<body>
<div class="container">
  <div class="py-5 text-center">
    <h2>ìƒí’ˆ ë“±ë¡ í¼</h2>
  </div>
  <h4 class="mb-3">ìƒí’ˆ ì…ë ¥</h4>

  <form th:action method="post" enctype="multipart/form-data">
    <ul>
      <li>ìƒí’ˆëª… <input type="text" name="itemName"></li>
      <li>íŒŒì¼<input type="file" name="file" ></li>
    </ul>
    <input type="submit"/>
  </form>

</div> <!-- /container -->
</body>
</html>
```

3. í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê¸° ì „ ë‹¤ìŒ ì˜µì…˜ ì¶”ê°€ (application.properties)
```properties
logging.level.org.apache.coyote.http11=trace
```
  - Spring Boot 3.2 ë¶€í„°ëŠ” debug ëŒ€ì‹  trace ì‚¬ìš©í•´ì•¼ ë¡œê·¸ ì¶œë ¥
  - ì´ ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ HTTP ìš”ì²­ ë©”ì„¸ì§€ í™•ì¸ ê°€ëŠ¥

4. ì‹¤í–‰ (http://localhost:8080/servlet/v1/upload)
  - ì‹¤í–‰í•´ë³´ë©´ logging.level.org.apache.coyote.http11 ì˜µì…˜ì„ í†µí•œ ë¡œê·¸ì—ì„œ multipart/form-data ë°©ì‹ìœ¼ë¡œ ì „ì†¡ëœ ê²ƒ í™•ì¸ ê°€ëŠ¥
  - ê²°ê³¼ ë¡œê·¸
```
...

Content-Type: multipart/form-data; boundary=----WebKitFormBoundarylz6XDifLkZXBNsA3

...

------WebKitFormBoundarylz6XDifLkZXBNsA3
Content-Disposition: form-data; name="itemName"

123
------WebKitFormBoundarylz6XDifLkZXBNsA3
Content-Disposition: form-data; name="file"; filename="20240720_142321.png"
Content-Type: image/png

...
------WebKitFormBoundarylz6XDifLkZXBNsA3--

2024-07-20T15:06:34.802+09:00  INFO 7556 --- [upload] [nio-9090-exec-7] h.u.c.ServletUploadControllerV1          : request = org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@4bdedea
2024-07-20T15:06:34.802+09:00  INFO 7556 --- [upload] [nio-9090-exec-7] h.u.c.ServletUploadControllerV1          : itemName = 123
2024-07-20T15:06:34.802+09:00  INFO 7556 --- [upload] [nio-9090-exec-7] h.u.c.ServletUploadControllerV1          : parts = [org.apache.catalina.core.ApplicationPart@a7a130d, org.apache.catalina.core.ApplicationPart@e45869a]
```

-----
### Multi-Part ì‚¬ìš© ì˜µì…˜
-----
1. ì—…ë¡œë“œ ì‚¬ì´ì¦ˆ ì œí•œ
```properties
spring.servlet.multipart.max-file-size=1MB
srping.servlet.multipart.max-request-size=10MB
```
  - í° íŒŒì¼ì„ ë¬´ì œí•œ ì—…ë¡œë“œ í•˜ê²Œ í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì—…ë¡œë“œ ì‚¬ì´ì¦ˆ ì œí•œ ê°€ëŠ¥
  - ì‚¬ì´ì¦ˆë¥¼ ë„˜ìœ¼ë©´ ì˜ˆì™¸(SizeLimitExceededException) ë°œìƒ
  - ğŸ’¡ max-file-size : íŒŒì¼ í•˜ë‚˜ ìµœëŒ€ ì‚¬ì´ì¦ˆ (ê¸°ë³¸ 1MB)
  - ğŸ’¡ max-request-size : ë©€í‹°íŒŒíŠ¸ ìš”ì²­ í•˜ë‚˜ì— ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥, ê·¸ ì „ì²´ì˜ í•© (ê¸°ë³¸ 10MB)

2. spring.servlet.multipart.enabled ë„ê¸°
```properties
spring.servlet.multipart.enabled=false
```
  - ê²°ê³¼ ë¡œê·¸
```
2024-07-20T15:20:08.902+09:00  INFO 16124 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV1          : request = org.apache.catalina.connector.RequestFacade@3e62d11e
2024-07-20T15:20:08.905+09:00  INFO 16124 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV1          : itemName = null
2024-07-20T15:20:08.905+09:00  INFO 16124 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV1          : parts = []
```

3. ë©€í‹°íŒŒíŠ¸ëŠ” ì¼ë°˜ì ì¸ í¼ ìš”ì²­ì¸ application/x-www-form-urlencodedë³´ë‹¤ í›¨ì”¬ ë³µì¡
   - spring.servlet.multipart.enabled ì˜µì…˜ì„ ë„ë©´, ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆëŠ” ë©€í‹°íŒŒíŠ¸ì™€ ê´€ë ¨ëœ ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•ŠìŒ
   - ë”°ë¼ì„œ, ê²°ê³¼ë¥¼ ë³´ë©´ request.getParameter("itemName"), request.getParts()ì˜ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŒ

4. spring.servlet.multipart.enabled ì¼œí‚¤
```properties
spring.servlet.multipart.enabled=true
```
  - ê¸°ë³¸ê°’ : true
  - ì´ ì˜µì…˜ì„ ì¼œë©´, ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆì—ê²Œ ë©€í‹°íŒŒíŠ¸ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ë¼ê³  ì„¤ì •
  - ê²°ê³¼ ë¡œê·¸
```
2024-07-20T15:06:34.802+09:00  INFO 7556 --- [upload] [nio-9090-exec-7] h.u.c.ServletUploadControllerV1          : request = org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@4bdedea
2024-07-20T15:06:34.802+09:00  INFO 7556 --- [upload] [nio-9090-exec-7] h.u.c.ServletUploadControllerV1          : itemName = 123
2024-07-20T15:06:34.802+09:00  INFO 7556 --- [upload] [nio-9090-exec-7] h.u.c.ServletUploadControllerV1          : parts = [org.apache.catalina.core.ApplicationPart@a7a130d, org.apache.catalina.core.ApplicationPart@e45869a] // parts=[ApplicationPart1, ApplicationPart2]
```
  - request.getParmater("itemName")ì˜ ê²°ê³¼ë„ ì¶œë ¥. request.getParts()ì—ë„ ìš”ì²­í•œ ë‘ ê°€ì§€ ë©€í‹° íŒŒíŠ¸ì˜ ë¶€ë¶„ ë°ì´í„°ê°€ í¬í•¨ëœ ê²ƒ í™•ì¸ ê°€ëŠ¥
  - ì´ ì˜µì…˜ì„ ì¼œë©´ ë³µì¡í•œ ë©€í‹°íŒŒíŠ¸ ìš”ì²­ì„ ì²˜ë¦¬í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì œê³µ
  - ë¡œê·¸ë¥¼ ë³´ë©´ HttpServletRequest ê°ì²´ê°€ RequestFacade â†’ StandardMutlipartHttpServletRequestë¡œ ë³€í•œ ê²ƒ í™•ì¸ ê°€ëŠ¥

5. ì°¸ê³ ë¡œ spring.servlet.multipart.enabled ì˜µì…˜ì„ ì¼œë©´, ìŠ¤í”„ë§ì˜ DispatcherServletì—ì„œ ë©€í‹°íŒŒíŠ¸ ë¦¬ì¡¸ë²„(MultipartResolver)ë¥¼ ì‹¤í–‰
   - ë©€í‹°íŒŒíŠ¸ ë¦¬ì¡¸ë²„ëŠ” ë©€í‹°íŒŒíŠ¸ ìš”ì²­ì¸ ê²½ìš°, ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê°€ ì „ë‹¬í•˜ëŠ” ì¼ë°˜ì ì¸ HttpServletReqeuestë¥¼ MultipartHttpServletRequestë¡œ ë³€í™˜í•´ì„œ ë°˜í™˜
   - MultipartHttpServletRequestëŠ” HttpServletRequestì˜ ìì‹ ì¸í„°í˜ì´ìŠ¤ì´ê³ , ë©€í‹°íŒŒíŠ¸ì™€ ê´€ë ¨ëœ ì¶”ê°€ ê¸°ëŠ¥ ì œê³µ

6. ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ê¸°ë³¸ ë©€í‹°íŒŒíŠ¸ ë¦¬ì¡¸ë²„ëŠ” MultipartHttpServletRequest ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ StandardMultipartHttpServletRequestë¥¼ ë°˜í™˜
   - ì´ì œ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ HttpServletRequest ëŒ€ì‹ , MultipartHttpServletRequestë¥¼ ì£¼ì…ë°›ì„ ìˆ˜ ìˆëŠ”ë°, ì´ë¥¼ ì‚¬ìš©í•˜ë©´ ë©€í‹°íŒŒíŠ¸ì™€ ê´€ë ¨ëœ ì—¬ëŸ¬ ê°€ì§€ ì²˜ë¦¬ í¸ë¦¬í•˜ê²Œ ê°€ëŠ¥
   - ê·¸ëŸ°ë°, MultipartFileì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” í¸í•˜ë¯€ë¡œ MultipartHttpServletRequestë¥¼ ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
  
-----
### Part
-----
1. íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•œ ì‹¤ì œ íŒŒì¼ ê²½ë¡œ ì§€ì •
   - ğŸ’¡ í•´ë‹¹ ê²½ë¡œì— ì‹¤ì œ í´ë” ìƒì„± í›„, ì ˆëŒ€ ê²½ë¡œ ì…ë ¥
   - application.properties
```properties
ì˜ˆ) file.dir=C:/Users/lxx._.han/Desktop/workSpace/file
```
   - ë§ˆì§€ë§‰ì— /(ìŠ¬ë˜ì‹œ) í¬í•¨ ì£¼ì˜

2. ServletUploadControllerV2
```java
package hello.upload.controller;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.Part;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.util.StreamUtils;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;
import java.util.Collection;

@Slf4j
@Controller
@RequestMapping("/servlet/v2")
public class ServletUploadControllerV2 {

    @Value("${file.dir}")
    private String fileDir;

    @GetMapping("/upload")
    public String newFile() {
        return "upload-form";
    }
    
    @PostMapping("/upload")
    public String saveFile1V2(HttpServletRequest request) throws ServletException, IOException {
        log.info("request = {}", request);

        String itemName = request.getParameter("itemName");
        log.info("itemName = {}", itemName);

        Collection<Part> parts = request.getParts();
        log.info("parts = {}", parts);

        for (Part part : parts) {
            log.info("===== PART =====");
            log.info("name = {}", part.getName());
            Collection<String> headerNames = part.getHeaderNames();
            for (String headerName : headerNames) {
                log.info("header {} : {}", headerName, part.getHeader(headerName));
            }

            // í¸ì˜ ë©”ì„œë“œ
            // Content-Disposition; fileName
            log.info("submittedFileName = {}", part.getSubmittedFileName());
            log.info("size = {}" , part.getSize());

            // ë°ì´í„° ì½ê¸°
            InputStream inputStream = part.getInputStream();
            String body = StreamUtils.copyToString(inputStream, StandardCharsets.UTF_8);
            log.info("body = {}", body);

            // íŒŒì¼ì— ì €ì¥í•˜ê¸°
            if(StringUtils.hasText(part.getSubmittedFileName())) {
                String fullPath = fileDir + part.getSubmittedFileName();
                log.info("íŒŒì¼ ì €ì¥ fullPath = {}", fullPath);
                part.write(fullPath);
            }
        }
        return "upload-form";
    }
}
```

3. fileDir
```java
@Value("${file.dir}")
private String fileDir;
```
   - application.propertiesì—ì„œ ì„¤ì •í•œ file.dir ê°’ì„ ì£¼ì…
   - ë©€í‹°íŒŒíŠ¸ í˜•ì‹ì€ ì „ì†¡ ë°ì´í„°ë¥¼ í•˜ë‚˜í•˜ë‚˜ ê° ë¶€ë¶„(Part)ë¡œ ë‚˜ëˆ„ì–´ ì „ì†¡
   - partsì—ì„œëŠ” ë‚˜ëˆ„ì–´ì§„ ë°ì´í„°ê°€ ê°ê° ë‹´ê¹€
   - ì„œë¸”ë¦¿ì´ ì œê³µí•˜ëŠ” PartëŠ” ë©€í‹°íŒŒíŠ¸ í˜•ì‹ì„ í¸ë¦¬í•˜ê²Œ ì½ì„ ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ë©”ì„œë“œ ì œê³µ

4. Part ì£¼ìš” ë©”ì„œë“œ
   - part.getSumbittedName() : í´ë¼ì´ì–¸íŠ¸ê°€ ì „ë‹¬í•œ íŒŒì¼ëª…
   - part.getInputStream() : Partì˜ ì „ì†¡ ë°ì´í„° ì½ê¸°
   - part.write(...) : Partë¥¼ í†µí•´ ì „ì†¡ëœ ë°ì´í„° ì €ì¥

5. ê²°ê³¼ ë¡œê·¸
```
2024-07-22T15:30:52.731+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : ===== PART =====
2024-07-22T15:30:52.737+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : name = itemName
2024-07-22T15:30:52.738+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : header content-disposition : form-data; name="itemName"
2024-07-22T15:30:52.741+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : submittedFileName = null
2024-07-22T15:30:52.742+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : size = 6
2024-07-22T15:30:52.776+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : body = Spring
2024-07-22T15:30:52.776+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : ===== PART =====
2024-07-22T15:30:52.776+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : name = file
2024-07-22T15:30:52.777+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : header content-disposition : form-data; name="file"; filename="20240717_153529.png"
2024-07-22T15:30:52.778+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : header content-type : image/png
2024-07-22T15:30:52.779+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : submittedFileName = 20240717_153529.png
2024-07-22T15:30:52.781+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : size = 25357
2024-07-22T15:30:52.789+09:00  INFO 17240 --- [upload] [nio-9090-exec-1] h.u.c.ServletUploadControllerV2 : body = ï¿½PNG
```

6. í° ìš©ëŸ‰ íŒŒì¼ì„ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•ŒëŠ” ë¡œê·¸ê°€ ë§ì´ ë‚¨ìœ¼ë¯€ë¡œ ë‹¤ìŒ ì˜µì…˜ ì œê±°
```properties
logging.level.org.apache.coyote.http11=trace
```
   - ë˜í•œ, ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì¶œë ¥ ë¡œê·¸ë„ ì œê±°
```java
log.info("body = {}, body);
```

8. ì„œë¸”ë¦¿ì´ ì œê³µí•˜ëŠ” PartëŠ” í¸í•˜ê¸° í•˜ì§€ë§Œ, HttpServletRequestë¥¼ ì‚¬ìš©í•´ì•¼í•˜ê³ , ì¶”ê°€ë¡œ íŒŒì¼ ë¶€ë¶„ë§Œ êµ¬ë¶„í•˜ë ¤ë©´ ì—¬ëŸ¬ ì½”ë“œ í•„ìš”
