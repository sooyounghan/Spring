-----
### íŒŒì¼ ì—…ë¡œë“œ, ë‹¤ìš´ë¡œë“œ ì˜ˆì œ
-----
1. ìš”êµ¬ì‚¬í•­
   - ìƒí’ˆ ê´€ë¦¬
     + ìƒí’ˆ ì´ë¦„
     + ì²¨ë¶€íŒŒì¼ í•˜ë‚˜
     + ì´ë¯¸ì§€ íŒŒì¼ ì—¬ëŸ¬ ê°œ
   - ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ, ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥
   - ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸ ê°€ëŠ¥

2. Item - ìƒí’ˆ ë„ë©”ì¸
```java
package hello.upload.domain;

import lombok.Data;

import java.util.List;

@Data
public class Item {
    
    private Long id;
    private String itemName; // ìƒí’ˆ ì´ë¦„ 
    private UploadFile attachFile; // ì²¨ë¶€ íŒŒì¼
    private List<UploadFile> imageFiles; // ì²¨ë¶€ íŒŒì¼ ëª©ë¡
    
}
```

3. UploadFile - ì—…ë¡œë“œ íŒŒì¼ ì •ë³´ ë³´ê´€
```java
package hello.upload.domain;

import lombok.Data;

@Data
public class UploadFile {

    private String uploadFileName; // ê³ ê°ì´ ì—…ë¡œë“œí•œ íŒŒì¼ëª…
    private String storeFileName; // ì„œë²„ ë‚´ë¶€ì—ì„œ ê´€ë¦¬í•˜ëŠ” íŒŒì¼ëª…

    public UploadFile(String uploadFileName, String storeFileName) {
        this.uploadFileName = uploadFileName;
        this.storeFileName = storeFileName;
    }
}
```
  - uploadFileName : ê³ ê°ì´ ì—…ë¡œë“œí•œ íŒŒì¼ëª…
  - storeFileName : ì„œë²„ ë‚´ë¶€ì—ì„œ ê´€ë¦¬í•˜ëŠ” íŒŒì¼ëª…
  - ê³ ê°ì´ ì—…ë¡œë“œí•œ íŒŒì¼ëª…ìœ¼ë¡œ ì„œë²„ ë‚´ë¶€ì— íŒŒì¼ì„ ì €ì¥í•˜ë©´ ì•ˆ ë¨
  - ì„œë¡œ ë‹¤ë¥¸ ê³ ê°ì´ ê°™ì€ íŒŒì¼ì´ë¦„ì„ ì—…ë¡œë“œí•˜ëŠ” ê²½ìš° ê¸°ì¡´ íŒŒì¼ ì´ë¦„ê³¼ ì¶©ëŒì´ ì¼ì–´ë‚  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì„œë²„ì—ì„œëŠ” ì €ì¥í•  íŒŒì¼ëª…ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ë‚´ë¶€ì—ì„œ ê´€ë¦¬í•˜ëŠ” ë³„ë„ì˜ íŒŒì¼ëª…ì´ í•„ìš”

4. ItemRepository - ìƒí’ˆ ë ˆí¬ì§€í† ë¦¬
```java
package hello.upload.domain;

import org.springframework.stereotype.Repository;

import java.util.HashMap;
import java.util.Map;

@Repository
public class ItemRepository {
    
    private final Map<Long, Item> store = new HashMap<>();
    private long sequence = 0L;
    
    public Item save(Item item) {
        item.setId(++sequence);
        store.put(item.getId(), item);
        return item;
    }
    
    public Item findById(Long id) {
        return store.get(id);
    }
}
```

5. FileStore - íŒŒì¼ ì €ì¥ê³¼ ê´€ë ¨ëœ ì—…ë¬´ ì²˜ë¦¬
```java
package hello.upload.file;

import hello.upload.domain.UploadFile;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

@Component
public class FileStore {

    @Value("${file.dir}")
    private String fileDir;

    // íŒŒì¼ ì €ì¥í•  ê²½ë¡œ ì„¤ì •
    public String getFullPath(String fileName) {
        return fileDir + fileName;
    }

    // ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ ë¡œì§
    public List<UploadFile> storeFiles(List<MultipartFile> multipartFiles) throws IOException {
        List<UploadFile> storeFileResult = new ArrayList<>();

        for (MultipartFile multipartFile : multipartFiles) {
            if(!multipartFile.isEmpty()) {
                UploadFile uploadFile = storeFile(multipartFile);
                storeFileResult.add(uploadFile);
            }
        }
        return storeFileResult;
    }

    // íŒŒì¼ ì €ì¥ ë¡œì§
    public UploadFile storeFile(MultipartFile multipartFile) throws IOException {
        if(multipartFile.isEmpty()) {
            return null;
        }

        // í´ë¼ì´ì–¸íŠ¸ê°€ ì—…ë¡œë“œí•œ íŒŒì¼ëª…
        String originalFilename = multipartFile.getOriginalFilename();

        // ì„œë²„ì— ì €ì¥í•˜ëŠ” íŒŒì¼ëª…
        String storeFileName = createStoreFileName(originalFilename);

        // ì„œë²„ì— ì €ì¥í•˜ëŠ” íŒŒì¼ëª…ìœ¼ë¡œ ì €ì¥
        multipartFile.transferTo(new File(getFullPath(storeFileName)));

        return new UploadFile(originalFilename, storeFileName);
    }

    private String createStoreFileName(String originalFilename) {
        // UUID ì„¤ì • (ì„œë²„ì— ì €ì¥í•  ë¬´ì‘ìœ„ íŒŒì¼ëª…)
        String uuid = UUID.randomUUID().toString();
        String ext = extractExt(originalFilename); // í™•ì¥ì ì¶”ì¶œ
        return uuid + "." + ext;
    }

    // í´ë¼ì´ì–¸íŠ¸ê°€ ì—…ë¡œë“œí•œ íŒŒì¼ì—ì„œ í™•ì¥ì ì¶”ì¶œ
    private String extractExt(String originalFileName) {
        int pos = originalFileName.lastIndexOf(".");
        return originalFileName.substring(pos + 1);
    }
}
```

6. ë©€í‹°íŒŒíŠ¸ íŒŒì¼ì„ ì„œë²„ì— ì €ì¥í•˜ëŠ” ì—­í•  ë‹´ë‹¹
   - createStoreFile() : ì„œë²„ ë‚´ë¶€ì—ì„œ ê´€ë¦¬í•˜ëŠ” íŒŒì¼ëª…ì€ ìœ ì¼í•œ ì´ë¦„ì„ ìƒì„±í•˜ëŠ” UUIDë¥¼ ì‚¬ìš©í•´ì„œ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡œ í•´ì•¼í•¨
   - extractExt() : í™•ì¥ìë¥¼ ë³„ë„ë¡œ ì¶”ì¶œí•´ì„œ ë‚´ë¶€ì—ì„œ ê´€ë¦¬í•˜ëŠ” íŒŒì¼ëª…ì—ë„ ë¶™ì—¬ì¤Œ
     + ì˜ˆë¥¼ ë“¤ì–´ì„œ, ê³ ê°ì´ a.pngë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì—…ë¡œë“œí•˜ë©´ 51043-243-3kfa.pngì™€ ê°™ì´ ì €ì¥

7. ItemForm
```java
package hello.upload.controller;

import lombok.Data;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@Data
public class ItemForm {
    private Long itemId;
    private String itemName;
    private MultipartFile attachFile;
    private List<MultipartFile> imageFiles;
}
```

  - ìƒí’ˆ ì €ì¥ìš© í¼
  - ```List<MultipartFile> imageFiles``` : ì´ë¯¸ì§€ë¥¼ ë‹¤ì¤‘ ì—…ë¡œë“œ í•˜ê¸° ìœ„í•´ MultipartFile ì‚¬ìš©
  - ğŸ’¡ MultiprtFile attachFile : ë©€í‹°íŒŒíŠ¸ëŠ” @ModelAttributeì—ì„œ ì‚¬ìš© ê°€ëŠ¥

8. ItemController
```java
package hello.upload.controller;

import hello.upload.domain.Item;
import hello.upload.domain.ItemRepository;
import hello.upload.domain.UploadFile;
import hello.upload.file.FileStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.core.io.Resource;
import org.springframework.core.io.UrlResource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
import org.springframework.web.util.UriUtils;

import java.io.IOException;
import java.net.MalformedURLException;
import java.nio.charset.StandardCharsets;
import java.util.List;

@Slf4j
@Controller
@RequiredArgsConstructor
public class ItemController {

    private final ItemRepository itemRepository;
    private final FileStore fileStore;

    @GetMapping("/items/new")
    public String newItem(@ModelAttribute ItemForm form) {
        return "item-form";
    }

    @PostMapping("/items/new")
    public String saveItem(@ModelAttribute ItemForm form, RedirectAttributes redirectAttributes) throws IOException {

        // ì²¨ë¶€íŒŒì¼ í•œ ê°œ (ì‹¤ì œ íŒŒì¼ì´ ì•„ë‹Œ ê²½ë¡œë§Œ ì €ì¥)
        UploadFile attachFile = fileStore.storeFile(form.getAttachFile());

        // ì´ë¯¸ì§€ íŒŒì¼ ì—¬ëŸ¬ ê°œ (ì‹¤ì œ íŒŒì¼ì´ ì•„ë‹Œ ê²½ë¡œë§Œ ì €ì¥)
        List<UploadFile> storeImageFiles = fileStore.storeFiles(form.getImageFiles());

        // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
        Item item = new Item();
        item.setItemName(form.getItemName());
        item.setAttachFile(attachFile);
        item.setImageFiles(storeImageFiles);
        itemRepository.save(item);

        redirectAttributes.addAttribute("itemId", item.getId());

        return "redirect:/items/{itemId}";
    }

    @GetMapping("/items/{id}")
    public String items(@PathVariable Long id, Model model) {
        Item item = itemRepository.findById(id);
        model.addAttribute("item", item);

        return "item-view";
    }

    @ResponseBody
    @GetMapping("/images/{fileName}")
    public Resource downloadImage(@PathVariable String fileName) throws MalformedURLException {
        // file:C:/Users/... (íŒŒì¼ ìœ„ì¹˜ ê²½ë¡œ) ì— ì ‘ê·¼
        // ì˜ˆ) 7ada79ff-bfc0-4bf1-a9b1-4b8e218968f7.png -> file:/Users/.../file/7ada79ff-bfc0-4bf1-a9b1-4b8e218968f7.png (íŒŒì¼ë¡œ ì ‘ê·¼)
        return new UrlResource("file:" + fileStore.getFullPath(fileName));
    }

    @GetMapping("/attach/{itemId}")
    public ResponseEntity<Resource> downloadAttach(@PathVariable Long itemId) throws MalformedURLException {
        Item item = itemRepository.findById(itemId);

        String storeFileName = item.getAttachFile().getStoreFileName();
        String uploadFileName = item.getAttachFile().getUploadFileName();

        UrlResource resource = new UrlResource("file:" + fileStore.getFullPath(storeFileName));

        log.info("uploadFileName = {}", uploadFileName);

        // í•œê¸€ ì œëª© ê¹¨ì§ ë¬¸ì œ í•´ê²°
        String encodedUploadFileName = UriUtils.encode(uploadFileName, StandardCharsets.UTF_8);

        // ContentDisposition í—¤ë” ì¶”ê°€
        String contentDisposition = "attachment; filename=\"" + encodedUploadFileName + "\"";
        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, contentDisposition)
                .body(resource);
    }
}
```
  - @GetMapping("/items/new") : ë“±ë¡ í¼ì„ ë³´ì—¬ì¤Œ
  - @PostMapping("/items/new") : í¼ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ë³´ì—¬ì£¼ëŠ” í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  - @GetMapping("/items/{id}") : ìƒí’ˆì„ ë³´ì—¬ì¤Œ
  - @GetMapping("/images/{fileName}") : ```<img>```íƒœê·¸ë¡œ ì´ë¯¸ì§€ë¥¼ ì¡°íšŒí•  ë•Œ ì‚¬ìš©
    + ğŸ’¡ UrlResourceë¡œ ì´ë¯¸ì§€ íŒŒì¼ì„ ì½ì–´ì„œ @ResponseBodyë¡œ ì´ë¯¸ì§€ ë°”ì´ë„ˆë¦¬ë¥¼ ë°˜í™˜
  - @GetMapping("/attach/{itemId}") : íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ë•Œ ì‹¤í–‰
    + íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œ ê¶Œí•œ ì²´í¬ê°™ì€ ë³µì¡í•œ ìƒí™©ì„ ê³ ë ¤í•´ ì´ë¯¸ì§€ idë¥¼ ìš”ì²­
    + ğŸ’¡ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì—ëŠ” ê³ ê°ì´ ì—…ë¡œë“œí•œ íŒŒì¼ ì´ë¦„ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
    + ğŸ’¡ ì´ ë•ŒëŠ” Content-Disposition í—¤ë”ì— attachment; fileName="ì—…ë¡œë“œ íŒŒì¼ëª…" ê°’ì„ ì£¼ë©´ ë¨
     
9. ë“±ë¡ í¼ ë·° (resources/templates/item-form.html)
```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
</head>
<body>
<div class="container">
    <div class="py-5 text-center">
        <h2>ìƒí’ˆ ë“±ë¡</h2>
    </div>
    <form th:action method="post" enctype="multipart/form-data">
        <ul>
            <li>ìƒí’ˆëª… <input type="text" name="itemName"></li>
            <li>ì²¨ë¶€íŒŒì¼<input type="file" name="attachFile" ></li>
            <li>ì´ë¯¸ì§€ íŒŒì¼ë“¤<input type="file" multiple="multiple" name="imageFiles" ></li>
        </ul>
        <input type="submit"/>
    </form>
</div> <!-- /container -->
</body>
</html>
```
  - ```<input type="file" multiple="multiple" name="imageFiles" >```
    + ğŸ’¡ ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œë¥¼ í•˜ê¸°ìœ„í•´ multiple="multiple" ì˜µì…˜
    + ItemFormì˜ ë‹¤ìŒ ì½”ë“œì—ì„œ ì—¬ëŸ¬ ì´ë¯¸ì§€ íŒŒì¼ì„ ë°›ì„ ìˆ˜ ìˆìŒ : ```private List<MultipartFile> imageFiles;```

10. ì¡°íšŒ ë·° (resources/templates/item-view.html)
```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
</head>
<body>
<div class="container">
    <div class="py-5 text-center">
        <h2>ìƒí’ˆ ì¡°íšŒ</h2>
    </div>
    ìƒí’ˆëª…: <span th:text="${item.itemName}">ìƒí’ˆëª…</span><br/>
    ì²¨ë¶€íŒŒì¼: <a th:if="${item.attachFile}" th:href="|/attach/${item.id}|" th:text="${item.getAttachFile().getUploadFileName()}" /><br/>
    <img th:each="imageFile : ${item.imageFiles}" th:src="|/images/${imageFile.getStoreFileName()}|" width="300" height="300"/>
</div> <!-- /container -->
</body>
</html>
```
  - ì²¨ë¶€ íŒŒì¼ì€ ë§í¬ë¡œ ê±¸ì–´ë‘ê³ , ì´ë¯¸ì§€ëŠ” ```<img>``` íƒœê·¸ë¥¼ ë°˜ë³µí•´ì„œ ì¶œë ¥
