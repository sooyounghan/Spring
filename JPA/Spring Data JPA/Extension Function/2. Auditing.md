-----
### Auditing
-----
1. ì—”í‹°í‹°ì— ìƒì„±, ë³€ê²½í•  ë•Œ ë³€ê²½í•œ ì‚¬ëŒê³¼ ì‹œê°„ì„ ì¶”ì í•˜ê³  ì‹¶ìœ¼ë©´?
   - ë“±ë¡ì¼
   - ìˆ˜ì •ì¼
   - ë“±ë¡ì
   - ìˆ˜ì •ì

2. ìˆœìˆ˜ JPA ì‚¬ìš©
   - ìš°ì„  ë“±ë¡ì¼, ìˆ˜ì •ì¼ ì ìš©
```java
package study.data_jpa.entity;

import jakarta.persistence.Column;
import jakarta.persistence.MappedSuperclass;
import jakarta.persistence.PrePersist;
import jakarta.persistence.PreUpdate;
import lombok.Getter;

import java.time.LocalDateTime;

@MappedSuperclass // ì†ì„± ìƒì†
@Getter
public class JpaBaseEntity {

    @Column(updatable = false)
    private LocalDateTime createDate;
    private LocalDateTime updateDate;

    @PrePersist
    public void prePersist() {
        LocalDateTime now = LocalDateTime.now();
        createDate = now;
        updateDate = now;
    }

    @PreUpdate
    public void preUpdate() {
        updateDate = LocalDateTime.now();
    }
}
```

  - í™•ì¸ ì½”ë“œ
```java
@Test
public void JpaEventBaseEntity() throws InterruptedException {
    // Given
    Member member = new Member("member1");
    memberRepository.save(member); // @PrePersist

    Thread.sleep(100);
    member.setUsername("member2");

    em.flush(); // @PreUpdate
    em.clear();

    // When
    Member findMember = memberRepository.findById(member.getId()).get();

    // Then
    System.out.println("findMember.getCreateDate = " + findMember.getCreateDate());
    System.out.println("findMember.getUpdateDate = " + findMember.getUpdateDate());
}
```

3. JPA ì£¼ìš” ì´ë²¤íŠ¸ ì• ë„ˆí…Œì´ì…˜
   - @PrePersist, @PostPersist
   - @PreUpdate, @PostUpdate

-----
### ìŠ¤í”„ë§ ë°ì´í„° JPA ì‚¬ìš©
-----
1. ì„¤ì •
   - ğŸ’¡ @EnableJpaAuditing : ìŠ¤í”„ë§ ë¶€íŠ¸ ì„¤ì • í´ë˜ìŠ¤ì— ì ìš©í•´ì•¼í•¨
```java
package study.data_jpa;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.data.jpa.repository.config.EnableJpaAuditing;

@EnableJpaAuditing
@SpringBootApplication
public class DataJpaApplication {

	public static void main(String[] args) {
		SpringApplication.run(DataJpaApplication.class, args);
	}

}
```

   - ğŸ’¡ @EntityListener(AuditingEntityListener.class) : ì—”í‹°í‹°ì— ì ìš©
```java
@EntityListeners(AuditingEntityListener.class)
public class BaseEntity {

	...

}
```

2. ì‚¬ìš© ì• ë„ˆí…Œì´ì…˜
   - @CreateDate
   - @LastModifiedDate
   - @CreateBy
   - @LastModifiedBy

3. ìŠ¤í”„ë§ ë°ì´í„° Auditing ì ìš© - ë“±ë¡ì¼, ìˆ˜ì •ì¼
```java
package study.data_jpa.entity;


import jakarta.persistence.Column;
import jakarta.persistence.EntityListeners;
import jakarta.persistence.MappedSuperclass;
import lombok.Getter;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;

@MappedSuperclass
@Getter
@EntityListeners(AuditingEntityListener.class)
public class BaseEntity {
    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createDate;
    
    @LastModifiedDate
    private LocalDateTime lastModifiedDate;
}
```

4. ìŠ¤í”„ë§ ë°ì´í„° Auditing ì ìš© - ë“±ë¡ì, ìˆ˜ì •ì
```java
package study.data_jpa.entity;


import jakarta.persistence.Column;
import jakarta.persistence.EntityListeners;
import jakarta.persistence.MappedSuperclass;
import lombok.Getter;
import org.springframework.data.annotation.CreatedBy;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedBy;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;

@MappedSuperclass
@Getter
@EntityListeners(AuditingEntityListener.class)
public class BaseEntity {
    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createDate;

    @LastModifiedDate
    private LocalDateTime lastModifiedDate;

    @CreatedBy
    @Column(updatable = false)
    private String createBy;

    @LastModifiedBy
    private String lastModifiedBy;
}
```

5. ë“±ë¡ì, ìˆ˜ì •ìë¥¼ ì²˜ë¦¬í•´ì£¼ëŠ” AuditorAware ìŠ¤í”„ë§ ë¹ˆ ë“±ë¡
```java
package study.data_jpa;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.data.domain.AuditorAware;
import org.springframework.data.jpa.repository.config.EnableJpaAuditing;

import java.util.Optional;
import java.util.UUID;

@EnableJpaAuditing
@SpringBootApplication
public class DataJpaApplication {

	public static void main(String[] args) {
		SpringApplication.run(DataJpaApplication.class, args);
	}

	@Bean
	public AuditorAware<String> auditorProvider() {
		return () -> Optional.of(UUID.randomUUID().toString());
		
		/*
		 	return new AuditorAware<String>() {
			 	 @Override
			 	 public Optional<String> getCurrentAuditor() {
			 	 		return Optional.of(UUID.randomUUID().toString());
			 	 }
			}
		 */
	}
}
```
  - ì£¼ì˜ : DataApplicationì— @EnableJpaAuditingë„ í•¨ê»˜ ë“±ë¡í•´ì•¼í•¨
  - ì‹¤ë¬´ì—ì„œëŠ” ì„¸ì…˜ ì •ë³´ë‚˜, ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ë¡œê·¸ì¸ ì •ë³´ì—ì„œ IDë¥¼ ë°›ìŒ
```java
@Test
public void JpaEventBaseEntity() throws InterruptedException {
    // Given
    Member member = new Member("member1");
    memberRepository.save(member); // @PrePersist

    Thread.sleep(100);
    member.setUsername("member2");

    em.flush(); // @PreUpdate
    em.clear();

    // When
    Member findMember = memberRepository.findById(member.getId()).get();

    // Then
    System.out.println("findMember.getCreateDate = " + findMember.getCreateDate());
    System.out.println("findMember.getUpdateDate = " + findMember.getLastModifiedDate());
    System.out.println("findMember.getCreateBy = " + findMember.getCreateBy());
    System.out.println("findMember.getLastModifiedBy = " + findMember.getLastModifiedBy());
}
```

6. ì‹¤ë¬´ì—ì„œëŠ” ëŒ€ë¶€ë¶„ ì—”í‹°í‹°ì˜ ë“±ë¡ì‹œê°„, ìˆ˜ì •ì‹œê°„ì´ í•„ìš”í•˜ì§€ë§Œ, ë“±ë¡ì, ìˆ˜ì •ìëŠ” ì—†ì„ ìˆ˜ë„ ìˆìŒ
7. ë”°ë¼ì„œ, Base íƒ€ì…ì„ ë¶„ë¦¬í•˜ê³ , ì›í•˜ëŠ” íƒ€ì…ì„ ì„ íƒí•´ì„œ ìƒì†
```java
public class BaseTimeEntity {
    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime lastModifiedDate;
}
```
```java
public class BaseEntity extends BaseTimeEntity {
    @CreatedBy
    @Column(updatable = false)
    private String createdBy;

    @LastModifiedBy
    private String lastModifiedBy;
}
```

8. ì°¸ê³ 
   - ì €ì¥ ì‹œì ì— ë“±ë¡ì¼, ë“±ë¡ìëŠ” ë¬¼ë¡ ì´ê³ , ìˆ˜ì •ì¼, ìˆ˜ì •ìë„ ê°™ì€ ë°ì´í„°ê°€ ì €ì¥
   - ë°ì´í„°ê°€ ì¤‘ë³µ ì €ì¥ë˜ëŠ” ê²ƒ ê°™ì§€ë§Œ, ì´ë ‡ê²Œ í•´ë‘ë©´ ë³€ê²½ ì»¬ëŸ¼ë§Œ í™•ì¸ í•´ë„ ë§ˆì§€ë§‰ì— ì—…ë°ì´íŠ¸í•œ ìœ ì €ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìœ ì§€ë³´ìˆ˜ ê´€ì ì—ì„œ í¸ë¦¬
   - ì´ë ‡ê²Œ í•˜ì§€ ì•Šìœ¼ë©´ ë³€ê²½ ì»¬ë¦¼ì´ nullì¼ ë•Œ, ë“±ë¡ ì»¬ëŸ¼ì„ ë˜ ì°¾ì•„ì•¼í•¨
   - ğŸ’¡ ì°¸ê³ ë¡œ ì €ì¥ ì‹œì (Create ì‹œì )ì— ì €ì¥ ë°ì´í„°ë§Œ ì…ë ¥í•˜ê³  ì‹¶ìœ¼ë©´, @EnableJpaAuditing(modifyOnCreate = false) ì˜µì…˜ ì‚¬ìš©

9. ì „ì²´ ì ìš©
    - @EntityListeners(AuditingEntityListener.class)ë¥¼ ìƒëµí•˜ê³  ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ì œê³µí•˜ëŠ” ì´ë²¤íŠ¸ë¥¼ ì—”í‹°í‹° ì „ì²´ì— ì ìš©í•˜ë ¤ë©´ orm.xmlì— ë‹¤ìŒê³¼ ê°™ì´ ë“±ë¡
    - META-INF/orm.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings xmlns="http://xmlns.jcp.org/xml/ns/persistence/orm"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence/orm http://xmlns.jcp.org/xml/ns/persistence/orm_2_2.xsd"
                version="2.2">

    <persistence-unit-metadata>
        <persistence-unit-defaults>
            <entity-listeners>
                <entity-listener 
                    class="org.springframework.data.jpa.domain.support.AuditingEntityListener"/>
                </entity-listeners>
        </persistence-unit-defaults>
     </persistence-unit-metadata>
</entity-mappings>
```
