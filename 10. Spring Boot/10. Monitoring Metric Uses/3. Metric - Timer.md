-----
### ë©”íŠ¸ë¦­ ë“±ë¡ 3 - Timer
-----
1. TimerëŠ” íŠ¹ë³„í•œ ë©”íŠ¸ë¦­ ì¸¡ì • ë„êµ¬ì¸ë°, ì‹œê°„ì„ ì¸¡ì •í•˜ëŠ”ë° ì‚¬ìš©
   - ğŸ’¡ ì¹´ìš´í„°ì™€ ìœ ì‚¬í•˜ë‚˜, Timerë¥¼ ì‚¬ìš©í•˜ë©´ ì‹¤í–‰ ì‹œê°„ë„ í•¨ê»˜ ì¸¡ì • ê°€ëŠ¥
   - ë‹¤ìŒê³¼ ê°™ì€ ë‚´ìš©ì„ í•œ ë²ˆì— ì¸¡ì •
     + ğŸ’¡ seconds_count : ëˆ„ì  ì‹¤í–‰ ìˆ˜ - ì¹´ìš´í„°
     + ğŸ’¡ seconds_sum : ì‹¤í–‰ ì‹œê°„ì˜ í•© - sum
     + ğŸ’¡ seconds_max : ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ (ê°€ì¥ ì˜¤ë˜ ê±¸ë¦° ì‹¤í–‰ ì‹œê°„) - ê²Œì´ì§€
       * ğŸ’¡ ë‚´ë¶€ì— íƒ€ì„ ìœˆë„ìš°ë¼ëŠ” ê°œë…ì´ ìˆì–´ì„œ 1-3ë¶„ ë§ˆë‹¤ ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ì´ ë‹¤ì‹œ ê³„ì‚°

2. OrderServiceV3
```java
package hello.order.v3;

import hello.order.OrderService;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;
import lombok.extern.slf4j.Slf4j;

import java.util.Random;
import java.util.concurrent.atomic.AtomicInteger;

@Slf4j
public class OrderServiceV3 implements OrderService {

    private final MeterRegistry registry;
    private AtomicInteger stock = new AtomicInteger(100);

    public OrderServiceV3(MeterRegistry registry) {
        this.registry = registry;
    }

    @Override
    public void order() {
        Timer timer = Timer.builder("my.order")
                .tag("class", this.getClass().getName())
                .tag("method", "order")
                .description("order")
                .register(registry);

        timer.record(() -> {
            log.info("ì£¼ë¬¸");
            stock.decrementAndGet();
            sleep(500);
        });
    }

    @Override
    public void cancel() {
        Timer timer = Timer.builder("my.order")
                .tag("class", this.getClass().getName())
                .tag("method", "cancel")
                .description("cancel")
                .register(registry);

        timer.record(() -> {
            log.info("ì·¨ì†Œ");
            stock.incrementAndGet();
            sleep(200);
        });
    }

    private static void sleep(int l) {
        try {
            Thread.sleep(l + new Random().nextInt(200)); // ìµœëŒ€ 200ms ì‚¬ì´ì˜ ê°’ ì¶”ê°€í•´ sleep
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public AtomicInteger getStock() {
        return stock;
    }
}
```
  - ğŸ’¡ Timer.builder(name) : íƒ€ì´ë¨¸ë¥¼ ìƒì„± (nameì—ëŠ” ë©”íŠ¸ë¦­ ì´ë¦„ ì§€ì •)
  - ğŸ’¡ tagë¥¼ ì‚¬ìš© : í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œëŠ” í•„í„°í•  ìˆ˜ ìˆëŠ” ë ˆì´ë¸”ë¡œ ì‚¬ìš©
  - ğŸ’¡ ì£¼ë¬¸ê³¼ ì·¨ì†ŒëŠ” ë©”íŠ¸ë¦­ì´ ê°™ê³ , tagë¥¼ í†µí•´ êµ¬ë¶„í•˜ë„ë¡ ì„¤ì •
  - ğŸ’¡ register(registry) : ë§Œë“  íƒ€ì´ë¨¸ë¥¼ MeterRegistryì— ë“±ë¡ (ì´ë ‡ê²Œ ë“±ë¡í•´ì•¼ ì‹¤ì œ ë™ì‘)
  - ğŸ’¡ íƒ€ì´ë¨¸ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” timer.record()ë¥¼ ì‚¬ìš© : ê·¸ ì•ˆì— ì‹œê°„ì„ ì¸¡ì •í•  ë‚´ìš©ì„ í•¨ìˆ˜ë¡œ í¬í•¨í•˜ë©´ ë¨

3. ê±¸ë¦¬ëŠ” ì‹œê°„ì„ í™•ì¸í•˜ê¸° ìœ„í•´ ì£¼ë¬¸ì€ 0.5ì´ˆ / ì·¨ì†ŒëŠ” 0.2ì´ˆ ëŒ€ê¸°
   - ê°€ì¥ ì˜¤ë˜ ê±¸ë¦° ì‹œê°„ì„ í™•ì¸í•˜ê¸° ìœ„í•´ sleep()ì—ì„œ ìµœëŒ€ 0.2ì´ˆ ëœë¤í•˜ê²Œ ë” ì¶”ê°€
   - ëª¨ë‘ 0.5ì´ˆë¡œ ê°™ìœ¼ë©´ ê°€ì¥ ì˜¤ë˜ ê±¸ë¦° ì‹œê°„ í™•ì¸í•˜ê¸° ì–´ë ¤ì›€

4. OrderConfigV3
```java
package hello.order.v3;

import hello.order.OrderService;
import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OrderConfigV3 {

    @Bean
    public OrderService orderService(MeterRegistry registry) {
        return new OrderServiceV3(registry);
    }
}
```
5. ActuatorApplicatin ë³€ê²½
```java
package hello;

import hello.order.v0.OrderConfigV0;
import hello.order.v1.OrderConfigV1;
import hello.order.v2.OrderConfigV2;
import hello.order.v3.OrderConfigV3;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.actuate.web.exchanges.InMemoryHttpExchangeRepository;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;

// @Import(OrderConfigV0.class)
// @Import(OrderConfigV1.class)
// @Import(OrderConfigV2.class)
@Import(OrderConfigV3.class)
@SpringBootApplication(scanBasePackages = "hello.controller")
public class ActuatorApplication {

    public static void main(String[] args) {
        SpringApplication.run(ActuatorApplication.class, args);
    }
}
```

  - OrderConfigV2ì—ì„œ OrderConfigV3ìœ¼ë¡œ ë³€ê²½

  - ì£¼ë¬¸, ì·¨ì†Œ ê° í•œ ë²ˆì”© ì‹¤í–‰í•œ ë‹¤ìŒ, ë©”íŠ¸ë¦­ í™•ì¸ (http://localhost:7070/actuator/metrics/my.order)
```json
{
    "name": "my.order",
    "description": "order",
    "baseUnit": "seconds",
    "measurements": [
        {
            "statistic": "COUNT",
            "value": 9.0
        },
        {
            "statistic": "TOTAL_TIME",
            "value": 4.4094905
        },
        {
            "statistic": "MAX",
            "value": 0.6599592
        }
    ],
    "availableTags": [
        {
            "tag": "method",
            "values": [
                "cancel",
                "order"
            ]
        },
        {
            "tag": "class",
            "values": [
                "hello.order.v3.OrderServiceV3"
            ]
        }
    ]
}
```
  - ğŸ’¡ measurements í•­ëª©ì„ ë³´ë©´ COUNT, TOTAL_TIME, MAX ì´ 3ê°€ì§€ í•­ëª© í™•ì¸
    + ğŸ’¡ COUNT : ëˆ„ì  ì‹¤í–‰ ìˆ˜ (= ì¹´ìš´í„°)
    + ğŸ’¡ TOTAL_TIME : ì‹¤í–‰ ì‹œê°„ì˜ í•© (ê° ì‹¤í–‰ ì‹œê°„ì˜ ëˆ„ì  í•©)
    + ğŸ’¡ MAX : ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ (ê°€ì¥ ì˜¤ë˜ ê±¸ë¦° ì‹¤í–‰ ì‹œê°„)
  - íƒ€ì´ë¨¸ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ 3ê°€ì§€ ì¸¡ì • í•­ëª© ìƒê¹€

6. í”„ë¡œë©”í…Œìš°ìŠ¤ í¬ë§· ë©”íŠ¸ë¦­ í™•ì¸
```
# HELP my_order_seconds order
# TYPE my_order_seconds summary
my_order_seconds_count{class="hello.order.v3.OrderServiceV3",method="order",} 5.0
my_order_seconds_sum{class="hello.order.v3.OrderServiceV3",method="order",} 3.0904427
my_order_seconds_count{class="hello.order.v3.OrderServiceV3",method="cancel",} 4.0
my_order_seconds_sum{class="hello.order.v3.OrderServiceV3",method="cancel",} 1.3190478

# HELP my_order_seconds_max order
# TYPE my_order_seconds_max gauge
my_order_seconds_max{class="hello.order.v3.OrderServiceV3",method="order",} 0.6599592
my_order_seconds_max{class="hello.order.v3.OrderServiceV3",method="cancel",} 0.3997817
```
  - ğŸ’¡ í”„ë¡œë©”í…Œìš°ìŠ¤ë¡œ ë‹¤ìŒ ì ‘ë‘ì‚¬ê°€ ë¶™ìœ¼ë©´ì„œ 3ê°€ì§€ ë©”íŠ¸ë¦­ ì œê³µ
    + ğŸ’¡ seconds_count : ëˆ„ì  ì‹¤í–‰ ìˆ˜
    + ğŸ’¡ seconds_sum : ì‹¤í–‰ ì‹œê°„ì˜ í•©
    + ğŸ’¡ seconds_max : ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ (ê°€ì¥ ì˜¤ë˜ ê±¸ë¦° ì‹¤í–‰ ì‹œê°„), í”„ë¡œë©”í…Œìš°ìŠ¤ gague
      * ğŸ’¡ ì°¸ê³  : ë‚´ë¶€ì— íƒ€ì„ ìœˆë„ìš°ë¼ëŠ” ê°œë…ì´ ìˆì–´ì„œ 1 ~ 3ë¶„ë§ˆë‹¤ ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ ë‹¤ì‹œ ê³„ì‚°ë¨
  - í‰ê·  ì‹¤í–‰ ì‹œê°„ë„ ê³„ì‚° ê°€ëŠ¥
    + ğŸ’¡ seconds_sum / seconds_count = í‰ê·  ì‹¤í–‰ ì‹œê°„

7. ê·¸ë¼íŒŒë‚˜ ë“±ë¡ - ì£¼ë¬¸ìˆ˜ V3
   - hello-dashboardì— ì£¼ë¬¸ìˆ˜, ìµœì†Œìˆ˜ ê·¸ë˜í”„ ì¶”ê°€
   - íŒ¨ë„ ì˜µì…˜ - Title : ì£¼ë¬¸ìˆ˜ v3
   - PromQL
     + increase(my_order_seconds_count{method="order"}[1m]) / Legend : {{method}} = order
     + increase(my_order_seconds_count{method="cancel"}[1m]) / Legend : {{method}} = cancel
   - ğŸ’¡ ì°¸ê³  : ì¹´ìš´í„°ëŠ” ê²Œì† ì¦ê°€í•˜ë¯€ë¡œ íŠ¹ì • ì‹œê°„ì— ì–¼ë§ˆë‚˜ ì¦ê°€í–ˆëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ increase(), rate() ê°™ì€ í•¨ìˆ˜ë¥¼ ê°™ì´ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
<div align="center">
<img src="https://github.com/user-attachments/assets/302c1040-5f48-47eb-911a-d5cd18c67078">
</div>

8. ê·¸ë¼íŒŒë‚˜ ë“±ë¡ - ìµœëŒ€ ì‹¤í–‰ ì‹œê°„ (Gauge)
   - íŒ¨ë„ ì˜µì…˜ - Title : ìµœëŒ€ ì‹¤í–‰ ì‹œê°„
   - PromQL : my_order_seconds_max
<div align="center">
<img src="https://github.com/user-attachments/assets/90843359-0c56-49fa-afdf-ca09ee462952">
</div>

9. ê·¸ë¼íŒŒë‚˜ ë“±ë¡ - í‰ê·  ì‹¤í–‰ ì‹œê°„
   - íŒ¨ë„ ì˜µì…˜ - Title : í‰ê·  ì‹¤í–‰ ì‹œê°„
   - ğŸ’¡ PromQL : increase(my_order_seconds_sum[1m]) / increase(my_order_seconds_count[1m])
<div align="center">
<img src="https://github.com/user-attachments/assets/d8c66e8a-84b7-4620-9ae8-b4ee46a907ea">
</div>

-----
### ë©”íŠ¸ë¦­ ë“±ë¡ 4 - @Timed
-----
1. íƒ€ì´ë¨¸ëŠ” @Timedë¼ëŠ” ì• ë„ˆí…Œì´ì…˜ì„ í†µí•´ AOP ì ìš© ê°€ëŠ¥
2. OrderServiceV4
```java
package hello.order.v4;

import hello.order.OrderService;
import io.micrometer.core.annotation.Timed;
import lombok.extern.slf4j.Slf4j;

import java.util.Random;
import java.util.concurrent.atomic.AtomicInteger;

@Timed(value = "my.order") // @Timed("my.order") Class Level
@Slf4j
public class OrderServiceV4 implements OrderService {

    private AtomicInteger stock = new AtomicInteger(100);

    @Override
    public void order() {
        log.info("ì£¼ë¬¸");
        stock.decrementAndGet();
        sleep(500);
    }

    @Override
    public void cancel() {
        log.info("ì·¨ì†Œ");
        stock.incrementAndGet();
        sleep(200);
    }

    private static void sleep(int l) {
        try {
            Thread.sleep(l + new Random().nextInt(200)); // ìµœëŒ€ 200ms ì‚¬ì´ì˜ ê°’ ì¶”ê°€í•´ sleep
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public AtomicInteger getStock() {
        return stock;
    }
}
```
  - ğŸ’¡ @Timed("my.order") : íƒ€ì…ì´ë‚˜ ë©”ì„œë“œ ì¤‘ì— ì ìš© ê°€ëŠ¥
  - ğŸ’¡ íƒ€ì…ì— ì ìš©í•˜ë©´ í•´ë‹¹ íƒ€ì…ì˜ ëª¨ë“  public ë©”ì„œë“œì— íƒ€ì´ë¨¸ê°€ ì ìš©
    + ë”°ë¼ì„œ, ìœ„ ê²½ìš° getStock()ì—ë„ íƒ€ì´ë¨¸ê°€ ì ìš©

3. OrderConfigV4
```java
package hello.order.v4;

import hello.order.OrderService;
import io.micrometer.core.aop.TimedAspect;
import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OrderConfigV4 {

    @Bean
    public OrderService orderService() {
        return new OrderServiceV4();
    }

    @Bean
    public TimedAspect timedAspect(MeterRegistry registry) {
        return new TimedAspect(registry);
    }
}
```
  - ğŸ’¡ TimedAspectë¥¼ ì ìš©í•´ì•¼ @Timedì— AOPê°€ ì ìš©

4. ActuatorApplication ë³€ê²½
```java
package hello;

import hello.order.v0.OrderConfigV0;
import hello.order.v1.OrderConfigV1;
import hello.order.v2.OrderConfigV2;
import hello.order.v3.OrderConfigV3;
import hello.order.v4.OrderConfigV4;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.actuate.web.exchanges.InMemoryHttpExchangeRepository;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;

// @Import(OrderConfigV0.class)
// @Import(OrderConfigV1.class)
// @Import(OrderConfigV2.class)
// @Import(OrderConfigV3.class)
@Import(OrderConfigV4.class)
@SpringBootApplication(scanBasePackages = "hello.controller")
public class ActuatorApplication {

    public static void main(String[] args) {
        SpringApplication.run(ActuatorApplication.class, args);
    }
}
```
  - OrderConfigV3ì—ì„œ OrderConfigV4ë¡œ ë³€ê²½
  - ì£¼ë¬¸ê³¼ ì·¨ì†Œë¥¼ ê° í•œ ë²ˆì”© ì‹¤í–‰í•œ ë‹¤ìŒ ë©”íŠ¸ë¦­ í™•ì¸
  - ì•¡ì¸„ì—ì´í„° ë©”íŠ¸ë¦­ í™•ì¸
```json
{
    "name": "my.order",
    "baseUnit": "seconds",
    "measurements": [
        {
            "statistic": "COUNT",
            "value": 2.0
        },
        {
            "statistic": "TOTAL_TIME",
            "value": 1.0948664
        },
        {
            "statistic": "MAX",
            "value": 0.6984928
        }
    ],
    "availableTags": [
        {
            "tag": "exception",
            "values": [
                "none"
            ]
        },
        {
            "tag": "method",
            "values": [
                "cancel",
                "order"
            ]
        },
        {
            "tag": "class",
            "values": [
                "hello.order.v4.OrderServiceV4"
            ]
        }
    ]
}
```
  - tag ì¤‘ exception ì¶”ê°€ ë˜ëŠ” ë¶€ë¶„ ì œì™¸ ê¸°ì¡´ê³¼ ë™ì¼
  - íƒ€ì´ë¨¸ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ 3ê°€ì§€ ì¸¡ì • í•­ëª©ì´ ìƒê¸°ëŠ” ê²ƒ í™•ì¸ ê°€ëŠ¥
  - í”„ë¡œë©”í…Œìš°ìŠ¤ í¬ë§· ë©”íŠ¸ë¦­ í™•ì¸
```
# HELP my_order_seconds  
# TYPE my_order_seconds summary
my_order_seconds_count{class="hello.order.v4.OrderServiceV4",exception="none",method="cancel",} 1.0
my_order_seconds_sum{class="hello.order.v4.OrderServiceV4",exception="none",method="cancel",} 0.3963736
my_order_seconds_count{class="hello.order.v4.OrderServiceV4",exception="none",method="order",} 1.0
my_order_seconds_sum{class="hello.order.v4.OrderServiceV4",exception="none",method="order",} 0.6984928

# HELP my_order_seconds_max  
# TYPE my_order_seconds_max gauge
my_order_seconds_max{class="hello.order.v4.OrderServiceV4",exception="none",method="cancel",} 0.3963736
my_order_seconds_max{class="hello.order.v4.OrderServiceV4",exception="none",method="order",} 0.6984928
```
  - ìƒì„±ë˜ëŠ” í”„ë¡œë©”í…Œìš°ìŠ¤ í¬ë§·ë„ ê¸°ì¡´ê³¼ ë™ì¼
  - ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œ ì—­ì‹œ ë©”íŠ¸ë¦­ ì´ë¦„ê³¼ tagê°€ ê°™ìœ¼ë¯€ë¡œ ê°™ìœ¼ ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸ ê°€ëŠ¥
