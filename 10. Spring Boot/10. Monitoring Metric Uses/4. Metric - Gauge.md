-----
### ë©”íŠ¸ë¦­ ë“±ë¡ 5 - ê²Œì´ì§€
-----
1. ğŸ’¡ ê²Œì´ì§€ (Gauge)
   - https://prometheus.io/docs/concepts/metric_types/#gauge
   - ğŸ’¡ ê²Œì´ì§€ëŠ” ì„ì˜ë¡œ ì˜¤ë¥´ë‚´ë¦´ ìˆ˜ ìˆëŠ” ë‹¨ì¼ ìˆ«ì ê°’ì„ ë‚˜íƒ€ë‚´ëŠ” ë©”íŠ¸ë¦­
   - ğŸ’¡ ê°’ì˜ í˜„ì¬ ìƒíƒœë¥¼ ë³´ëŠ” ë° ì‚¬ìš©
   - ğŸ’¡ ê°’ì´ ì¦ê°€í•˜ê±°ë‚˜ ê°ì†Œí•  ìˆ˜ ìˆìŒ
   - ì˜ˆ) ì°¨ëŸ‰ì˜ ì†ë„, CPU ì‚¬ìš©ëŸ‰, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

2. ğŸ’¡ ì°¸ê³  : ì¹´ìš´í„°ì™€ ê²Œì´ì§€ë¥¼ êµ¬ë¶„í•  ë•ŒëŠ” ê°’ì´ ê°ì†Œí•  ìˆ˜ ìˆëŠ”ê°€ë¥¼ ê³ ë¯¼í•˜ë©´ ë„ì›€ì´ ë¨
3. ì¬ê³  ìˆ˜ëŸ‰ì„ í†µí•´ ê²Œì´ì§€ë¥¼ ë“±ë¡í•˜ëŠ” ë°©ë²• (ê°€ì¥ ë‹¨ìˆœí•œ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì´ ë“±ë¡)
   - StockConfigV1
```java
package hello.order.gauge;

import hello.order.OrderService;
import io.micrometer.core.instrument.Gauge;
import io.micrometer.core.instrument.MeterRegistry;
import jakarta.annotation.PostConstruct;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Slf4j
@Configuration
public class StockConfigV1 {

    @Bean
    public MyStockMetric myStockMetric(OrderService orderService, MeterRegistry registry) {
        return new MyStockMetric(orderService, registry);
    }

    static class MyStockMetric {
        private OrderService orderService;
        private MeterRegistry registry;

        public MyStockMetric(OrderService orderService, MeterRegistry registry) {
            this.orderService = orderService;
            this.registry = registry;
        }

        @PostConstruct
        public void init() {
            Gauge.builder("my.stock", orderService, service -> { // ê²Œì´ì§€ ìƒì„± (orderService íŒŒë¼ë¯¸í„° -> Lambda ì´ìš©)
                log.info("stock gauge call");
                return service.getStock().get(); // OrderServiceì˜ í˜„ì¬ Stock ê°’ì„ êº¼ë‚´ì„œ ë°˜í™˜
            }).register(registry); // ë©”íŠ¸ë¦­ ë“±ë¡
        }
    }
}
```
  - ğŸ’¡ my.stock ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ê²Œì´ì§€ ë“±ë¡
  - ğŸ’¡ğŸ’¡ğŸ’¡ ê²Œì´ì§€ë¥¼ ë§Œë“¤ ë•Œ í•¨ìˆ˜ë¥¼ ì „ë‹¬ : ì´ í•¨ìˆ˜ëŠ” ì™¸ë¶€ì—ì„œ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ë•Œë§ˆë‹¤ í˜¸ì¶œ
  - ğŸ’¡ğŸ’¡ğŸ’¡ ì´ í•¨ìˆ˜ì˜ ë°˜í™˜ ê°’ì´ ê²Œì´ì§€ì˜ ê°’

4. ActuatorApplication ë³€ê²½
```java
package hello;

import hello.order.gauge.StockConfigV1;
import hello.order.v0.OrderConfigV0;
import hello.order.v1.OrderConfigV1;
import hello.order.v2.OrderConfigV2;
import hello.order.v3.OrderConfigV3;
import hello.order.v4.OrderConfigV4;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.actuate.web.exchanges.InMemoryHttpExchangeRepository;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;

// @Import(OrderConfigV0.class)
// @Import(OrderConfigV1.class)
// @Import(OrderConfigV2.class)
// @Import(OrderConfigV3.class)
@Import({OrderConfigV4.class, StockConfigV1.class})
@SpringBootApplication(scanBasePackages = "hello.controller")
public class ActuatorApplication {

    public static void main(String[] args) {
        SpringApplication.run(ActuatorApplication.class, args);
    }
}
```
  - ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ë©´ stock gauge call ë¡œê·¸ê°€ ì£¼ê¸°ì ìœ¼ë¡œ ë‚¨ëŠ” ê²ƒ í™•ì¸ ê°€ëŠ¥
  - ğŸ’¡ ê²Œì´ì§€ë¥¼ í™•ì¸í•˜ëŠ” í•¨ìˆ˜ëŠ” ì™¸ë¶€ì—ì„œ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ë•Œ í˜¸ì¶œ
  - ğŸ’¡ í˜„ì¬ í”„ë¡œë©”í…Œìš°ìŠ¤ê°€ ë‹¤ìŒ ê²½ë¡œë¥¼ í†µí•´ ì£¼ê¸°ì ìœ¼ë¡œ ë©”íŠ¸ë¦­ì„ í™•ì¸í•˜ê¸° ë•Œë¬¸
    + http://localhost:7070/actuator/prometheus
```
...

2024-09-18T20:22:13.899+09:00  INFO 9496 --- [nio-7070-exec-1] hello.order.gauge.StockConfigV1          : stock gauge call
2024-09-18T20:22:13.906+09:00  INFO 9496 --- [nio-7070-exec-2] hello.order.gauge.StockConfigV1          : stock gauge call
2024-09-18T20:22:13.915+09:00  INFO 9496 --- [nio-7070-exec-3] hello.order.gauge.StockConfigV1          : stock gauge call

...
```
  - ğŸ’¡ í”„ë¡œë©”í…Œìš°ìŠ¤ë¥¼ ì¢…ë£Œí•˜ë©´, í•´ë‹¹ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ” ê²ƒ í™•ì¸ ê°€ëŠ¥
  - ğŸ’¡ ë¬¼ë¡ , ë©”íŠ¸ë¦­ í™•ì¸ ê²½ë¡œë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ë©´ í•´ë‹¹ í•¨ìˆ˜ í˜¸ì¶œ
  - ğŸ’¡ ì¹´ìš´í„°ì™€ ë‹¤ë¥´ê²Œ ê²Œì´ì§€ëŠ” ë¬´ì–¸ê°€ë¥¼ ëˆ„ì í•  í•„ìš”ë„ ì—†ê³ , ë”± í˜„ì¬ ì‹œì ì˜ ê°’ì„ ë³´ì—¬ì£¼ê¸°ë§Œ í•˜ë©´ ë¨
  - ğŸ’¡ ë”°ë¼ì„œ, ì¸¡ì • ì‹œì ì— í˜„ì¬ ê°’ì„ ë°˜í™˜

5. ì•¡ì¸„ì—ì´í„° ë©”íŠ¸ë¦­ í™•ì¸ (http://localhost:7070/actuator/metrics/my.stock)
```json
{
    "name": "my.stock",
    "measurements": [
        {
            "statistic": "VALUE",
            "value": 100.0
        }
    ],
    "availableTags": []
}
```
  - ê²Œì´ì§€ëŠ” í˜„ì¬ ê°’ì„ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ë©´ ë˜ë¯€ë¡œ ë‹¨ìˆœ

6. í”„ë¡œë©”í…Œìš°ìŠ¤ í¬ë§· ë©”íŠ¸ë¦­ í™•ì¸ (http://localhost:7070/actuator/prometheus)
```
# HELP my_stock  
# TYPE my_stock gauge
my_stock 100.0
```

7. ê·¸ë¼íŒŒë‚˜ ë“±ë¡ - ì¬ê³ 
   - íŒ¨ë„ ì˜µì…˜ - Title : ì¬ê³ 
   - PromQL : my_stock
<div align="center">
<img src="https://github.com/user-attachments/assets/7941f7cb-81fd-469b-9afb-9241bb8e32ad">
</div>

-----
### ê²Œì´ì§€ë¥¼ ë‹¨ìˆœí•˜ê²Œ ë“±ë¡í•˜ê¸°
-----
1. StockConfigV2
```java
package hello.order.gauge;

import hello.order.OrderService;
import io.micrometer.core.instrument.Gauge;
import io.micrometer.core.instrument.binder.MeterBinder;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Slf4j
@Configuration
public class StockConfigV2 {

    @Bean
    public MeterBinder stockSize(OrderService orderService) {
        return registry -> Gauge.builder("my.stock", orderService, service -> {
            log.info("stock gauge call");
            return orderService.getStock().get();
        }).register(registry);
    }
}
```
  - ğŸ’¡ MeterBinder íƒ€ì…ì„ ë°”ë¡œ ë°˜í™˜í•´ë„ ë¨

2. ActuatorApplication ë³€ê²½
```java
package hello;

import hello.order.gauge.StockConfigV1;
import hello.order.gauge.StockConfigV2;
import hello.order.v0.OrderConfigV0;
import hello.order.v1.OrderConfigV1;
import hello.order.v2.OrderConfigV2;
import hello.order.v3.OrderConfigV3;
import hello.order.v4.OrderConfigV4;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.actuate.web.exchanges.InMemoryHttpExchangeRepository;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;

// @Import(OrderConfigV0.class)
// @Import(OrderConfigV1.class)
// @Import(OrderConfigV2.class)
// @Import(OrderConfigV3.class)
// @Import({OrderConfigV4.class, StockConfigV1.class})
@Import({OrderConfigV4.class, StockConfigV2.class})
@SpringBootApplication(scanBasePackages = "hello.controller")
public class ActuatorApplication {

    public static void main(String[] args) {
        SpringApplication.run(ActuatorApplication.class, args);
    }

    @Bean
    public InMemoryHttpExchangeRepository httpExchangeRepository() {
        return new InMemoryHttpExchangeRepository();
    }
}
```
  - @Import({OrderConfigV4.class, StockConfigV1.class})ì—ì„œ @Import({OrderConfigV4.class, StockConfigV2.class})ìœ¼ë¡œ ë³€ê²½
