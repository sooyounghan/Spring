-----
### ë©”íŠ¸ë¦­ ë“±ë¡ 1 - ì¹´ìš´í„°
-----
1. ë§ˆì´í¬ë¡œë¯¸í„°ë¥¼ ì‚¬ìš©í•´ ë©”íŠ¸ë¦­ì„ ì§ì ‘ ë“±ë¡í•˜ëŠ” ë°©ë²•
2. ë¨¼ì € ì£¼ë¬¸ìˆ˜, ìµœì†Œìˆ˜ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¹´ìš´í„° ë©”íŠ¸ë¦­ ë“±ë¡
3. ğŸ’¡ MeterRegistry
   - ë§ˆì´í¬ë¡œë¯¸í„° ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” í•µì‹¬ ì»´í¬ë„ŒíŠ¸
   - ìŠ¤í”„ë§ì„ í†µí•´ì„œ ì£¼ì… ë°›ì•„ì„œ ì‚¬ìš©í•˜ê³ , ì´ê³³ì„ í†µí•´ì„œ ì¹´ìš´í„°, ê²Œì´ì§€ ë“± ë“±ë¡

4. ğŸ’¡ ì¹´ìš´í„°(Counter)
   - https://prometheus.io/docs/concepts/metric_types/#counter
   - ë‹¨ì¡°ë¡­ê²Œ ì¦ê°€í•˜ëŠ” ë‹¨ì¼ ëˆ„ì  ì¸¡ì • í•­ëª©
     + ë‹¨ì¼ ê°’
     + ë³´í†µ í•˜ë‚˜ì”© ì¦ê°€
     + ëˆ„ì ì´ë¯€ë¡œ ì „ì²´ ê°’ í¬í•¨ (total)
     + í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì¹´ìš´í„° ì´ë¦„ ë§ˆì§€ë§‰ì— _totalì„ ë¶™ì—¬ my_order_totalê³¼ ê°™ì´ í‘œí˜„
   - ê°’ì„ ì¦ê°€í•˜ê±°ë‚˜ 0ìœ¼ë¡œ ì´ˆê¸°í™”(ì„œë²„ shutdownì˜ ê²½ìš° ì´ˆê¸°í™”)í•˜ëŠ” ê²ƒë§Œ ê°€ëŠ¥
   - ë§ˆì´í¬ë¡œë¯¸í„°ì—ì„œëŠ” ê°’ì„ ê°ì†Œí•˜ëŠ” ê¸°ëŠ¥ë„ ì§€ì›í•˜ì§€ë§Œ, ëª©ì ì— ë§ì§€ ì•ŠìŒ
   - ì˜ˆ) HTTP ìš”ì²­ ìˆ˜
   - ì£¼ë¬¸ìˆ˜, ì·¨ì†Œìˆ˜ ì„œë¹„ìŠ¤ì— ì¹´ìš´í„° ë©”íŠ¸ë¦­ ì ìš© : OrderServiceV1
```java
package hello.order.v1;

import hello.order.OrderService;
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import lombok.extern.slf4j.Slf4j;

import java.util.concurrent.atomic.AtomicInteger;

@Slf4j
public class OrderServiceV1 implements OrderService {
    
    private final MeterRegistry registry;
    private AtomicInteger stock = new AtomicInteger(100);

    public OrderServiceV1(MeterRegistry registry) {
        this.registry = registry;
    }

    /**
     * my.order ë©”íŠ¸ë¦­ : ì£¼ë¬¸ ìˆ˜(ordr) + ì·¨ì†Œ ìˆ˜(cancel) ê°™ì´ ì¡´ì¬
     * - íƒœê·¸ë¥¼ í†µí•´ orderë©´, í•´ë‹¹ ì¹´ìš´í„° ê°’ (ì£¼ë¬¸ ìˆ˜) ì¦ê°€
     * - íƒœê·¸ë¥¼ í†µí•´ cancelì´ë©´, í•´ë‹¹ ì¹´ìš´í„° ê°’ (ì·¨ì†Œ ìˆ˜) ì¦ê°€
     * - ê²°ê³¼ì ìœ¼ë¡œ, ì£¼ë¬¸ ìˆ˜ì™€ ì·¨ì†Œ ìˆ˜ë¥¼ íƒœê·¸ ì—†ì´ ì „ì²´ my.orderë¡œ ì¡°íšŒí•˜ë©´ ì£¼ë¬¸ ìˆ˜ + ì·¨ì†Œ ìˆ˜ = ì „ì²´ ë¬¼ëŸ‰
     * - tag í•„í„°ë¥¼ í†µí•´ ì¡°íšŒí•˜ë©´ ê° ì£¼ë¬¸ ìˆ˜ì™€ ì·¨ì†Œ ìˆ˜
     */
    @Override
    public void order() {
        log.info("ì£¼ë¬¸");
        stock.decrementAndGet();

        Counter counter = Counter.builder("my.order") // ë©”íŠ¸ë¦­ ì´ë¦„
                .tag("class", this.getClass().getName()) // í´ë˜ìŠ¤ ì´ë¦„ì„ tagë¡œ ë„£ìŒ
                .tag("method", "order") // ë©”ì„œë“œ ì´ë¦„ì„ tagë¡œ ë„£ìŒ
                .description("order") // ì„¤ëª…
                .register(registry);
        
        counter.increment(); // í•´ë‹¹ ë©”íŠ¸ë¦­ ê°’ 1 ì¦ê°€
    }

    @Override
    public void cancel() {
        log.info("ì·¨ì†Œ");
        stock.incrementAndGet();
        
        Counter.builder("my.order") // tagë¡œ êµ¬ë¶„ ê°€ëŠ¥í•˜ë¯€ë¡œ ë©”íŠ¸ë¦­ì€ ë™ì¼í•˜ê²Œ ì„¤ì • ê°€ëŠ¥
                .tag("class", this.getClass().getName())
                .tag("method", "cancel")
                .description("cancel")
                .register(registry)
                .increment(); // ë©”ì„œë“œ ì²´ì´ë‹ ê°€ëŠ¥
    }

    @Override
    public AtomicInteger getStock() {
        return stock;
    }
}
```
  - my.order ë©”íŠ¸ë¦­ : ì£¼ë¬¸ ìˆ˜(ordr) + ì·¨ì†Œ ìˆ˜(cancel) ê°™ì´ ì¡´ì¬
    + íƒœê·¸ë¥¼ í†µí•´ orderë©´, í•´ë‹¹ ì¹´ìš´í„° ê°’ (ì£¼ë¬¸ ìˆ˜) ì¦ê°€
    + íƒœê·¸ë¥¼ í†µí•´ cancelì´ë©´, í•´ë‹¹ ì¹´ìš´í„° ê°’ (ì·¨ì†Œ ìˆ˜) ì¦ê°€
    + ê²°ê³¼ì ìœ¼ë¡œ, ì£¼ë¬¸ ìˆ˜ì™€ ì·¨ì†Œ ìˆ˜ë¥¼ íƒœê·¸ ì—†ì´ ì „ì²´ my.orderë¡œ ì¡°íšŒí•˜ë©´ ì£¼ë¬¸ ìˆ˜ + ì·¨ì†Œ ìˆ˜ = ì „ì²´ ë¬¼ëŸ‰
    + tag í•„í„°ë¥¼ í†µí•´ ì¡°íšŒí•˜ë©´ ê° ì£¼ë¬¸ ìˆ˜ì™€ ì·¨ì†Œ ìˆ˜


  - Counter.builder(name) : ì¹´ìš´í„° ìƒì„± (nameì—ëŠ” ë©”íŠ¸ë¦­ ì´ë¦„ ì§€ì •)
  - tag ì‚¬ìš© : í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œ í•„í„°ë§í•  ìˆ˜ ìˆëŠ” ë ˆì´ë¸”ë¡œ ì‚¬ìš©
  - ì£¼ë¬¸ê³¼ ì·¨ì†ŒëŠ” ë©”íŠ¸ë¦­ ì´ë¦„ì€ ê°™ê³ , tagë¥¼ í†µí•´ êµ¬ë¶„
  - registry(registry) : ë§Œë“  ì¹´ìš´í„°ë¥¼ MeterRegistryì— ë“±ë¡í•¨ìœ¼ë¡œ, ì‹¤ì œ ë™ì‘
  - increment(): ì¹´ìš´í„°ì˜ ê°’ì„ í•˜ë‚˜ ì¦ê°€
  - ì¦‰, ê° ë©”ì„œë“œë¥¼ í•˜ë‚˜ í˜¸ì¶œí•  ë•Œ ë§ˆë‹¤ ì¹´ìš´í„° ì¦ê°€

  - OrderConfigV1
```java
package hello.order.v1;

import hello.order.OrderService;
import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OrderConfigV1 {

    @Bean
    public OrderService orderService(MeterRegistry registry) {
        return new OrderServiceV1(registry);
    }
}
```

  - ActuatorApplication - ìˆ˜ì •
```java
package hello;

import hello.order.v0.OrderConfigV0;
import hello.order.v1.OrderConfigV1;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.actuate.web.exchanges.InMemoryHttpExchangeRepository;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;

// @Import(OrderConfigV0.class)
@Import(OrderConfigV1.class)
@SpringBootApplication(scanBasePackages = "hello.controller")
public class ActuatorApplication {

    public static void main(String[] args) {
        SpringApplication.run(ActuatorApplication.class, args);
    }
}
```
  - OrderConfigV0ì—ì„œ OrderConfigV1ì´ ì„¤ì •ë˜ë„ë¡ ë³€ê²½

  - ì£¼ë¬¸ê³¼ ì·¨ì†Œë¥¼ ê° í•œ ë²ˆ ì‹¤í–‰í•œ ë‹¤ìŒ ë©”íŠ¸ë¦­ í™•ì¸ (ê°ê° ì‹¤í–‰í•´ì•¼ ë©”íŠ¸ë¦­ì´ ë“±ë¡)
  - ì•¡ì¸„ì—ì´í„° ë©”íŠ¸ë¦­ í™•ì¸ (http://localhost:7070/actuator/metrics/my.order)
```json
{
    "name": "my.order",
    "description": "cancel",
    "measurements": [
        {
            "statistic": "COUNT",
            "value": 2.0
        }
    ],
    "availableTags": [
        {
            "tag": "method",
            "values": [
                "cancel",
                "order"
            ]
        },
        {
            "tag": "class",
            "values": [
                "hello.order.v1.OrderServiceV1"
            ]
        }
    ]
}
```
  - ë©”íŠ¸ë¦­ì„ í™•ì¸í•´ë³´ë©´ methodë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆìŒ

5. í”„ë¡œë©”í…Œìš°ìŠ¤ í¬ë§· ë©”íŠ¸ë¦­ í™•ì¸ (http://localhost:7070/actuator/prometheus)
```
# HELP my_order_total order
# TYPE my_order_total counter
my_order_total{class="hello.order.v1.OrderServiceV1",method="order",} 1.0
my_order_total{class="hello.order.v1.OrderServiceV1",method="cancel",} 1.0
```
  - ë©”íŠ¸ë¦­ ì´ë¦„ì´ my.orderì—ì„œ my_order_totalë¡œ ë³€ê²½ë¨
    + í”„ë¡œë©”í…Œìš°ìŠ¤ëŠ” .ì„ _ë¡œ ë³€ê²½
    + ì¹´ìš´í„°ëŠ” ë§ˆì§€ë§‰ì— _totalì„ ë¶™ì´ë©°, í”„ë¡œë©”í…Œìš°ìŠ¤ëŠ” ê´€ë¡€ìƒ ì¹´ìš´í„° ì´ë¦„ì˜ ëì— _totalì„ ë¶™ì„
    + methodë¼ëŠ” tag(ë ˆì´ë¸”)ì„ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„°ê°€ ë¶„ë¥˜

  6. ê·¸ë¼íŒŒë‚˜ ë“±ë¡ - ì£¼ë¬¸ìˆ˜, ì·¨ì†Œìˆ˜
     - hello-dashboardì— ì£¼ë¬¸ìˆ˜, ì·¨ì†Œìˆ˜ ê·¸ë˜í”„ ì¶”ê°€
     - Paenl Options : Title : ì£¼ë¬¸ìˆ˜
     - PromQL
       + increase(my_order_total{method="order"}[1m]) / Legend : {{method}} = order
       + increase(my_order_total{method="cancel"}[1m]) / Legend : {{method}} = cancel
     
<div align="center">
<img src="https://github.com/user-attachments/assets/47fd0194-10eb-4c23-b61e-65fdd4b6d294">
</div>

   - ì°¸ê³  : ì¹´ìš´í„°ëŠ” ê³„ì† ì¦ê°€í•˜ë¯€ë¡œ íŠ¹ì • ì‹œê°„ ë‚´ ì–¼ë§ˆë‚˜ ì¦ê°€í–ˆëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ increase(), rate() ê°™ì€ í•¨ìˆ˜ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ

<div align="center">
<img src="https://github.com/user-attachments/assets/8c12077d-8809-4c6b-8005-d761a284a006">
</div>

-----
### ë©”íŠ¸ë¦­ ë“±ë¡ 2 - @Counted
-----
1. OrderServiceV1ì˜ ê°€ì¥ í° ë‹¨ì ì€ ë©”íŠ¸ë¦­ì„ ê´€ë¦¬í•˜ëŠ” ë¡œì§ì´ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ê°œë°œ ë¡œì§ì— ì¹¨íˆ¬
2. ì´ëŸ° ë¶€ë¶„ì„ í•´ê²°í•˜ë ¤ë©´ ìŠ¤í”„ë§ AOP í™œìš©
   - ì§ì ‘ í•„ìš”í•œ AOPë¥¼ ë§Œë“¤ì–´ì„œ ì ìš©í•´ë„ ë˜ì§€ë§Œ, ë§ˆì´í¬ë¡œë¯¸í„°ëŠ” ì´ëŸ° ìƒí™©ì— ë§ì¶”ì–´ í•„ìš”í•œ AOP êµ¬ì„± ìš”ì†Œë¥¼ ë‹¤ ë§Œë“¤ì–´ë‘ 
3. OrderServiceV2
```java
package hello.order.v2;

import hello.order.OrderService;
import io.micrometer.core.annotation.Counted;
import io.micrometer.core.instrument.Counter;
import lombok.extern.slf4j.Slf4j;

import java.util.concurrent.atomic.AtomicInteger;

@Slf4j
public class OrderServiceV2 implements OrderService {

    private AtomicInteger stock = new AtomicInteger(100);

    @Counted("my.order")
    @Override
    public void order() {
        log.info("ì£¼ë¬¸");
        stock.decrementAndGet();

    }

    @Counted("my.order")
    @Override
    public void cancel() {
        log.info("ì·¨ì†Œ");
        stock.incrementAndGet();

    }

    @Override
    public AtomicInteger getStock() {
        return stock;
    }
}
```
  - @Counted ì• ë„ˆí…Œì´ì…˜ : ì¸¡ì •ì„ ì›í•˜ëŠ” ë©”ì„œë“œì— ì ìš© (ì£¼ë¬¸ê³¼ ì·¨ì†Œ ë©”ì„œë“œì— ì ìš©)
  - ê·¸ë¦¬ê³  ë©”ì„œë“œ ì´ë¦„ì„ ì§€ì •í•˜ë©´ ë¨. ì—¬ê¸°ì„œëŠ” ì´ì „ê³¼ ê°™ì€ my.order ì ìš©
  - ì´ë ‡ê²Œ ì‚¬ìš©í•˜ë©´ tagì— methodë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜í•´ì„œ ì ìš©

4. OrderConfigV2
```java
package hello.order.v2;

import hello.order.OrderService;
import io.micrometer.core.aop.CountedAspect;
import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OrderConfigV2 {

    @Bean
    public OrderService orderService() {
        return new OrderServiceV2();
    }

    @Bean
    public CountedAspect countedAspect(MeterRegistry meterRegistry) {
        return new CountedAspect(meterRegistry);
    }
}
```
  - ğŸ’¡ CountedAspectë¥¼ ë“±ë¡í•˜ë©´ @Countedë¥¼ ì¸ì§€í•´ì„œ Counterë¥¼ ì‚¬ìš©í•˜ëŠ” AOPë¥¼ ì ìš©
  - ğŸ’¡ ì£¼ì˜ : CountedAspectë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ì§€ ì•Šìœ¼ë©´ @Counted ê´€ë ¨ AOPê°€ ë™ì‘í•˜ì§€ ì•ŠìŒ

5. ActuatorApplication ë³€ê²½
```java
package hello;

import hello.order.v0.OrderConfigV0;
import hello.order.v1.OrderConfigV1;
import hello.order.v2.OrderConfigV2;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.actuate.web.exchanges.InMemoryHttpExchangeRepository;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;

// @Import(OrderConfigV0.class)
// @Import(OrderConfigV1.class)
@Import(OrderConfigV2.class)
@SpringBootApplication(scanBasePackages = "hello.controller")
public class ActuatorApplication {

    public static void main(String[] args) {
        SpringApplication.run(ActuatorApplication.class, args);
    }
}
```
  - OrderConfigV1ì—ì„œ OrderConfigV2ì´ ì‹¤í–‰ë˜ë„ë¡ ë³€ê²½ (order, cancel ì‹¤í–‰)
  - ì•¡ì¸„ì—ì´í„° ë©”íŠ¸ë¦­ í™•ì¸ (http://localhost:7070/actuator/metrics/my.order)
```json
{
    "name": "my.order",
    "measurements": [
        {
            "statistic": "COUNT",
            "value": 2.0
        }
    ],
    "availableTags": [
        {
            "tag": "result",
            "values": [
                "success"
            ]
        },
        {
            "tag": "exception",
            "values": [
                "none"
            ]
        },
        {
            "tag": "method",
            "values": [
                "cancel",
                "order"
            ]
        },
        {
            "tag": "class",
            "values": [
                "hello.order.v2.OrderServiceV2"
            ]
        }
    ]
}
```
  - @Countedë¥¼ ì‚¬ìš©í•˜ë©´ result, exception, method, class ê°™ì€ ë‹¤ì–‘í•œ tag ìë™ ì ìš©
  - í”„ë¡œë©”í…Œìš°ìŠ¤ í¬ë§· ë©”íŠ¸ë¦­ í™•ì¸ (http://localhost:7070/actuator/prometheus)
```
# HELP my_order_total  
# TYPE my_order_total counter
my_order_total{class="hello.order.v2.OrderServiceV2",exception="none",method="order",result="success",} 1.0
my_order_total{class="hello.order.v2.OrderServiceV2",exception="none",method="cancel",result="success",} 1.0
```
  - ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œ í™•ì¸ : ë©”íŠ¸ë¦­ ì´ë¦„ê³¼ tagê°€ ê¸°ì¡´ê³¼ ê°™ìœ¼ë¯€ë¡œ ê°™ì€ ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸ ê°€ëŠ¥
